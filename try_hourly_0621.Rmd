---
title: "donor_daily_traffic"
output: html_document
date: "2025-05-10"
---
#======
#Functions


```{r}
# 3. Read and bind them row-wise
library(readr)   # read_csv()
library(purrr)   # map_dfr()
library(dplyr)
library(readxl)
library(vroom)

#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 0. í•œê¸€ í°íŠ¸ Â· ê¸°ë³¸ í…Œë§ˆ  ---------------------------------------------------
#â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(showtext)
library(ggplot2)

font_add(family = "main", regular = "/System/Library/Fonts/AppleGothic.ttf")
showtext_auto()
theme_set(theme_minimal(base_family = "main"))

```
#==================
#Import


```{r}
library(readr)
library(purrr)
library(dplyr)

# 1ï¸âƒ£ CSV í´ë” ê²½ë¡œ
data_dir <- "/Users/maeg/Downloads/Downloads"

# 2ï¸âƒ£ íŒŒì¼ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
csv_files <- list.files(data_dir, pattern = "\\.csv$", full.names = TRUE)

# 3ï¸âƒ£ ì•ˆì „í•œ ì½ê¸° í•¨ìˆ˜: UTF-8 â†’ ì‹¤íŒ¨ ì‹œ CP949
safe_read_csv <- function(file_path) {
  tryCatch({
    read_csv(
      file = file_path,
      locale = locale(encoding = "UTF-8"),
      col_types = cols(.default = "c"),
      progress = FALSE
    )
  }, error = function(e1) {
    message("âš ï¸ UTF-8 ì‹¤íŒ¨: ", basename(file_path), " â†’ CP949 ì¬ì‹œë„")
    tryCatch({
      read_csv(
        file = file_path,
        locale = locale(encoding = "CP949"),
        col_types = cols(.default = "c"),
        progress = FALSE
      )
    }, error = function(e2) {
      message("âŒ CP949ë„ ì‹¤íŒ¨: ", basename(file_path))
      return(NULL)
    })
  })
}

# 4ï¸âƒ£ íŒŒì¼ì„ 25ê°œì”© ë‚˜ëˆ„ê¸°
batch_size <- 25
batches <- split(csv_files, ceiling(seq_along(csv_files) / batch_size))

# 5ï¸âƒ£ ê²°ê³¼ ì €ì¥ ë¦¬ìŠ¤íŠ¸
all_data <- vector("list", length(batches))

# 6ï¸âƒ£ ë°°ì¹˜ë³„ ë°˜ë³µ ì²˜ë¦¬
for (i in seq_along(batches)) {
  message("ğŸ”„ Reading batch ", i, " of ", length(batches))

  batch_data <- map_dfr(batches[[i]], safe_read_csv)

  message("âœ” Batch ", i, " ì™„ë£Œ: ", nrow(batch_data), " rows")

  all_data[[i]] <- batch_data
  rm(batch_data)
  gc()
}

# 7ï¸âƒ£ ì „ì²´ ë³‘í•©
donor_all_merged <- bind_rows(all_data)

#ë³‘í•©ëœ íŒŒì¼ì—ì„œ í•„ìš” ì—†ëŠ” ì—´, ë²„ìŠ¤ë„ë¡œ ë¹¼ê¸°

library(dplyr)

write.csv(donor_all_merged, "/Users/maeg/Downloads/Thesis_Materials/daily_all_neat/donor_all_merged.csv", row.names = FALSE, fileEncoding = "CP949")

donor_daily_raw <- donor_all_merged %>%
  # 1) COCT_CD != "2"ì¸ í–‰ë§Œ ë‚¨ê¸°ê¸°
  filter(COCT_CD != "2") %>%
  # 2) ë¶ˆí•„ìš”í•œ ì—´ ì œê±°
  dplyr::select(
    -PASNG_RUNTM_MINS,
    -PASNG_TM_CHANGE_CFFCN,
    -MAX_PASNG_TM_MINS,
    -MEDIAN_PASNG_TM_MINS,
    -MINM_PASNG_TM_MINS,
    -F15T85_PASNG_RUNTM_QNTL,
    -LAST_CHANGE_DAYHMINSEC,
    -NMLT_CSCNT,
    -REVISN_CSCNT,
    -PSTM_STDV,
    -END_ND_NM,
    -END_ND_GPS_LAT,
    -END_ND_GPS_LONG
  )

donor_daily_raw <- donor_daily_raw %>%
  dplyr::select(
    -COCT_CD
  )

#write.csv(donor_daily_raw, "daily_raw_donors.csv", fileEncoding = "UTF-8")


summary(donor_daily_raw)
summary(is.na(donor_daily_raw))
print(donor_daily_raw)
```


```{r}
library(readxl)
library(dplyr)


# 1ï¸âƒ£ ì½˜ì¡´ ê¸°ë³¸ì •ë³´ íŒŒì¼ ë¶ˆëŸ¬ì˜¤ê¸° (CP949 â†’ UTF-8 ìë™ ë³€í™˜)
donor_node_route_map <- read_csv(
  "/Users/maeg/Downloads/Thesis_Materials/ETC_conzone_20250426", 
  locale    = locale(encoding = "CP949"),          
  col_types = cols(.default = col_character())     
) %>%
  rename(
    CZN_CD    = `ì½˜ì¡´ID`,
    length    = `ì½˜ì¡´ê¸¸ì´`,
    direction = `ê¸°ì ì¢…ì ë°©í–¥êµ¬ë¶„ì½”ë“œ`,
    lanes     = `ì°¨ë¡œìˆ˜`,
    routeNum  = `ë…¸ì„ ë²ˆí˜¸`,
    limit_kmh = `ì œí•œì†ë„`,
    routeNM   = `ì½˜ì¡´ëª…`,
    bus       = `ë²„ìŠ¤ì „ìš©ì°¨ë¡œìœ ë¬´`,
    rank      = `ë„ë¡œë“±ê¸‰êµ¬ë¶„ì½”ë“œ`,
    order     = `ë…¸ì„ êµ¬ì„±ìˆœë²ˆ`,
    start_ID  = `ì‹œì‘ë…¸ë“œID`,
    end_ID    = `ì¢…ë£Œë…¸ë“œID`
  ) %>%
  mutate(
    CZN_CD = as.character(CZN_CD)
  ) %>%
  dplyr::select(-order, -start_ID, -end_ID)%>%
  print()

```

```{r}

# ì½˜ì¡´ê³¼ ë…¸ì„ ë²ˆí˜¸ ë§¤í•‘ (ë„ë¡œê³µì‚¬ ì œê³µ)
donor_org_roadName_map <- read_csv(
  "/Users/maeg/Downloads/Thesis_Materials/ETC_routes_20250505",
  locale    = locale(encoding = "CP949"),
  col_types = cols(.default = "c")
) %>% 
  rename(
    routeNum  = `ë…¸ì„ ë²ˆí˜¸`,
    ROAD_NAME = `ë„ë¡œëª…`
  )  %>%
  select(routeNum, ROAD_NAME) %>%
  print()

```


```{r}

info_map <- donor_node_route_map %>%
  left_join(donor_org_roadName_map, by = "routeNum") %>%
  print()


length(unique(info_map$CZN_CD)) #czn_cd 1667
```
## ë„ë¡œ ì „ì²´ ê¸¸ì´ ê³„ì‚°:
# row_data_length_by_routeNum

```{r}

### ê° ë„ë¡œ ì „ì²´ ê¸¸ì´

library(dplyr)

row_data_length_by_routeNum <- info_map %>%
  filter(direction == "E") %>%                          # ìƒí–‰ì„ ë§Œ
  mutate(length = as.numeric(length)) %>%               # lengthë¥¼ ìˆ«ìë¡œ ë³€í™˜
  group_by(routeNum) %>%
  summarise(total_length_km = (sum(length, na.rm = TRUE)/1000)) %>%
  arrange(desc(total_length_km)) %>%                       # ê¸¸ì´ìˆœ ì •ë ¬
  left_join(donor_org_roadName_map, by = "routeNum") %>%
print(row_data_length_by_routeNum)


```

#=
# info_map ì‚¬ìš©í•˜ì—¬ ì½˜ì¡´ì— linkid í• ë‹¹
#=

```{r}
library(readxl)
library(dplyr)


donor_node_conzone_linkid <- read_xls(
  "/Users/maeg/Downloads/Thesis_Materials/20250414_nodelink.xls",
  col_types = "text"  # ì „ ì—´ ë¬¸ìí˜•
) %>% 
  rename(
    CZN_CD  = `ì½˜ì¡´ID`,
    routeNM = `ì½˜ì¡´ëª…`,
    LINK_ID = `í‘œì¤€ë§í¬ID`
  ) %>%
  print()




```


#===
#info_map_with_linkidë¥¼ ì •ë³´ë§µìœ¼ë¡œ ì“°ê¸°

```{r}

info_map_with_linkid <- info_map %>%
  left_join(donor_node_conzone_linkid, by = c("CZN_CD", "routeNM")) %>%
  print()


#length(unique(info_map_with_linkid$CZN_CD)) #czn_cd 1667

#Which is na?

missing_link_or_czn <- info_map_with_linkid %>%
  filter(is.na(LINK_ID) | is.na(CZN_CD))

print(missing_link_or_czn)

#what's the median traffic values of na dataset?


# 1. NAê°€ ìˆëŠ” CZN_CD ëª©ë¡ ì¶”ì¶œ
missing_czn_list <- missing_link_or_czn %>%
  filter(!is.na(CZN_CD)) %>%
  pull(CZN_CD) %>%
  unique()

# 2. donor_traffic_rawì—ì„œ í•´ë‹¹ CZN_CDë§Œ í•„í„°ë§í•´ì„œ median ê³„ì‚°
median_traffic_by_czn <- donor_daily_raw %>%
  filter(CZN_CD %in% missing_czn_list) %>%
  mutate(TRFFCVLM = as.numeric(TRFFCVLM)) %>%
  group_by(CZN_CD) %>%
  summarise(median_traffic = median(TRFFCVLM, na.rm = TRUE)) %>%
  arrange(desc(median_traffic))


# 3. ê²°ê³¼ ë³´ê¸°
print(median_traffic_by_czn) ####Those Nas can be ignored when it comes to traffic volume.

### ì§€ì—­ ì •ë³´ í™•ì¸ì°¨ chatgpt ì œê³µìš©. 
missing_tbl <- missing_link_or_czn %>% dplyr::select(CZN_CD, routeNM, direction, ROAD_NAME)%>% dplyr::select(-direction)



```



```{r}
#missing_link_or_czn ì—ì„œ ì§€ì—­ ì—†ëŠ” ê³³ ì„ì˜ë¡œ í• ë‹¹í•˜ê¸°
library(tibble)   # tribble()

czn_region_map <- tribble(
  ~CZN_CD,        ~region_missing,
  # â”€â”€ ìƒí–‰ (CZE) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "0010CZE005",   "busan",
  "0010CZE165",   "gyeongbuk",
  "0010CZE205",   "gyeongbuk",
  "0010CZE405",   "gyeonggi",
  "0141CZE170",   "gyeongnam",
  "0141CZE180",   "gyeongnam",
  "0141CZE190",   "gyeongnam",
  "0150CZE005",   "jeonnam",
  "0150CZE055",   "jeonnam",
  "0150CZE265",   "gyeonggi",
  "0150CZE390",   "seoul",
  "0153CZE035",   "gyeonggi",
  "0170CZE075",   "gyeonggi",
  "0175CZE010",   "chungnam",
  "0175CZE020",   "chungnam",
  "0175CZE030",   "chungnam",
  "0175CZE040",   "chungnam",
  "0175CZE050",   "chungnam",
  "0175CZE060",   "chungnam",
  "0175CZE070",   "chungnam",
  "0175CZE080",   "gyeonggi",
  "0175CZE090",   "gyeonggi",
  "0251CZE185",   "jeonnam",
  "0270CZE130",   "jeonbuk",
  "0290CZE100",   "gyeonggi",
  "0290CZE110",   "seoul",
  "0290CZE120",   "gyeonggi",
  "0290CZE130",   "seoul",
  "0290CZE140",   "gyeonggi",
  "0290CZE150",   "gyeonggi",
  "0290CZE160",   "gyeonggi",
  "0290CZE170",   "gyeonggi",
  "0290CZE180",   "gyeonggi",
  "0290CZE190",   "gyeonggi",
  "0290CZE200",   "gyeonggi",
  "0300CZE175",   "gyeongbuk",
  "0301CZE035",   "chungnam",
  "0321CZE010",   "chungnam",
  "0321CZE020",   "chungnam",
  "0321CZE030",   "chungnam",
  "0352CZE285",   "chungbuk",
  "0400CZE075",   "gyeonggi",
  "0450CZE055",   "gyeongnam",
  "0500CZE005",   "incheon",
  "0500CZE145",   "gyeonggi",
  "0550CZE145",   "gyeongbuk",
  "0550CZE350",   "gangwon",
  "0600CZE065",   "gyeonggi",
  "1000CZE055",   "gyeonggi",
  "1040CZE015",   "gyeongnam",
  "1200CZE090",   "seoul",
  "1510CZE025",   "chungnam",
  "1730CZE010",   "gyeonggi",
  "1730CZE020",   "gyeonggi",
  "4002CZE030",   "gyeonggi",
  "4002CZE040",   "gyeonggi",
  "4002CZE050",   "gyeonggi",
  "4005CZE010",   "gyeonggi",
  "4005CZE020",   "gyeonggi",
  "4005CZE030",   "gyeonggi",
  "4006CZE010",   "gyeonggi",
  "4007CZE010",   "gyeonggi",
  "4007CZE020",   "gyeonggi",
  "4007CZE030",   "gyeonggi",
  "4007CZE040",   "gyeonggi",
  "4007CZE050",   "gyeonggi",
  "4007CZE060",   "gyeonggi",
  # â”€â”€ í•˜í–‰ (CZS) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  "0010CZS005",   "busan",
  "0010CZS165",   "gyeongbuk",
  "0010CZS205",   "gyeongbuk",
  "0010CZS405",   "gyeonggi",
  "0141CZS170",   "gyeongnam",
  "0141CZS180",   "gyeongnam",
  "0141CZS190",   "gyeongnam",
  "0150CZS005",   "jeonnam",
  "0150CZS055",   "jeonnam",
  "0150CZS265",   "gyeonggi",
  "0150CZS390",   "seoul",
  "0153CZS035",   "gyeonggi",
  "0170CZS075",   "gyeonggi",
  "0175CZS010",   "chungnam",
  "0175CZS020",   "chungnam",
  "0175CZS030",   "chungnam",
  "0175CZS040",   "chungnam",
  "0175CZS050",   "chungnam",
  "0175CZS060",   "chungnam",
  "0175CZS070",   "chungnam",
  "0175CZS080",   "gyeonggi",
  "0175CZS090",   "gyeonggi",
  "0200CZS050",   "daegu",
  "0251CZS185",   "jeonnam",
  "0270CZS130",   "jeonbuk",
  "0290CZS100",   "gyeonggi",
  "0290CZS110",   "seoul",
  "0290CZS120",   "gyeonggi",
  "0290CZS130",   "seoul",
  "0290CZS140",   "gyeonggi",
  "0290CZS150",   "gyeonggi",
  "0290CZS160",   "gyeonggi",
  "0290CZS170",   "gyeonggi",
  "0290CZS180",   "gyeonggi",
  "0290CZS190",   "gyeonggi",
  "0290CZS200",   "gyeonggi",
  "0301CZS035",   "chungnam",
  "0321CZS010",   "chungnam",
  "0321CZS020",   "chungnam",
  "0321CZS030",   "chungnam",
  "0352CZS285",   "chungbuk",
  "0400CZS075",   "gyeonggi",
  "0450CZS055",   "gyeongnam",
  "0500CZS005",   "incheon",
  "0500CZS145",   "gyeonggi",
  "0550CZS145",   "gyeongbuk",
  "0550CZS350",   "gangwon",
  "0552CZS085",   "daegu",
  "0600CZS065",   "gyeonggi",
  "1000CZS055",   "gyeonggi",
  "1040CZS015",   "gyeongnam",
  "1200CZS090",   "seoul",
  "1510CZS025",   "chungnam",
  "1730CZS010",   "gyeonggi",
  "1730CZS020",   "gyeonggi",
  "4002CZS030",   "gyeonggi",
  "4002CZS040",   "gyeonggi",
  "4002CZS050",   "gyeonggi",
  "4005CZS010",   "gyeonggi",
  "4005CZS020",   "gyeonggi",
  "4005CZS030",   "gyeonggi",
  "4006CZS010",   "gyeonggi",
  "4007CZS010",   "gyeonggi",
  "4007CZS020",   "gyeonggi",
  "4007CZS030",   "gyeonggi",
  "4007CZS040",   "gyeonggi",
  "4007CZS050",   "gyeonggi",
  "4007CZS060",   "gyeonggi",
  "0200CZE050", "daegu"
)


# í™•ì¸
print(czn_region_map, n = Inf)


missing_link_or_czn_with_region <- missing_link_or_czn %>%
  left_join(czn_region_map, by = "CZN_CD") %>%
  print()

```

```{r}

# 3ï¸âƒ£ ì§€ì—­ êµ¬ë¶„ìš© prefix ëª©ë¡
province_i <- 161:174
province_s <- 100:129
province_g <- 200:249
province_b <- 130:149
province_d <- 183:191

# 4ï¸âƒ£ LINK_ID ì• 3ìë¦¬ë¡œ region í• ë‹¹ í›„ NA ì•„ë‹Œ ê²ƒë§Œ í•„í„°
info_map_with_region <- info_map_with_linkid %>%
  mutate(
    prefix = as.integer(substr(LINK_ID, 1, 3)),
    region = case_when(
      prefix %in% province_i ~ "incheon",
      prefix %in% province_s ~ "seoul",
      prefix %in% province_g ~ "gyeonggi",
      prefix %in% province_b ~ "busan",
      prefix %in% province_d ~ "daejeon",
      
      TRUE                 ~ NA_character_
    )
  ) %>% dplyr::select(-prefix) %>%
  left_join(czn_region_map, by = "CZN_CD") %>%
  mutate(region = coalesce(region, region_missing)) %>%
  dplyr::select(- region_missing) %>%
  print()

info_map_with_region_filtered <- info_map_with_region %>%
  filter(region %in% c("incheon", "seoul", "gyeonggi", "busan", "daejeon"))

# 5ï¸âƒ£ ì§€ì—­ë³„ ê´€ì¸¡ í–‰ ìˆ˜ í™•ì¸
print( info_map_with_region_filtered %>% count(region) )

# 6ï¸âƒ£ ì „ì²´ ê³ ìœ  LINK_ID ê°œìˆ˜
cat("â–¶ Unique LINK_ID count:", n_distinct(info_map_with_region_filtered$LINK_ID), "\n")


# 6ï¸âƒ£ ì „ì²´ ê³ ìœ ì½˜ì¡´ ê°œìˆ˜
cat("â–¶ Unique CZN_CD count:", n_distinct(info_map_with_region_filtered$CZN_CD), "\n")
# 7ï¸âƒ£ ì§€ì—­ë³„ ê³ ìœ  ROAD_NAME ëª©ë¡ ë° ê°œìˆ˜
route_summary <- info_map_with_region_filtered %>%
  group_by(region) %>%
  summarise(
    n_routes = n_distinct(ROAD_NAME),
    routes   = paste(sort(unique(ROAD_NAME)), collapse = ", "),
    .groups  = "drop"
  )

print(route_summary)

# 8ï¸âƒ£ ëª¨ë“  ì§€ì—­ì˜ route ìˆ˜ í•©ê³„
cat("â–¶ Total routes across regions:", sum(route_summary$n_routes), "\n")

# 9ï¸âƒ£ ê²°ì¸¡ì¹˜ ìš”ì•½
print( summary(is.na(route_summary)) )


```

â–¶ Unique LINK_ID count: 2808 
â–¶ Unique CZN_CD count: 717 
â–¶ Total routes across regions: 60 
   region         n_routes         routes       
 Mode :logical   Mode :logical   Mode :logical  
 FALSE:5         FALSE:5         FALSE:5     


#Deviding Sunhwan road

```{r}
library(stringr)              # ë§¤ ì„¸ì…˜ë§ˆë‹¤ ë¡œë“œ
library(tidyr)
# 2) info_map_with_region_filteredì—ì„œ routeNM ë¶„ë¦¬ (ì›ë³¸ ë³´ì¡´)
devided_routes <- info_map_with_region_filtered %>%
  separate(routeNM, into = c("start_full", "end_full"), 
           sep = "-", remove = FALSE)

# 3) ì ‘ë¯¸ì‚¬ ì œê±°í•´ì„œ ê¸°ë³¸ ì´ë¦„ë§Œ
devided_routes <- devided_routes %>%
  mutate(
    start = str_remove(start_full, "(IC|JC|TG)$"),
    end   = str_remove(end_full,   "(IC|JC|TG)$")
  )

# 4) ì„¸ê·¸ë¨¼íŠ¸ë³„ ê¸°ì¤€ ë²¡í„°
#seg1 <- c("í‡´ê³„ì›","êµ¬ë¦¬","ë‚¨ì–‘ì£¼","í† í‰","ê°•ì¼","ìƒì¼","í•˜ë‚¨")
#seg2 <- c("í•˜ë‚¨","ì„œí•˜ë‚¨","ì†¡íŒŒ","ì„±ë‚¨","íŒêµ")
#seg3 <- c("íŒêµ","ì²­ê³„","í•™ì˜","í‰ì´Œ","ì‚°ë³¸","ì¡°ë‚¨","ë„ë¦¬","ì•ˆí˜„")
#seg4 <- c("ì•ˆí˜„","ì‹œí¥","ì¥ìˆ˜","ì†¡ë‚´","ì¤‘ë™","ì„œìš´","ê³„ì–‘","ë…¸ì˜¤ì§€","ê¹€í¬","ììœ ë¡œ")
#seg5 <- c("ììœ ë¡œ","ê³ ì–‘","ì¼ì‚°","í†µì¼ë¡œ","ì–‘ì£¼","ì†¡ì¶”","í˜¸ì›","ë³„ë‚´","ì˜ì •ë¶€","í‡´ê³„ì›")

#ì¼ì‚°~ì¤‘ë™~ì‹œí¥ êµ¬ê°„ (ë¶€ì²œê³ ê°€êµ êµ¬ê°„)
seg1 <- c("ì¼ì‚°", "ììœ ë¡œ", "ê¹€í¬", "ë…¸ì˜¤ì§€", "ê³„ì–‘", "ì„œìš´", "ì¤‘ë™", "ì†¡ë‚´", "ì¥ìˆ˜", "ì‹œí¥")
#ì‚°ë³¸~í‰ì´Œ~ì„±ë‚¨ êµ¬ê°„(ë‚¨ë¶€êµ¬ê°„)
seg2 <- c("ì‹œí¥", "ì•ˆí˜„", "ë„ë¦¬", "ì¡°ë‚¨", "ì‚°ë³¸", "í‰ì´Œ", "í•™ì˜", "ì²­ê³„", "íŒêµ", "ì„±ë‚¨")
seg3 <- c("ì„±ë‚¨", "ì†¡íŒŒ", "ì„œí•˜ë‚¨", "í•˜ë‚¨", "ìƒì¼", "ê°•ì¼", "í† í‰", "ë‚¨ì–‘ì£¼", "êµ¬ë¦¬", "í‡´ê³„ì›")
seg4 <- c("í‡´ê³„ì›","ë³„ë‚´","ì˜ì •ë¶€", "í˜¸ì›", "ì†¡ì¶”","ì–‘ì£¼", "í†µì¼ë¡œ", "ê³ ì–‘","ì¼ì‚°")

# 5) case_when ìœ¼ë¡œ ìˆœí™˜ì„ ë§Œ ë®ì–´ì“°ê¸°, ë‚˜ë¨¸ì§€ëŠ” ê·¸ëŒ€ë¡œ
sunhwan_all <- devided_routes %>%
  mutate(
    ROAD_NAME = case_when(
      # ì›ë˜ ìˆœí™˜ì„ ì´ë©´ì„œ start/end ë‘˜ ë‹¤ seg1
      ROAD_NAME == "ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ì„ " & start %in% seg1 & end %in% seg1 ~
        "ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_ì¼ì‚°-ì‹œí¥",
      ROAD_NAME == "ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ì„ " & start %in% seg2 & end %in% seg2 ~
        "ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_ì‹œí¥-ì„±ë‚¨",
      ROAD_NAME == "ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ì„ " & start %in% seg3 & end %in% seg3 ~
        "ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_ì„±ë‚¨-í‡´ê³„ì›",
      ROAD_NAME == "ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ì„ " & start %in% seg4 & end %in% seg4 ~
        "ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_í‡´ê³„ì›-ì¼ì‚°",
#      ROAD_NAME == "ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ì„ " & start %in% seg5 & end %in% seg5 ~
#        "ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_ììœ ë¡œ-í‡´ê³„ì›",
      # ì´ ì™¸ì˜ ëª¨ë“  í–‰ì€ ê¸°ì¡´ ì´ë¦„ ìœ ì§€
      TRUE ~ ROAD_NAME
    )
  ) %>%
  dplyr::select(-start_full, -end_full, -start, -end)

# 6) ê²°ê³¼ í™•ì¸: ìˆœí™˜ë¡œ êµ¬ê°„ë§Œ ë°”ë€Œê³ , ë‚˜ë¨¸ì§€ í–‰ë„ ê·¸ëŒ€ë¡œ ë‚¨ìŒ
glimpse(sunhwan_all)


###ìˆœí™˜ë„ë¡œ ì´ë¦„ë³€ê²½ ë‚´ìš©
library(dplyr)
library(stringr)

result_loop <- sunhwan_all %>%
  # â‘  ì´ë¦„ì´ â€˜ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_â€™ë¡œ ë°”ë€ ë„ë¡œë§Œ
  filter(str_detect(ROAD_NAME, "^ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_")) %>%
  distinct()  # ì¤‘ë³µ ì œê±°, í•„ìš” ì—†ìœ¼ë©´ ë¹¼ë„ ë©ë‹ˆë‹¤

# ê²°ê³¼ í™•ì¸
glimpse(result_loop)


```
length(unique(sunhwan_all$CZN_CD))
[1] 717


#===
# completed raw data: "donor_filtered_all"
#===


```{r}

# 1) ê¸°ì¤€ ë‚ ì§œ ë²”ìœ„ ì •ì˜
start_date <- as.Date("2023-01-01")
end_date   <- as.Date("2025-03-31")


df_hr08 <- donor_daily_raw %>%
  # (ê°€ì •: SUM_YRMTHDATì´ "YYYYMMDD" í˜•ì‹ì˜ ë¬¸ìì—´ì¼ ë•Œ)
  mutate(
    SUM_YRMTHDAT = as.Date(SUM_YRMTHDAT, format = "%Y%m%d")
  ) %>%
  filter(SUM_HR == "08")
```

```{r}

# 3) CZN_CDë³„ë¡œ ë‚ ì§œ ì‹œí€€ìŠ¤(2023-01-01 ~ 2025-03-31) ì±„ìš°ê¸°
df_hr08_complete <- df_hr08 %>%
  select(CZN_CD, SUM_YRMTHDAT, TRFFCVLM) %>%
  group_by(CZN_CD) %>%
  complete(
    SUM_YRMTHDAT = seq.Date(start_date, end_date, by = "day"),
    fill = list(TRFFCVLM = NA)
  ) %>%
  ungroup()
# â†’ tidyr::complete()ê°€ ê° CZN_CDë§ˆë‹¤ ì§€ì •í•œ ë‚ ì§œ ì‹œí€€ìŠ¤ë¥¼ ëª¨ë‘ ë§Œë“¤ê³ ,
#    ê¸°ì¡´ì— ì—†ë˜ ë‚ ì§œëŠ” TRFFCVLM=NAë¡œ ì±„ì›Œì¤ë‹ˆë‹¤  [oai_citation:0â€¡blog.exploratory.io](https://blog.exploratory.io/populating-missing-dates-with-complete-and-fill-functions-in-r-and-exploratory-79f2a321e6b5?utm_source=chatgpt.com).


```



```{r}
# 4) ì½˜ì¡´ë³„ ê²°ì¸¡ ë¹„ìœ¨ ê³„ì‚°
missing_rates <- df_hr08_complete %>%
  group_by(CZN_CD) %>%
  summarise(
    total_days   = n(),                          # í•˜ë£¨ í•˜ë‚˜ì”©, total = (end_dateâ€“start_date+1)
    missing_days = sum(is.na(TRFFCVLM)),         # TRFFCVLMì´ NAì¸ ë‚ 
    missing_rate = missing_days / total_days,    # ê²°ì¸¡ ë¹„ìœ¨
    .groups      = "drop"
  )
```

```{r}
library(dplyr)

# 1) missing_ratesì— result_loop ë„ë¡œ ì •ë³´ ë¶™ì´ê¸°
missing_with_info <- missing_rates %>%
  left_join(
    sunhwan_all %>%
      select(
        CZN_CD, length, direction, lanes, routeNum,
        limit_kmh, routeNM, bus, rank,
        ROAD_NAME, LINK_ID, region
      ),
    by = "CZN_CD"
  )

# 2) ì§€ì—­(region)Â·ë„ë¡œ(ROAD_NAME)ë³„ë¡œ ê²°ì¸¡ ë¹„ìœ¨ ìµœì € ì½˜ì¡´ ì„ íƒ
best_per_road_dir <- missing_with_info %>%
  group_by(region, ROAD_NAME, direction) %>%       # ë°©í–¥ ì¶”ê°€
  filter(missing_rate == min(missing_rate, na.rm = TRUE)) %>%
  slice_head(n = 1) %>%                            # ë™ë¥  ì‹œ ì²« ë²ˆì§¸
  ungroup()

# 3) ê²°ê³¼ ë³´ê¸°
best_per_road %>%
  select(
    region, ROAD_NAME, CZN_CD, length, direction, lanes,
    routeNum, limit_kmh, routeNM, bus, rank,
    LINK_ID, total_days, missing_days, missing_rate
  )
```


```{r}

library(dplyr)

final_selection_no_seoul <- best_per_road_dir %>%
  filter(missing_rate <= 0.15) %>%               # ê²°ì¸¡ 15% ì´í•˜
  group_by(region, ROAD_NAME) %>%
  filter(n_distinct(direction) == 2) %>%         # ì–‘ë°©í–¥ ëª¨ë‘ ìˆëŠ” ë„ë¡œ
  ungroup() %>%
  filter(region != "seoul")                      # ì„œìš¸ ì§€ì—­ ì œì™¸

# ê²°ê³¼ í™•ì¸
final_selection_no_seoul %>%
  select(
    region, ROAD_NAME, direction,
    CZN_CD, total_days, missing_days, missing_rate,
    length, lanes, routeNum, limit_kmh,
    routeNM, bus, rank, LINK_ID
  )
```


```{r}
library(dplyr)

# 1) final_selection_no_seoulì—ì„œ CZN_CDâ€“region ë§¤í•‘ë§Œ ë½‘ê¸°
sel_czn_region <- final_selection_no_seoul %>%
  select(CZN_CD, region, direction) %>%
  distinct()

```

```{r}
# 2) donor_daily_raw â†’ Date ë³€í™˜ í›„ í•„í„°ë§ & region/direction ê²°í•©
all_hours_selected <- donor_daily_raw %>%
  mutate(
    SUM_YRMTHDAT = as.Date(SUM_YRMTHDAT, "%Y%m%d")
  ) %>%
  filter(
    SUM_YRMTHDAT >= as.Date("2023-01-01"),
    SUM_YRMTHDAT <= as.Date("2025-03-31"),
    CZN_CD %in% sel_czn_region$CZN_CD
  ) %>%
  left_join(sel_czn_region, by = "CZN_CD")
```

```{r}
# 3) ì¤‘ë³µ ì œê±°, ìˆ«ì ë³€í™˜, -1Â·0 â†’ NA ì²˜ë¦¬
all_hours_clean <- all_hours_selected %>%
  distinct() %>%
  mutate(
    TRFFCVLM = as.numeric(TRFFCVLM),
    SPD_AVG  = as.numeric(SPD_AVG),
    TRFFCVLM = na_if(TRFFCVLM, -1),
    TRFFCVLM = na_if(TRFFCVLM,  0),
    SPD_AVG  = na_if(SPD_AVG,  -1),
    SPD_AVG  = na_if(SPD_AVG,   0)
  )

```

```{r}
# 4) ì½˜ì¡´ë³„ ìœ„ê²½ë„ í…Œì´ë¸” ì¶”ì¶œ í›„ 1:1 ë§¤í•‘
road_geo_one <- all_hours_clean %>%
  select(CZN_CD, ST_ND_GPS_LAT, ST_ND_GPS_LONG) %>%
  distinct() %>%
  group_by(CZN_CD) %>%
  slice_head(n = 1) %>%
  ungroup()
```

```{r}
# 5) sunhwan_allì—ì„œ ë„ë¡œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œí•˜ê³  GPS ê²°í•© â†’ road_info
road_info <- sunhwan_all %>%
  select(
    CZN_CD, length, direction, lanes, routeNum,
    limit_kmh, routeNM, bus, rank,
    ROAD_NAME,direction, LINK_ID, region
  ) %>%
  distinct() %>%
  left_join(road_geo_one, by = "CZN_CD")

# 6) all_hours_cleanì—ì„œ ìœ„ê²½ë„ ì»¬ëŸ¼ ì‚­ì œ
all_hours_selected_proc <- all_hours_clean %>%
  select(-ST_ND_GPS_LAT, -ST_ND_GPS_LONG)



```

```{r}
czn_to_name <- road_info %>%
  select(CZN_CD, ROAD_NAME) %>%
  distinct()
# distinct()ë¡œ ì¤‘ë³µëœ CZN_CD-ROAD_NAME ì¡°í•©ì€ í•˜ë‚˜ë§Œ ë‚¨ê¹ë‹ˆë‹¤  [oai_citation:0â€¡rdocumentation.org](https://www.rdocumentation.org/packages/dplyr/versions/0.7.8/topics/join?utm_source=chatgpt.com)
```


```{r}
all_hours_selected_proc2<- all_hours_selected_proc %>%
  left_join(czn_to_name, by = "CZN_CD") 
# ì´ì œ all_hours_selected_proc ì— ROAD_NAME ì»¬ëŸ¼ì´ ì¶”ê°€ë©ë‹ˆë‹¤  [oai_citation:1â€¡statology.org](https://www.statology.org/left-join-in-r/?utm_source=chatgpt.com) 
```


```{r}
raw_donor <- all_hours_selected_proc2 %>%
  rename(roadName = "ROAD_NAME",
         direction = "direction",
         day_start = "SUM_YRMTHDAT",
         hour = "SUM_HR",
         number = "CZN_CD",
         traffic = "TRFFCVLM",
         speed = "SPD_AVG") %>%
  select(-ST_ND_NM)

```

## ì „ ì‹œê°„ ë²„ì „ìœ¼ë¡œ ì €ì¥
```{r}
write.csv(raw_donor,"/Users/maeg/Downloads/Thesis_Materials/daily_all_neat/raw_donors.csv", row.names = FALSE, fileEncoding = "CP949")
```




#ì£¼ë³„ë°ì´í„°ë¡œ ì •ë¦¬ + ëŒ€ì „+ì¸ì²œ ### <<ëŒ€ì „ë°ì´í„° ê°€ì ¸ì˜¤ê¸°>>
#region_monthly_full_final
#===

```{r}

# ìŠ¤í¬ë¦½íŠ¸ ìƒë‹¨ì— ì¶”ê°€
library(lubridate)

daejeon <- read_csv(
  "/Users/maeg/Downloads/Thesis_Materials/daejeon/final_daejeon.csv",
  locale = locale(encoding = "CP949"),   # â† **í•µì‹¬!**
  show_col_types = FALSE
) %>% 
  mutate(
    SUM_YRMTHDAT     = ymd(Week_Start),
    region           = "daejeon",
    ROAD_NAME        = as.character(road),
    TRFFCVLM         = as.numeric(TRFFCVLM),
    SPD_AVG          = as.numeric(SPD_AVG)
  ) %>% 
  select(SUM_YRMTHDAT, region, ROAD_NAME, TRFFCVLM, SPD_AVG)

daejeon

```



```{r}

library(readr)
library(dplyr)
library(lubridate)  # ym() ì“°ì‹¤ ê²½ìš°


incheon1 <- read_csv(
  "/Users/maeg/Downloads/Thesis_Materials/incheon/weekly_full_incheon.csv",
  col_types = cols(
    ROAD_NAME    = col_character(),
    WEEK_START = col_date(format = "%Y-%m-%d"),  # ì´ë¯¸ "2022-11-01" í˜•íƒœì´ë¯€ë¡œ Date ë¡œ ë°”ë¡œ ì½ê¸°
    TRFFCVLM     = col_double(),
    SPD_AVG      = col_double()
  ),
  show_col_types = FALSE
) %>%
  rename(         SUM_YRMTHDAT = "WEEK_START") %>%
  # region ì»¬ëŸ¼ ëª¨ë‘ "incheon" ìœ¼ë¡œ ì¶”ê°€
  mutate(region = "incheon")


summary(is.na(incheon1))
```
#================================================
#!!!!!!!!!You should add daejeon when you finish preprocess the daejeon data!!!!
#===================================================
#ì„œìš¸ë¬¸ì‚°ì§€ì„  ì‚­ì œ

```{r}

# â”€â”€ 2) ì›”ë³„ ì§€ì—­ í‰ê·  êµí†µëŸ‰ ê³„ì‚° 


region_weekly_full <- bind_rows(donor_weekly, daejeon
                                 ) %>%
  arrange(region, SUM_YRMTHDAT)

region_weekly_full_final <- bind_rows(region_weekly_full, incheon1) %>%
  arrange(region, SUM_YRMTHDAT) %>%
  filter(!ROAD_NAME %in% "ì„œìš¸ë¬¸ì‚°ì§€ì„ ")
  


#region_monthly_full_final %>% 
#  mutate(
#    ST_ND_GPS_LONG = replace(
#      ST_ND_GPS_LONG,
#      ROAD_NAME == "ë¶€ì‚°ì™¸ê³½ì„ ",
#      129.005021
#    ),
#    ST_ND_GPS_LAT = replace(
#      ST_ND_GPS_LAT,
#      ROAD_NAME == "ë¶€ì‚°ì™¸ê³½ì„ ",
#      35.271283
#    )
#  )


print(region_weekly_full_final)

region_weekly_full_final %>%
  filter(
    region    == "gyeonggi",
    ROAD_NAME == "ê²½ë¶€ì„ ",
    SUM_YRMTHDAT == "2024-02-01"
  ) %>%
  print()


summary(is.na(region_weekly_full_final))


region_weekly_full_final %>%
     # â‘  ì´ë¦„ì´ â€˜ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_â€™ë¡œ ë°”ë€ ë„ë¡œë§Œ
     filter(str_detect(ROAD_NAME, "^ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_ì•ˆí˜„"))

region_weekly_full_final %>%
  filter(
    str_detect(ROAD_NAME, "^ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_ì‹œí¥")
  ) %>%
  print()

region_weekly_full_final %>% 
  filter(!complete.cases(.))          # â† NA ê°€ ìˆëŠ” í–‰ë§Œ ë°˜í™˜
```




#====
#Visualizing
#====
```{r}

library(dplyr)
library(ggplot2)
library(scales)   # comma()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë¶€ì‚° ë²„ì „
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
busan_only <- region_weekly_full_final %>%
  mutate(SUM_YRMTHDAT = as.Date(SUM_YRMTHDAT)) %>%
  filter(region == "busan") %>%
  filter(year(SUM_YRMTHDAT) == 2024)

# ê²°ì¸¡ì¹˜ ìš”ì•½
print(busan_only)
print(summary(is.na(busan_only)))

# ë°•ìŠ¤í”Œë¡¯ + ì¤‘ì•™ê°’ í…ìŠ¤íŠ¸
ggplot(busan_only, aes(x = ROAD_NAME, y = TRFFCVLM)) +
  geom_boxplot(outlier.colour = "red", outlier.size = 1.5) +
  stat_summary(
    fun     = median,
    geom    = "text",
    aes(label = comma(round(..y.., 1))),
    vjust   = -0.4,
    size    = 3
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "ë¶€ì‚° ì§€ì—­ ì¼ë³„ êµí†µëŸ‰(TRFFCVLM) ë¶„í¬ ë° ì¤‘ì•™ê°’",
    x     = "ë„ë¡œëª…",
    y     = "êµí†µëŸ‰ (ëŒ€/ì¼)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(size = 13, face = "bold")
  )

#=============================================================
# ëŒ€ì „ ë²„ì „
# =============================================================
daejeon_only <- region_weekly_full_final %>%
  mutate(SUM_YRMTHDAT = as.Date(SUM_YRMTHDAT)) %>%
  filter(region == "daejeon") %>%
  filter(year(SUM_YRMTHDAT) == 2024)

# ê²°ì¸¡ì¹˜ ìš”ì•½
print(daejeon_only)
print(summary(is.na(daejeon_only)))

# ë°•ìŠ¤í”Œë¡¯ + ì¤‘ì•™ê°’ í…ìŠ¤íŠ¸
ggplot(daejeon_only, aes(x = ROAD_NAME, y = TRFFCVLM)) +
  geom_boxplot(outlier.colour = "red", outlier.size = 1.5) +
  stat_summary(
    fun     = median,
    geom    = "text",
    aes(label = comma(round(..y.., 1))),
    vjust   = -0.4,
    size    = 3
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "ëŒ€ì „ ì§€ì—­ ì¼ë³„ êµí†µëŸ‰(TRFFCVLM) ë¶„í¬ ë° ì¤‘ì•™ê°’",
    x     = "ë„ë¡œëª…",
    y     = "êµí†µëŸ‰ (ëŒ€/ì¼)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(size = 13, face = "bold")
  )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê²½ê¸° ë²„ì „
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gyeonggi_only <- region_weekly_full_final %>%
  mutate(SUM_YRMTHDAT = as.Date(SUM_YRMTHDAT)) %>%
  filter(region == "gyeonggi") %>%
  filter(year(SUM_YRMTHDAT) == 2024)

# ê²°ì¸¡ì¹˜ ìš”ì•½
print(gyeonggi_only)
print(summary(is.na(gyeonggi_only)))

# ë°•ìŠ¤í”Œë¡¯ + ì¤‘ì•™ê°’ í…ìŠ¤íŠ¸
ggplot(gyeonggi_only, aes(x = ROAD_NAME, y = TRFFCVLM)) +
  geom_boxplot(outlier.colour = "red", outlier.size = 1.5) +
  stat_summary(
    fun     = median,
    geom    = "text",
    aes(label = comma(round(..y.., 1))),
    vjust   = -0.4,
    size    = 3
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "ê²½ê¸° ì§€ì—­ ì¼ë³„ êµí†µëŸ‰(TRFFCVLM) ë¶„í¬ ë° ì¤‘ì•™ê°’",
    x     = "ë„ë¡œëª…",
    y     = "êµí†µëŸ‰ (ëŒ€/ì¼)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(size = 13, face = "bold")
  )


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê²½ê¸° ë²„ì „
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
seoul_only <- region_weekly_full_final %>%
  mutate(SUM_YRMTHDAT = as.Date(SUM_YRMTHDAT)) %>%
  filter(region == "seoul") %>%
  filter(year(SUM_YRMTHDAT) == 2024)

# ê²°ì¸¡ì¹˜ ìš”ì•½
print(seoul_only)
print(summary(is.na(seoul_only)))

# ë°•ìŠ¤í”Œë¡¯ + ì¤‘ì•™ê°’ í…ìŠ¤íŠ¸
ggplot(seoul_only, aes(x = ROAD_NAME, y = TRFFCVLM)) +
  geom_boxplot(outlier.colour = "red", outlier.size = 1.5) +
  stat_summary(
    fun     = median,
    geom    = "text",
    aes(label = comma(round(..y.., 1))),
    vjust   = -0.4,
    size    = 3
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "ì„œìš¸ ì§€ì—­ ì¼ë³„ êµí†µëŸ‰(TRFFCVLM) ë¶„í¬ ë° ì¤‘ì•™ê°’",
    x     = "ë„ë¡œëª…",
    y     = "êµí†µëŸ‰ (ëŒ€/ì¼)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(size = 13, face = "bold")
  )

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì¸ì²œ ë²„ì „
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
incheon_only <-region_weekly_full_final %>%
  mutate(SUM_YRMTHDAT = as.Date(SUM_YRMTHDAT)) %>%
  filter(region == "incheon") %>%
  filter(year(SUM_YRMTHDAT) == 2024)

# ê²°ì¸¡ì¹˜ ìš”ì•½
print(incheon_only)
print(summary(is.na(incheon_only)))

# ë°•ìŠ¤í”Œë¡¯ + ì¤‘ì•™ê°’ í…ìŠ¤íŠ¸
ggplot(incheon_only, aes(x = ROAD_NAME, y = TRFFCVLM)) +
  geom_boxplot(outlier.colour = "red", outlier.size = 1.5) +
  stat_summary(
    fun     = median,
    geom    = "text",
    aes(label = comma(round(..y.., 1))),
    vjust   = -0.4,
    size    = 3
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "ì¸ì²œ ì§€ì—­ ì¼ë³„ êµí†µëŸ‰(TRFFCVLM) ë¶„í¬ ë° ì¤‘ì•™ê°’",
    x     = "ë„ë¡œëª…",
    y     = "êµí†µëŸ‰ (ëŒ€/ì¼)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(size = 13, face = "bold")
  )



```




#=============================
****donor pool ìµœì¢… ì •ë¦¬
---
ì „ì²´ ë‚ ìì— ëŒ€í•œ ì ìš©
---
#=============================


#ì›”ë³„ ì‹œê°í™”******************
#===

```{r}
library(ggplot2)
library(scales)


donor_no_outlier <- region_weekly_full_final %>%
  filter(!(region == "busan" & ROAD_NAME == "ê²½ë¶€ì„ " & TRFFCVLM > 300000))

# â”€â”€ 3) í”Œë¡¯ 1: ì›”ë³„ ì§€ì—­ í‰ê·  êµí†µëŸ‰
ggplot(donor_no_outlier, aes(x = SUM_YRMTHDAT, y = TRFFCVLM, color = region, grup = region)) +
  geom_line(size = 1) +
  scale_x_date(date_labels = "%Y-%m", date_breaks = "1 month") +
  scale_y_continuous(labels = comma) +
  labs(
    title = "ì›”ë³„ ì§€ì—­ í‰ê·  êµí†µëŸ‰",
    x     = "ì—°ì›”",
    y     = "í‰ê·  êµí†µëŸ‰ (ëŒ€/ì¼)",
    color = "ì§€ì—­"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold")
  )

# A) ì§€ì—­ë³„ ì›”í‰ê·  êµí†µëŸ‰ ë¶„í¬ + ì¤‘ì•™ê°’ í…ìŠ¤íŠ¸
ggplot(donor_no_outlier, aes(x = region, y = TRFFCVLM)) +
  geom_boxplot(outlier.colour = "red") +
  stat_summary(
    fun     = median,
    geom    = "text",
    aes(label = comma(round(..y.., 1))),
    vjust   = -0.5,
    size    = 3,
    color   = "blue"
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "ì§€ì—­ë³„ ì›”í‰ê·  êµí†µëŸ‰ ë¶„í¬",
    x     = "ì§€ì—­",
    y     = "ADT (ëŒ€/ì¼)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    plot.title  = element_text(face = "bold")
  )
```

```{r}
# B) ì§€ì—­ë³„Â·ë„ë¡œë³„ ì›”í‰ê·  êµí†µëŸ‰ ë¶„í¬ + ì¤‘ì•™ê°’ í…ìŠ¤íŠ¸ (facet)
library(dplyr)
library(ggplot2)
library(scales)

ggplot(donor_no_outlier, aes(x = ROAD_NAME, y = TRFFCVLM)) +
  geom_boxplot(outlier.colour = "red") +
  stat_summary(
    fun     = median,
    geom    = "text",
    aes(label = comma(round(..y..,0))),
    vjust   = -0.5,
    size    = 3,
    color   = "darkgreen"
  ) +
  facet_wrap(
    ~ region,
    scales = "free_x",   # â† ê° íŒ¨ì‹¯ì´ ìê¸° ë„ë¡œëª…ë§Œ xì¶•ì— í‘œì‹œ
    ncol   = 3
  ) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "ì§€ì—­ë³„Â·ë„ë¡œë³„ ì›”í‰ê·  êµí†µëŸ‰ ë¶„í¬",
    x     = "ë„ë¡œëª…",
    y     = "ADT (ëŒ€/ì¼)"
  ) +
  theme(
    axis.text.x       = element_text(angle = 45, hjust = 1, size = 7),
    strip.text        = element_text(face = "bold"),
    strip.background  = element_blank(),
    panel.spacing     = unit(1, "lines")
  )
```





```{r}
library(dplyr)
library(scales)  # comma()

# 1ï¸âƒ£ ADT ìˆ«ìí˜• ë³€í™˜ (í•„ìš” ì‹œ)
donorpool_adt <- region_weekly_full_final %>%
  mutate(traffic = as.numeric(TRFFCVLM))


# 1ï¸âƒ£ ìš”ì•½ í…Œì´ë¸” ìƒì„±
donor_region_road_summary <- donorpool_adt %>%
  group_by(region, ROAD_NAME) %>%
  summarise(
    n          = n(),                                  # ì´ í–‰ ìˆ˜
    missing_traffic    = sum(is.na(traffic)),
    missing_spd = sum(is.na(SPD_AVG)), # ê²°ì¸¡ì¹˜ ê°œìˆ˜
    median_ADT = median(traffic, na.rm = TRUE),           # ì¤‘ì•™ê°’
    mean_ADT   = mean(traffic, na.rm = TRUE),             # í‰ê· 
    .groups    = "drop"
  ) %>%
  arrange(region, ROAD_NAME)

# 2ï¸âƒ£ ê²°ê³¼ í™•ì¸
print(donor_region_road_summary)

# 3ï¸âƒ£ ì˜ˆì˜ê²Œ ì¶œë ¥ (knitr::kable)
if (requireNamespace("knitr", quietly=TRUE)) {
  knitr::kable(
    donor_region_road_summary,
    digits = c(0, 0, 0, 1, 1),
    format.args = list(big.mark = ","),
    caption = "ì§€ì—­ë³„Â·ë„ë¡œë³„ ADT ìš”ì•½"
  )
}
```



```{r}
library(ggplot2)
library(dplyr)
library(scales)   # comma()

donor_no_outlier <- region_weekly_full_final %>%
  filter(!(region == "busan" & ROAD_NAME == "ê²½ë¶€ì„ " & TRFFCVLM > 300000))


# 2ï¸âƒ£ í•œê¸€ í°íŠ¸ ì„¤ì • (í•œ ë²ˆë§Œ)
theme_set(theme_bw(base_family = "main"))

# 3ï¸âƒ£ ì§€ì—­ë³„Â·ë„ë¡œë³„ ë°•ìŠ¤í”Œë¡¯
ggplot(donor_no_outlier, aes(x = ROAD_NAME, y = TRFFCVLM)) +
  geom_boxplot(outlier.colour = "red", outlier.size = 1) +
  stat_summary(
    fun     = median,
    geom    = "text",
    aes(label = comma(round(..y.., 0))),
    vjust   = -0.5,
    size    = 2.5,
    color   = "blue"
  ) +
  facet_wrap(~ region, scales = "free_x", ncol = 2) +
  scale_y_continuous(labels = comma) +
  labs(
    title = "Distribution and median of daily traffic volume (TRFFCVLM) by region and road",
    x     = "Road name",
    y     = "Traffic volume (vehicles per day)"
  ) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, size = 8),
    strip.text  = element_text(face = "bold"),
    plot.title  = element_text(size = 14, face = "bold")
  )
```



#============================================
#ì„œìš¸ ë°ì´í„° ê°€ê³µ
#=============================================

#==========================
#ì„œìš¸ë°ì´í„° ì •ë¦¬
#==========================

```{r}
library(readxl)
library(dplyr)
library(stringr)
library(lubridate)
library(tidyr)
library(googledrive)


# ì‹œê°„ ì»¬ëŸ¼ ì´ë¦„ ì •ì˜ (hour00, hour01, ..., hour23)
hour_cols <- paste0("hour", sprintf("%02d", 0:23))

### 1. ì—‘ì…€ íŒŒì¼ ì½ê¸° ë° ë°ì´í„° ê²°í•©, ì „ì²˜ë¦¬
# ì—‘ì…€ íŒŒì¼ ê²½ë¡œ ì„¤ì •
file_paths <- list.files("/Users/maeg/Downloads/traffic_excel", full.names = TRUE)

# íŒŒì¼ë³„ ë°ì´í„°ë¥¼ ì €ì¥í•  ë¦¬ìŠ¤íŠ¸ ì´ˆê¸°í™”
data_list <- list()

for (file in file_paths) {
  # íŒŒì¼ëª… ì¶”ì¶œ (í•„ìš”ì‹œ ì‚¬ìš©)
  file_name <- basename(file)
  
  # ì‹œíŠ¸ 2ì˜ ë°ì´í„° ì½ê¸°
  dat <- read_excel(file, sheet = 2)
  
  # ëª¨ë“  ê°’ì´ NAì¸ ì—´ ì œê±°
  dat <- dat[, colSums(is.na(dat)) < nrow(dat)]
  
  # 'ì§€ì ë²ˆí˜¸' ì»¬ëŸ¼ì´ ìˆëŠ”ì§€ í™•ì¸ í›„, "F-"ê°€ í¬í•¨ëœ í–‰ë§Œ í•„í„°ë§
  if ("ì§€ì ë²ˆí˜¸" %in% names(dat)) {
    dat <- dat[grep("F-", dat$ì§€ì ë²ˆí˜¸), ]
  } else {
    warning(paste("íŒŒì¼", file_name, "ì— 'ì§€ì ë²ˆí˜¸' ì»¬ëŸ¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•´ë‹¹ íŒŒì¼ì€ ê±´ë„ˆëœë‹ˆë‹¤."))
    next
  }
  
  data_list[[length(data_list) + 1]] <- dat
}

# ë¦¬ìŠ¤íŠ¸ì˜ ë°ì´í„°ë¥¼ ê²°í•©
all_data <- bind_rows(data_list)

# ê²°í•© í›„, ëª¨ë“  ê°’ì´ NAì¸ ì—´ ì œê±°
all_data <- all_data[, colSums(is.na(all_data)) < nrow(all_data)]

# ë¶ˆí•„ìš”í•œ ì—´(ì˜ˆ: "ì›”", "ìš”ì¼(2)") ì œê±°
cols_to_remove <- c("ì›”","ìš”ì¼", "ìš”ì¼(2)")
all_data_seoul <- all_data %>% dplyr::select(-all_of(cols_to_remove))

# ì—´ ì´ë¦„ ë³€ê²½ (ì—¬ê¸°ì„œëŠ” day_start, Day, Road, Number, Direction, Path, ê·¸ë¦¬ê³  0~23)
colnames(all_data_seoul) <- c("day_start","roadName", "number", "direction", "path",
  "hour00", "hour01", "hour02", "hour03", "hour04", "hour05", "hour06", "hour07", "hour08", "hour09",
                        "hour10", "hour11", "hour12", "hour13", "hour14", "hour15", "hour16", "hour17", "hour18",
                      "hour19", "hour20", "hour21", "hour22", "hour23")

# ë„ë¡œ ì´ë¦„ ì˜ì–´ë¡œ ë³€ê²½
all_data_seoul <- all_data_seoul %>%
  mutate(roadName = case_when(
    roadName == "ì˜¬ë¦¼í”½ëŒ€ë¡œ" ~ "OlympicRoad",
    roadName == "ê°•ë³€ë¶ë¡œ" ~ "Gangbyeonbuk",
    roadName == "ë‚´ë¶€ìˆœí™˜ë¡œ" ~ "InnerCircle",
    roadName == "ë¶ë¶€ê°„ì„ ë¡œ" ~ "BukbuGanseon",
    roadName == "ë™ë¶€ê°„ì„ ë„ë¡œ" ~ "DongbuGanseon",
    roadName == "ê²½ë¶€ê³ ì†ë„ë¡œ" ~ "GyeongbuExpressway",
    roadName == "ë¶„ë‹¹ìˆ˜ì„œë¡œ" ~ "BundangSuseo",
    roadName == "ê°•ë‚¨ìˆœí™˜ë¡œ" ~ "GangnamLoop",
    roadName == "ì„œë¶€ê°„ì„ ë„ë¡œ" ~ "SeobuGanseon",
    roadName == "ì„œë¶€ê°„ì„ ì§€í•˜ë„ë¡œ" ~ "SeobuGanseon",
    roadName == "ì‹ ì›”ì—¬ì˜ì§€í•˜ë„ë¡œ" ~ "Sinwol",
    TRUE ~ roadName
  ))

# Direction ë³€ê²½: "ìœ ì…" -> 1, "ìœ ì¶œ" -> 0
all_data_seoul$direction[all_data_seoul$direction == "ìœ ì…"] <- 1
all_data_seoul$direction[all_data_seoul$direction == "ìœ ì¶œ"] <- 0


# Path ì—´ ì œê±°
all_data_seoul <- all_data_seoul %>% dplyr::select(-path)


# ìµœì¢… ë°ì´í„° ì €ì¥ (ì›í•œë‹¤ë©´)
write.csv(all_data_seoul, "/Users/maeg/Downloads/Thesis_Materials/raw_data/seoul/seoul_data.csv", row.names = FALSE)


# day_startë¥¼ ë‚ ì§œí˜•ìœ¼ë¡œ ë³€í™˜í•˜ê³  2021ë…„ ì´í›„ ë°ì´í„°ë§Œ í•„í„°ë§ í›„, ì£¼ì˜ ì‹œì‘ì¼(Week_Start) ê³„ì‚°
seoul_data_filtered_21to25 <- all_data_seoul %>% 
  mutate(day_start = ymd(as.numeric(day_start))) %>%
  filter(year(day_start) %in% c(2021:2025))


head(seoul_data_filtered_21to25)
```




#ì„œìš¸ ì˜ì—­ 2021~ 2025ë…„ ì›ë³¸ ë°ì´í„° ê°€ê³µí•˜ê¸°
#===============================================

```{r}

# ì›ë³¸ ë°ì´í„°ì— í–‰ ì¡´ì¬ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” indicator ì¶”ê°€ (ì¡´ì¬í•˜ë©´ TRUE)
start_date <- as.Date("2021-01-01")
end_date <- as.Date("2025-03-31")

# ì›ë³¸ ë°ì´í„°ì— í–‰ ì¡´ì¬ ì—¬ë¶€ë¥¼ ë‚˜íƒ€ë‚´ëŠ” indicator ì¶”ê°€ (ì¡´ì¬í•˜ë©´ TRUE)
seoul_data_with_indicator <- seoul_data_filtered_21to25 %>%
  mutate(original = TRUE)



###ê²°ì¸¡ì¹˜ ì±„ìš°ê¸°

seoul_data_complete <- seoul_data_with_indicator %>%
  group_by(roadName, number, direction) %>%
  complete(day_start = seq.Date(min(start_date), max(end_date), by = "day"),
           fill = list(original = FALSE)) %>%
  ungroup()

s.donor.raw <- seoul_data_complete


write.csv(seoul_data_complete, "/Users/maeg/Downloads/Thesis_Materials/seoul/seoul_traffic_raw.csv", row.names=FALSE)

# í•˜ë£¨ë³„ë¡œ NA ë˜ëŠ” 0ì¸ ì…€ì˜ ê°œìˆ˜ë¥¼ ê³„ì‚°
# (í•˜ë£¨ ì „ì²´ê°€ ëˆ„ë½ì´ë©´ missing_countëŠ” length(hour_cols), ì¦‰ 24ê°€ ë¨)
s.donor.raw_na <- s.donor.raw %>%
  mutate(missing_count = rowSums(across(all_of(hour_cols), ~ is.na(.) | . == 0)))

# ë…¸ë“œë§í¬ë³„ë¡œ 2ë…„ ë™ì•ˆì˜ ì´ ëˆ„ë½ê°’(ì…€ ë‹¨ìœ„)ê³¼ ì „ì²´ ê°€ëŠ¥í•œ ì…€ ìˆ˜, ê²°ì¸¡ì¹˜ ë¹„ìœ¨ ê³„ì‚°
node_missing_summary_seoul <- s.donor.raw_na %>%
  group_by(roadName, number, direction, day_start) %>%
  summarise(
    total_missing = sum(missing_count, na.rm = TRUE),              # 2ë…„ ë™ì•ˆ ëˆ„ë½ëœ ì…€ì˜ í•©
    total_missing_days = sum(if_else(missing_count == length(hour_cols), 1, 0)),  # í•˜ë£¨ ì „ì²´ê°€ ëˆ„ë½ëœ ë‚ ì˜ ê°œìˆ˜
    total_possible = n() * length(hour_cols),                        # 2ë…„ ë™ì•ˆì˜ ì „ì²´ ì…€ ìˆ˜ (ë‚ ì§œ ìˆ˜ * 24)
    missing_rate = total_missing / total_possible,                   # ì…€ ë‹¨ìœ„ ê²°ì¸¡ì¹˜ ë¹„ìœ¨
    .groups = "drop"
  )

print(node_missing_summary_seoul)

```

#ì„œìš¸ ê²°ì¸¡ì¹˜ í™•ì¸. 

```{r}

# ì‹œê°„ ì»¬ëŸ¼ ì´ë¦„ ì •ì˜ (hour00, hour01, ..., hour23)
hour_cols <- paste0("hour", sprintf("%02d", 0:23))

# 0ì‹œ~23ì‹œ ì—´ì„ Long í˜•ì‹ìœ¼ë¡œ ë³€í™˜: Hourì™€ Traffic ì—´ ìƒì„±
traffic_long_seoul <- s.donor.raw_na %>% 
  pivot_longer(
    cols = `hour00`:`hour23`,
    names_to = "Hour",
    values_to = "Traffic"
  ) %>% 
  mutate(
    Hour = as.numeric(str_remove(Hour, "hour")), # "hour" ë¬¸ì ì œê±° í›„ numeric ë³€í™˜
    Missing = if_else(is.na(Traffic), "Missing", "Present")
  )

# Heatmap 1: ëª¨ë“  ì£¼ì— ëŒ€í•´ ì›ë³¸ ê²°ì¸¡ì¹˜ ë¶„í¬ í™•ì¸
ggplot(traffic_long_seoul, aes(x = day_start, y = Hour, fill = Missing)) +
  geom_tile() +
  facet_wrap(~ roadName, ncol = 2) +
  scale_y_continuous(breaks = 0:23) +
  scale_fill_manual(values = c("Missing" = "red", "Present" = "white")) +
  labs(title = "Heatmap 1: Missing Traffic Data by roadName and Date (All Weeks)",
       x = "Date", y = "Hour") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

# ê° ë„ë¡œë³„, ì£¼(Week_Start) ë‹¨ìœ„ë¡œ ê²°ì¸¡ì¹˜ ì´ ì…€ ìˆ˜, NA ê°œìˆ˜, NA ë¹„ìœ¨(rate) ê³„ì‚°
na_summary_weekly <- traffic_long_seoul %>% 
  group_by(roadName) %>% 
  summarise(
    total_cells = n(),
    NA_Count = sum(is.na(Traffic)),
    rate = NA_Count / total_cells,
    .groups = "drop"
  )

# ê²°ê³¼ í™•ì¸
print(na_summary_weekly)

```

#===============================
#ì„œìš¸ ì£¼ë³„ í‰ê·  ë°ì´í„° ë½‘ê¸°
#=========================

```{r}
library(dplyr)
library(lubridate)

# 1. day_startë¥¼ ë‚ ì§œí˜•ìœ¼ë¡œ ë³€í™˜í•˜ê³ , 2021ë…„ ì´í›„ ë°ì´í„°ë§Œ ì„ íƒí•˜ë©° ì£¼ ì‹œì‘ì¼ ë° ì£¼ ë²ˆí˜¸ ë¶€ì—¬
daily_data <- s.donor.raw_na  %>% 
  mutate(
    day_start = ymd(as.character(day_start)),
    Week_Start = floor_date(day_start, "week", week_start=6),
    Week_Number = dense_rank(Week_Start)
  ) %>% 
    filter(
    day_start >= as.Date("2022-11-01") &
    day_start <= as.Date("2025-03-31")
  )

```
#### ì„œìš¸ ë°ì´í„° ë³´ê°„

```{r}
library(dplyr)
library(tidyr)
library(lubridate)
library(zoo)    # na.approxÂ·na.locf

long <- daily_data %>%                                         
  pivot_longer(
    cols   = starts_with("hour"),               # hour00â€“hour23
    names_to  = "hour_str", values_to = "traffic"
  ) %>% 
  mutate(
    hour  = parse_number(hour_str),             # "hour07" â†’ 7
    ts    = as.POSIXct(day_start) + hours(hour) # ì—°ì† ì‹œê³„ì—´ìš©
  ) %>% 
  arrange(roadName, number, direction, ts)


filled <- long %>% 
  group_by(roadName, number, direction) %>% 
  arrange(ts) %>% 

  # â‘  ì„ í˜• ë³´ê°„ (ì¤‘ê°„ êµ¬ê°„)
  mutate(traffic = na.approx(traffic, x = ts, na.rm = FALSE)) %>% 

  # â‘¡ LOCF/NOCBë¡œ ì–‘ ëë‹¨ ì±„ìš°ê¸°
  mutate(
    traffic = zoo::na.locf(traffic, na.rm = FALSE),
    traffic = zoo::na.locf(traffic, fromLast = TRUE, na.rm = FALSE)
  ) %>% 
  ungroup()

daily_filled_seoul <- filled %>% 
  select(-ts, -hour) %>% 
  pivot_wider(
    names_from  = hour_str,
    values_from = traffic
  ) %>% 
  relocate(starts_with("hour"), .after = direction)

```

```{r}
### 2. ê° ë‚ ì§œë³„, ë„ë¡œë³„, ë°©í–¥ë³„ ì¼ì¼ ì´ êµí†µëŸ‰ ê³„ì‚°
# ì—¬ê¸°ì„œëŠ” 0ì‹œë¶€í„° 23ì‹œê¹Œì§€ì˜ êµí†µëŸ‰ í•©ê³„ë¥¼ Daily_Totalë¡œ ê³„ì‚°í•©ë‹ˆë‹¤.
daily_totals <- daily_filled_seoul %>%
  group_by(day_start, roadName, direction, Week_Start) %>%
  summarise(Daily_Total = sum(c_across(hour00:hour23), na.rm = TRUE), .groups = "drop")

### 4. ì–‘ë°©(ë‘ ë°©í–¥) í•©ì‚°: ë™ì¼í•œ ë‚ ì§œì™€ ë„ë¡œì— ëŒ€í•´ ë°©í–¥(0,1)ì„ í•©ì‚°í•˜ì—¬ ì¼ì¼ ì´ êµí†µëŸ‰ì„ ê³„ì‚°
daily_totals_combined <- daily_totals %>%
  group_by(day_start, roadName, Week_Start) %>%
  summarise(Daily_Total_Combined = sum(Daily_Total), .groups = "drop")

write.csv(daily_totals_combined, "/Users/maeg/Downloads/Thesis_Materials/daily_totals_combined_filled.csv", row.names=FALSE)

### 5. ê° ë„ë¡œë³„, ì£¼(Week_Number) ë‹¨ìœ„ë¡œ ì–‘ë°© í•©ì‚° ì¼ì¼ ì´ êµí†µëŸ‰ì˜ ì£¼ median ê³„ì‚°
weekly_median_daily_totals_combined <- daily_totals_combined %>%
  group_by(roadName, Week_Start) %>%
  summarise(Weekly_Avg_Daily_Total_Combined = median(Daily_Total_Combined), .groups = "drop")
write.csv(weekly_median_daily_totals_combined, "weekly_median_daily_totals_combined_filled.csv")

### 6. ê° ë„ë¡œë³„, ì›” ë‹¨ìœ„ë¡œ ì–‘ë°© í•©ì‚° ì¼ì¼ ì´ êµí†µëŸ‰ì˜ì›” median ê³„ì‚°
monthly_median_traffic_s <- daily_totals_combined %>%
  mutate(month = floor_date(day_start, "month")) %>%
  group_by(roadName, month) %>%
  summarise(monthly_median = median(Daily_Total_Combined), .groups = "drop")

write.csv(monthly_median_traffic_s, "monthly_median_s_filled.csv")

### 6. ê° ë„ë¡œë³„, ì›” ë‹¨ìœ„ë¡œ ì–‘ë°© í•©ì‚° ì¼ì¼ ì´ êµí†µëŸ‰ì˜ì›” mean ê³„ì‚°
monthly_mean_traffic_s <- daily_totals_combined %>%
  mutate(month = floor_date(day_start, "month")) %>%
  group_by(roadName, month) %>%
  summarise(monthly_mean = round(mean(Daily_Total_Combined)), .groups = "drop")

write.csv(monthly_mean_traffic_s, "monthly_mean_s_filled.csv")


#### 2023-2024ë…„ 1ì›” ì„œìš¸ ë„ë¡œ ì¼ì¼ êµí†µëŸ‰ (í•©ì‚°)
#daily_median_seoul_2324 <- daily_totals %>%
#  filter(day_start >= as.Date("2023-01-01") & day_start < as.Date("2024-02-01")) %>%
#  group_by(day_start, roadName, Week_Start) %>%
#  summarise(Daily_Total_Combined = mean(Daily_Total), .groups = "drop")

###############weekly_median_daily_totals_combined
################ìµœì¢… ë°ì´í„°


```

#ì„œìš¸ë°ì´í„° ì‹œê°í™”
#===============

```{r}
##ë„ë¡œ í‰ê·  ê³„ì‚°
average_traffic_seoul <- daily_totals_combined %>%

  group_by(roadName) %>%
  summarise(avg_traffic = mean(Daily_Total_Combined, na.rm = TRUE)) %>%
  ungroup()



##ì„œìš¸ ë„ë¡œ í‰ê·  ì‹œê°í™”
ggplot(data = average_traffic_seoul, aes(x = reorder(roadName, -avg_traffic), y = avg_traffic)) +
  geom_bar(stat = "identity", fill = "gray") +
  geom_text(aes(label = round(avg_traffic, 0)), vjust = -0.5, size = 3) +  # í‰ê·  êµí†µëŸ‰ ì¶”ê°€
  labs(
    title = "Average Traffic of Each roadName",
    x = "roadNames",
    y = "Average Traffic"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


##ë„ë¡œ median ê³„ì‚°
median_traffic_seoul <- daily_totals_combined %>%

  group_by(roadName) %>%
  summarise(med_traffic = median(Daily_Total_Combined, na.rm = TRUE)) %>%
  ungroup()



##ì„œìš¸ ë„ë¡œ í‰ê·  ì‹œê°í™”
ggplot(data = median_traffic_seoul, aes(x = reorder(roadName, -med_traffic), y = med_traffic)) +
  geom_bar(stat = "identity", fill = "gray") +
  geom_text(aes(label = round(med_traffic, 0)), vjust = -0.5, size = 3) +  # í‰ê·  êµí†µëŸ‰ ì¶”ê°€
  labs(
    title = "Median Traffic of Each roadName",
    x = "roadNames",
    y = "Median Traffic"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


# 2. íˆíŠ¸ë§µ ê·¸ë¦¬ê¸°
ggplot(traffic_long_seoul, aes(x = day_start, y = Hour, fill = Missing)) +
  geom_tile() +
  facet_wrap(~ roadName, ncol = 2) +
  scale_y_continuous(breaks = 0:23) +
  scale_fill_manual(values = c("Missing" = "red", "Present" = "white")) +
  labs(
    title = "Heatmap 1: Road-level distribution of missing traffic data for all states",
    x = "day",
    y = "time"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
    theme(text = element_text(family = "main"))

```

#ì„œìš¸ median/mean box plot ì‹œê°í™”
#==============================
```{r}

##medianê³¼ meanì¤‘ ë¬´ì—‡ì„ ì‹ ë¢°?

library(dplyr)
library(tidyr)
library(ggplot2)
library(scales)   # ì²œ ë‹¨ìœ„ comma í‘œì‹œìš©

# 1ï¸âƒ£ ë‘ ë°ì´í„°ì…‹ì„ long í˜•íƒœë¡œ ê²°í•© --------------------------------------------
median_df <- monthly_median_traffic_s %>%          # â¬…ï¸ median
  rename(value = monthly_median) %>%
  mutate(stat = "Median")

mean_df <- monthly_mean_traffic_s %>%              # â¬…ï¸ mean
  rename(value = monthly_mean) %>%
  mutate(stat = "Mean")

traffic_long <- bind_rows(median_df, mean_df)

# 2ï¸âƒ£ ë„ë¡œë³„ box plot + ì‹¤ì œ ì  --------------------------------------------------
ggplot(traffic_long,
       aes(x = roadName, y = value, fill = stat)) +
  geom_boxplot(width = .6, outlier.shape = NA,
               position = position_dodge(width = .75), alpha = .4) +
  # ê´€ì¸¡ê°’ ì  ì°ê¸°
  geom_jitter(aes(color = stat),
              size = 1.2, alpha = .6,
              position = position_dodge(width = .75)) +
  scale_y_continuous(labels = comma) +
  scale_fill_manual(values = c("Median" = "#1f77b4", "Mean" = "#ff7f0e")) +
  scale_color_manual(values = c("Median" = "#1f77b4", "Mean" = "#ff7f0e")) +
  labs(x = NULL,
       y = "Average Daily Traffic (vehicles)",
       fill = NULL, color = NULL,
       title = "Distribution of Average Daily Traffic by Road: Median vs Mean") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(monthly_median_traffic_s)
```

#ì„œìš¸ ìµœì¢… ë°ì´í„° ì €ì¥
#===================================================

```{r} 

write.csv(weekly_median_daily_totals_combined, "/Users/maeg/Downloads/Thesis_Materials/raw_data/seoul/seoul_weekly_median_preprocessed.csv")

```



#================================================
#ì„œìš¸ ì†ë„/êµí†µëŸ‰ ë°ì´í„° ì •ë¦¬
speed data that was preprocessed
#======================
```{r}
library(tidyverse)
library(lubridate)

# 0. ì›í•˜ëŠ” ê¸°ê°„
start_week <- as.Date("2022-11-01")
end_week   <- as.Date("2025-03-31")

# 1. speed ë°ì´í„°
seoul_speed <- read_csv(
  "/Users/maeg/Downloads/Thesis_Materials/seoul_speed/weekly_median_daily_totals_combined.csv",
  show_col_types = FALSE
) %>% 
  rename(ROAD_NAME = roadName) %>% 
  select(-1) %>%                        # ì¸ë±ìŠ¤ ì—´ ì œê±°
  mutate(
    Week_Start = ymd(Week_Start)        # ë¬¸ìì—´ â†’ Date
  ) %>% 
  filter(
    Week_Start >= start_week,
    Week_Start <= end_week
  )

# 2. traffic ë°ì´í„°
seoul_traffic <- read_csv(
  "/Users/maeg/Downloads/Thesis_Materials/raw_data/seoul/seoul_weekly_median_preprocessed.csv",
  locale = locale(encoding = "CP949")
) %>% 
  rename(ROAD_NAME = roadName) %>% 
  select(-1) %>%                       # ì¸ë±ìŠ¤ ì—´ ì œê±°
  mutate(
    Week_Start = ymd(Week_Start)       # í•„ìš” ì‹œ Date ë³€í™˜
  ) %>% 
  filter(
    Week_Start >= start_week,
    Week_Start <= end_week
  )

# í™•ì¸
range(seoul_speed$Week_Start)    # "2022-10-02" ... "2025-03-30" (ì£¼ ì‹œì‘ì¼ ê¸°ì¤€)
range(seoul_traffic$Week_Start)  # ë™ì¼ ë²”ìœ„ë©´ OK
```




#ì„œìš¸ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
#=================================================

```{r}
library(readxl)
library(dplyr)
library(stringr)
library(lubridate)
library(tidyr)
library(googledrive)
library(readr)
library(ggplot2)



# 2) ì„œìš¸ í‰ê·  êµí†µëŸ‰ --------------------------------------------------------
seoul_traffic_f <- seoul_traffic %>%                                          # ì¸ë±ìŠ¤ ì—´ ì œê±°
  rename(yrmth    = Week_Start,
         vol_med  = Weekly_Avg_Daily_Total_Combined) %>% 
  left_join(route_map, by = "ROAD_NAME") %>%                   # ì˜ë¬¸â†’route_id
  mutate(region = "seoul_from_seoul",
         yrmth  = as.Date(yrmth)) %>% 
  dplyr::select(ROAD_NAME, region, yrmth, vol_med)

# 3) ì„œìš¸ ì†ë„Â·ë³€ìˆ˜ ---------------------------------------------------------
seoul_speed_f <- seoul_speed %>%                                          # ì¸ë±ìŠ¤ ì—´ ì œê±°
  rename(yrmth    = Week_Start,
         speed  = Weekly_Avg_Daily_Total_Combined) %>% 
  left_join(route_map, by = "ROAD_NAME") %>%                   # ì˜ë¬¸â†’route_id
  mutate(region = "seoul_from_seoul",
         yrmth  = as.Date(yrmth)) %>% 
  dplyr::select(ROAD_NAME, region, yrmth, speed)


# 4) ë³‘í•© -------------------------------------------------------------------
seoul_final <- seoul_traffic_f %>% 
  left_join(seoul_speed_f, by = c("ROAD_NAME", "yrmth", "region")) 

seoul_final <- seoul_final %>%
    rename(SUM_YRMTHDAT = "yrmth",
          TRFFCVLM = "vol_med",
         SPD_AVG = "speed")
 

# ë³‘í•©
# ë³‘í•© ëˆ„ë½ í™•ì¸
#seoulWhatthefuck<- data.frame(
anti_join(seoul_traffic_f, seoul_speed_f, by = c("ROAD_NAME","yrmth")) %>% nrow()

#)  # 0ì´ë©´ OK


#print(seoul_final) speed_seoul_weekly <- read.csv("speed_daily_totals_combined.csv") %>% select(-1)
```
```{r}
# 2-A. ë„ë¡œë³„ ì£¼ê°„ í†µí–‰ëŸ‰ --------------------------------------------------
ggplot(seoul_final, aes(x = SUM_YRMTHDAT, y = TRFFCVLM)) +
  geom_line(color = "#004488") +
  facet_wrap(~ ROAD_NAME, scales = "free_y") +
  labs(title = "ì£¼ê°„ í†µí–‰ëŸ‰(ê°•ë³€ë¶ë¡œ í¬í•¨) â€“ ë„ë¡œë³„",
       x = "Week (Mon-start)", y = "Traffic volume") +
  theme_minimal()

# 2-B. ë„ë¡œë³„ ì£¼ê°„ í‰ê·  ì†ë„ ----------------------------------------------
ggplot(seoul_final, aes(x = SUM_YRMTHDAT, y = SPD_AVG)) +
  geom_line(color = "#BB5566") +
  facet_wrap(~ ROAD_NAME, scales = "free_y") +
  labs(title = "ì£¼ê°„ í‰ê·  ì†ë„ â€“ ë„ë¡œë³„",
       x = "Week (Mon-start)", y = "Average speed (km/h)") +
  theme_minimal()
```


#==================================
# 3. ì„œìš¸ê³¼ íƒ€ì§€ì—­ ë°ì´í„° í•©ì¹˜ê¸°
#====================================================


```{r}

summary(seoul_final)

which(rowSums(is.na(seoul_final)) >0)
#563 589 591 593 ê°•ë‚¨ìˆœí™˜ì„  ì†ë„ ë°ì´í„°ê°€ ì—†ì–´ì„œ ì‚­ì œí•´ì•¼ í• ë“¯

#seoul_final <- seoul_final %>%
#  filter(!ROAD_NAME %in% "GangnamLoop")
```
#ì„œìš¸ë„ë„ˆ í•©ì¹˜ê¸° ############ã…‡ì—¬ê¸°ë¡œ ë‹¤ì‹œ ëŒì•„ì˜¤ê¸°
```{r}


# ë‘˜ ë‹¤ ë¬¸ìí˜•ìœ¼ë¡œ ë§ì¶”ëŠ” ì˜ˆ
library(dplyr)

donor_final_subset <- region_weekly_full_final %>%
  mutate(
    LINK_ID = as.character(LINK_ID))  %>%                       # ì¸ë±ìŠ¤ ì—´ ì œê±°
  mutate(
    SUM_YRMTHDAT = ymd(SUM_YRMTHDAT)       # í•„ìš” ì‹œ Date ë³€í™˜
  ) %>% 
  filter(
    SUM_YRMTHDAT >= start_week,
    SUM_YRMTHDAT <= end_week
  ) 

seoul_final_subset <- seoul_final

combined_final <- bind_rows(donor_final_subset, seoul_final_subset) %>% select(-LINK_ID) %>%
  filter(!ROAD_NAME %in% c("ì„œìš¸ë¬¸ì‚°ì§€ì„ ", "Sinwol"))

print(combined_final)


combined_final %>%
     # â‘  ì´ë¦„ì´ â€˜ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_â€™ë¡œ ë°”ë€ ë„ë¡œë§Œ
     filter(str_detect(ROAD_NAME, "^ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_"))
```


```{r}

roads_info <- read_xlsx("/Users/maeg/Downloads/Thesis_Materials/file_info.xlsx")

combined_donor <- combined_final %>%
  left_join(roads_info, by = c("region", "ROAD_NAME")) %>%
  filter(!region == "seoul")

summary(combined_donor)
summary(is.na(combined_donor))
library(readr)

write_csv(
  combined_donor,
  "/Users/maeg/Downloads/Thesis_Materials/combined_donor_weekly.csv"
)

print(combined_donor)

##qgisë¥¼ ìœ„í•´ ë…¸ë“œì•„ì´ë””ê°’ ë¹¼ë ¤ë©´ link_idë¥¼ ë¹¼ì•¼í•¨.
#link_filtered <- region_monthly_full_final %>%
#     dplyr::select(LINK_ID, ROAD_NAME, region) %>%
#     distinct()

#write.csv(link_filtered, "link_filtered.csv", fileEncoding = "CP949", row.names = FALSE)

#write.csv(region_monthly_full_final, "region_monthly_full_final.csv", fileEncoding = "CP949", row.names = FALSE)

combined_donor %>%
     # â‘  ì´ë¦„ì´ â€˜ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_â€™ë¡œ ë°”ë€ ë„ë¡œë§Œ
     filter(str_detect(ROAD_NAME, "^ìˆ˜ë„ê¶Œì œ1ìˆœí™˜ë¡œ_"))

#naí™•ì¸
nas <- combined_donor %>% filter(if_any(everything(), is.na))

nas
```