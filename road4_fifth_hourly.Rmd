---
title: "SCM_olympic_0"
author: "Jiye Shin"
date: "`r Sys.Date()`"
output:
  html_document:
    self_contained: true
---

### 1. Import

```{r}

#incheon_daily_full
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(tidyr)
library(scales)
library(Synth)
library(readr)
library(showtext)
library(future)
library(SCtools)

font_add_google("Noto Sans KR",      #* êµ¬ê¸€ í°íŠ¸ í•œê¸€ê³„ì—´ ì¶”ì²œ
                regular.wt = 400,    # 400 = Regular
                bold.wt    = 700)    # 700 = Bold
showtext_auto()                      # ğŸ“Œ ì´ ì¤„ ì´í›„ ëª¨ë“  í”Œë¡¯ì— ì ìš©

#ì›ë˜ í”¼ë°œë¥˜ ë‚®ê²Œ ë‚˜ì˜¨ê±°. "/Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/important/df_filtered_without_imputed_raw.csv"
# ìƒˆê±°"/Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/preprocessed/hourly_final_data_0723_with_seoul_without_imputed.csv"
#/Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/important/df_filtered_without_imputed_raw.csv
# ì˜¬ë°”ë¥¸ ì‚¬ìš© ì˜ˆ â€• CSV íŒŒì¼ì„ ì½ì–´ df ì— ë‹´ê¸°


### ì œëŒ€ë¡œ ëœ í”¼ë°œë¥˜ ë‚˜ì˜¤ëŠ”ê±° #/Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/preprocessed/hourly_final_data_0723_with_seoul_without_imputed.csv
## ^ë°”ë¡œ ìœ„ì—ê±°ì— ì˜ì–´ ì´ë¦„ ë‹¨ê±° # /Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/preprocessed/hourly_final_data_0724_with_seoul_without_imputed_with_en.csv"

##"/Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/preprocessed/length_corrected_0725.csv" ë„ë¡œ ê¸¸ì´ ë„£ì€ê±°

### ì¸ì²œ ìƒˆë„ë¡œ ì§‘ì–´ë„£ì€ê±°. 
#/Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/preprocessed/hourly_final_data_0725_with_seoul_without_imputed_with_en.csv

#ë„ë¡œ ë” ì§‘ì–´ë„£ì€ê±° /Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/preprocessed/hourly_final_data_0727_with_seoul_without_imputed_with_en.csv #ì´ê±¸ë¡œ ì˜¬ë¦¼í”½ëŒ€ë¡œì „ê¹Œì§€ ì§„í–‰í•¨

#ì™„ì „ ë¡œìš° /Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/preprocessed/hourly_final_data_0727_new_rule.csv

df_raw <- read.csv("/Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/preprocessed/hourly_final_data_0727_new_rule.csv", fileEncoding = "CP949") %>%
  mutate(week = ymd(week))
head(df_raw)



```


```{}
library(readxl)
changed_length <- read_excel("/Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/info/true_info_again.xlsx")


# 1) df_rawì—ì„œ road ê°’ì´ changed_length$roadì— ìˆëŠ” ê²ƒë§Œ í•„í„°
df_filtered <- df_raw %>%
  semi_join(changed_length, by = "road") %>% select(-c(total_length_km, local_length_km))


df_step2 <- df_filtered %>%
  left_join(
    changed_length %>% 
      select(road, direction, local_length_km, total_length_km, linkID),
    by = c("road", "direction", "linkID")) 
```

```{r}
library(dplyr)

df_step4 <- df_raw %>% 
  group_by(linkID, routeNM) %>%
  mutate(
    total_length = total_length_km * 1,
    local_length = local_length_km * 1
  ) %>% select(-c(total_length_km, local_length_km)) %>%
  mutate(local_share = local_length / total_length)



```

```{}
# 1) ì›ë³¸ ë³´ì¡´
df_step4 <- df_step4 %>%
  rename(
    origin_traffic = traffic,
    origin_speed   = speed
  )

# 2) í‘œì¤€í™”í•  ë³€ìˆ˜ ëª©ë¡(ì´ë¯¸ origin_* ì€ ë¹¼ê³  ë‚˜ë¨¸ì§€ë§Œ)
cont_vars <- c(
  "lanes.min", "lanes.max", "local_share",
  "speed.min", "speed.max",
  "local_length", "total_length"
)

# 3) ê³µë³€ëŸ‰ + traffic/speed ëª¨ë‘ z-score í‘œì¤€í™”
df_scaled_z <- df_step4 %>%
  mutate(
    across(all_of(cont_vars), ~ as.numeric(scale(.))),
    traffic = as.numeric(scale(origin_traffic)),
    speed   = as.numeric(scale(origin_speed))
  )
```

#setting
```{r}

start_week <- ymd("2023-02-13")
policy_date <- ymd("2024-01-27")    # ì •ì±… ì‹œì‘ì¼
end_week   <- ymd("2025-03-31") 

# 0) ë¡œì»¬ êµ¬ê°„ ë¹„ì¤‘ ë³€ìˆ˜ ì¶”ê°€


## 1) ì›ë³¸ -> ê¸°ê°„ë§Œ ì˜ë¼ë‚´ê¸°
df_period <- df_step4 %>% 
  # month ì—´ì´ Date í˜•ì‹ì¸ì§€ í•œë²ˆ ë³´ì¥
  mutate(week = as.Date(week)) %>%      
  filter(
    week >= start_week,
    week <= end_week
  )

## 2) ì˜ë¼ë‚¸ ë’¤ì— unit_nameë³„ month_index ë¶€ì—¬
df_m <- df_period %>% 
  arrange(routeNM, week) %>% 
  group_by(routeNM) %>% 
  mutate(week_index = row_number()) %>% 
  ungroup() %>% 
  mutate(unit_id = as.numeric(unit_id))

df_scm <- as.data.frame(df_m)

# ì²˜ë¦¬êµ°

# 1) ê¸°ë³¸: unit_id â†” unit_name ë§¤í•‘ --------------------------
lookup_tbl <- df_scm %>%
  distinct(unit_id, routeNM, road, region, direction, total_length, local_length, unit_name_en, road_en) %>%       # ì¤‘ë³µ ì œê±° routeNM_en, road_en, 
  arrange(unit_id)                       # ë³´ê¸° ì¢‹ê²Œ ì •ë ¬

print(lookup_tbl)               # ëª¨ë‘ ì¶œë ¥



# ëª¨ë“  ì£¼ ë²¡í„° ìƒì„±
weeks_all <- seq(start_week, end_week, by = "week")
n_all  <- length(weeks_all)                #
n_pre  <- sum(weeks_all <= policy_date)  #-1 
n_post <- n_all - n_pre

cat(sprintf("ì‚¬ì „ %dì£¼ Â· ì‚¬í›„ %dì£¼ Â· ì „ì²´ %dì£¼\n",
            n_pre, n_post, n_all))


good_preds <- c("lanes.min","local_length_km","total_length_km", "speed.max", "lanes.max", "speed.min", "local_share")

good_preds_new <- c("lanes.max", "speed.max","local_share", "total_length_km")

sp_list <- list(                              # traffic 11ë¸”ë¡ + speed 1ë¸”ë¡
  list("traffic", 1:4,  "mean"),  list("traffic", 5:8,  "mean"),
  list("traffic", 9:13, "mean"),  list("traffic",14:17, "mean"),
  list("traffic",18:21, "mean"),  list("traffic",22:26, "mean"),
  list("traffic",27:30, "mean"),  list("traffic",31:33, "mean"),
  list("traffic",34:36, "mean"),   list("traffic",37:39, "mean"),  list("traffic",40:42, "mean"),  list("traffic",43:45, "mean"), list("traffic",46:48, "mean"),list("traffic",49:51, "mean"),
  list("speed",    1:25, "mean"), list("speed", 26:51, "mean"))
#     list("traffic",48:50, "mean"), list("traffic",56:63, "mean"),    list("traffic",64:70, "mean"), list("speed",   1:70, "mean"))
  #    

sp_2_all <- list(
    ## â”€â”€ traffic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  list("traffic",  1:2 , "mean"),
  list("traffic",  3:4 , "mean"),
  list("traffic",  5:6 , "mean"),
  list("traffic",  7:8 , "mean"),
  list("traffic",  9:10, "mean"),
  list("traffic", 11:12, "mean"),
  list("traffic", 13:14, "mean"),
  list("traffic", 15:16, "mean"),
  list("traffic", 17:18, "mean"),
  list("traffic", 19:20, "mean"),
  list("traffic", 21:22, "mean"),
  list("traffic", 23:24, "mean"),
  list("traffic", 25:26, "mean"),
  list("traffic", 27:28, "mean"),
  list("traffic", 29:30, "mean"),
  list("traffic", 31:32, "mean"),
  list("traffic", 33:34, "mean"),
  list("traffic", 35:36, "mean"),
    list("traffic", 37:38, "mean"),
    list("traffic", 39:40, "mean"),
  list("traffic", 41:42, "mean"),
  list("traffic", 43:44, "mean"),
  list("traffic", 45:46, "mean"),
  list("traffic", 47:48, "mean"),
  list("traffic",49:50, "mean"),
  #,  list("traffic", 51:51, "mean"),
  
  ## â”€â”€ speed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 list("speed",    1:25, "median"), list("speed",    26:50, "median"))



sp_32 <- list(
  list("traffic",  1:1 ,  "mean"),
  list("traffic",  2:3 ,  "mean"),  # B02
  list("traffic",  4:5 ,  "mean"),   # B03
  list("traffic",  6:6 ,  "mean"),   # B04
  list("traffic",  7:8 ,  "mean"),   # B05
  list("traffic",  9:10,  "mean"),   # B06
  list("traffic", 11:11,  "mean"),   # B07
  list("traffic", 12:13,  "mean"),   # B08
  list("traffic", 14:15,  "mean"),   # B09
  list("traffic", 16:16,  "mean"),   # B10
  list("traffic", 17:18,  "mean"),   # B11
  list("traffic", 19:20,  "mean"),   # B12
  list("traffic", 21:21,  "mean"),   # B13
  list("traffic", 22:23,  "mean"),   # B14
  list("traffic", 24:25,  "mean"),   # B15
  list("traffic", 26:26,  "mean"),   # B16
  list("traffic", 27:28,  "mean"),   # B17
  list("traffic", 29:30,  "mean"),   # B18
  list("traffic", 31:31,  "mean"),   # B19
  list("traffic", 32:33,  "mean"),   # B20
  list("traffic", 34:35,  "mean"),   # B21
  list("traffic", 36:36,  "mean"),   # B22
  list("traffic", 37:38,  "mean"),   # B23
  list("traffic", 39:40,  "mean"),   # B24
  list("traffic", 41:41,  "mean"),   # B25
  list("traffic", 42:43,  "mean"),   # B26
  list("traffic", 44:45,  "mean"),   # B27
  list("traffic", 46:46,  "mean"),   # B28
  list("traffic", 47:48,  "mean"),   # B29
  list("traffic", 49:50,  "mean"),   # B30
  list("speed",  1:25, "median"),
list("speed", 26:50, "median"))

  
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## 1-week blocks (traffic 50â€†+â€†speed 50  â†’  ì´ 100ê°œ)
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
sp_all_1wk <- list(
  ## â”€â”€ traffic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	  list("traffic",  1:1 , "mean"),  list("traffic",  2:2 , "mean"),
  list("traffic",  3:3 , "mean"),  list("traffic",  4:4 , "mean"),
  list("traffic",  5:5 , "mean"),  list("traffic",  6:6 , "mean"),
  list("traffic",  7:7 , "mean"),  list("traffic",  8:8 , "mean"),
  list("traffic",  9:9 , "mean"),  list("traffic", 10:10, "mean"),
  list("traffic", 11:11, "mean"),  list("traffic", 12:12, "mean"),
  list("traffic", 13:13, "mean"),  list("traffic", 14:14, "mean"),
  list("traffic", 15:15, "mean"),  list("traffic", 16:16, "mean"),
  list("traffic", 17:17, "mean"),  list("traffic", 18:18, "mean"),
  list("traffic", 19:19, "mean"),  list("traffic", 20:20, "mean"),
  list("traffic", 21:21, "mean"),  list("traffic", 22:22, "mean"),
  list("traffic", 23:23, "mean"),  list("traffic", 24:24, "mean"),
  list("traffic", 25:25, "mean"),  list("traffic", 26:26, "mean"),
  list("traffic", 27:27, "mean"),  list("traffic", 28:28, "mean"),
  list("traffic", 29:29, "mean"),  list("traffic", 30:30, "mean"),
  list("traffic", 31:31, "mean"),  list("traffic", 32:32, "mean"),
  list("traffic", 33:33, "mean"),  list("traffic", 34:34, "mean"),
  list("traffic", 35:35, "mean"),  list("traffic", 36:36, "mean"),
  list("traffic", 37:37, "mean"),  list("traffic", 38:38, "mean"),
  list("traffic", 39:39, "mean"),  list("traffic", 40:40, "mean"),
  list("traffic", 41:41, "mean"),  list("traffic", 42:42, "mean"),
  list("traffic", 43:43, "mean"),  list("traffic", 44:44, "mean"),
  list("traffic", 45:45, "mean"),  list("traffic", 46:46, "mean"),
  list("traffic", 47:47, "mean"),  list("traffic", 48:48, "mean"),
  list("traffic", 49:49, "mean"),list("traffic", 50:50, "mean"),
#  list("traffic", 51:51, "mean"),

#,
  ## â”€â”€ speed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	  list("speed",  1:1 , "median"),  list("speed",  2:2 , "median"),
  list("speed",  3:3 , "median"),  list("speed",  4:4 , "median"),
  list("speed",  5:5 , "median"),  list("speed",  6:6 , "median"),
  list("speed",  7:7 , "median"),  list("speed",  8:8 , "median"),
  list("speed",  9:9 , "median"),  list("speed", 10:10, "median"),
  list("speed", 11:11, "median"),  list("speed", 12:12, "median"),
  list("speed", 13:13, "median"),  list("speed", 14:14, "median"),
  list("speed", 15:15, "median"),  list("speed", 16:16, "median"),
  list("speed", 17:17, "median"),  list("speed", 18:18, "median"),
  list("speed", 19:19, "median"),  list("speed", 20:20, "median"),
  list("speed", 21:21, "median"),  list("speed", 22:22, "median"),
  list("speed", 23:23, "median"),  list("speed", 24:24, "median"),
  list("speed", 25:25, "median"),  list("speed", 26:26, "median"),
  list("speed", 27:27, "median"),  list("speed", 28:28, "median"),
  list("speed", 29:29, "median"),  list("speed", 30:30, "median"),
  list("speed", 31:31, "median"),  list("speed", 32:32, "median"),
  list("speed", 33:33, "median"),  list("speed", 34:34, "median"),
  list("speed", 35:35, "median"),  list("speed", 36:36, "median"),
  list("speed", 37:37, "median"),  list("speed", 38:38, "median"),
  list("speed", 39:39, "median"),  list("speed", 40:40, "median"),
  list("speed", 41:41, "median"),  list("speed", 42:42, "median"),
  list("speed", 43:43, "median"),  list("speed", 44:44, "median"),
  list("speed", 45:45, "median"),  list("speed", 46:46, "median"),
  list("speed", 47:47, "median"),  list("speed", 48:48, "median"),
  list("speed", 49:49, "median"),list("speed", 50:50, "median"))
#  list("speed", 51:51, "median"))

sp_25 <- list(
  ## â”€â”€ traffic: 1â€“50ì£¼ë¥¼ 2ì£¼ì”© ëŠì–´ median
  list("traffic",  1:2,  "median"),
  list("traffic",  3:4,  "median"),
  list("traffic",  5:6,  "median"),
  list("traffic",  7:8,  "median"),
  list("traffic",  9:10, "median"),
  list("traffic", 11:12, "median"),
  list("traffic", 13:14, "median"),
  list("traffic", 15:16, "median"),
  list("traffic", 17:18, "median"),
  list("traffic", 19:20, "median"),
  list("traffic", 21:22, "median"),
  list("traffic", 23:24, "median"),
  list("traffic", 25:26, "median"),
  list("traffic", 27:28, "median"),
  list("traffic", 29:30, "median"),
  list("traffic", 31:32, "median"),
  list("traffic", 33:34, "median"),
  list("traffic", 35:36, "median"),
  list("traffic", 37:38, "median"),
  list("traffic", 39:40, "median"),
  list("traffic", 41:42, "median"),
  list("traffic", 43:44, "median"),
  list("traffic", 45:46, "median"),
  list("traffic", 47:48, "median"),
  list("traffic", 49:50, "median"),

  ## â”€â”€ speed: 1â€“50ì£¼ë¥¼ 10ê°œ ë¸”ë¡(5ì£¼ì”©)ìœ¼ë¡œ ë‚˜ëˆ„ì–´ mean
  list("speed",  1:25,   "mean"),
  list("speed",  26:50,  "mean")
)

sp_all_in_time <- list(
  ## â”€â”€ traffic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	  list("traffic",  1:1 , "mean"),  list("traffic",  2:2 , "mean"),
  list("traffic",  3:3 , "mean"),  list("traffic",  4:4 , "mean"),
  list("traffic",  5:5 , "mean"),  list("traffic",  6:6 , "mean"),
  list("traffic",  7:7 , "mean"),  list("traffic",  8:8 , "mean"),
  list("traffic",  9:9 , "mean"),  list("traffic", 10:10, "mean"),
  list("traffic", 11:11, "mean"),  list("traffic", 12:12, "mean"),
  list("traffic", 13:13, "mean"),  list("traffic", 14:14, "mean"),
  list("traffic", 15:15, "mean"),  list("traffic", 16:16, "mean"),
  list("traffic", 17:17, "mean"),  list("traffic", 18:18, "mean"),
  list("traffic", 19:19, "mean"),  list("traffic", 20:20, "mean"),
  ## â”€â”€ speed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  list("speed",    1:20, "mean"))


sp_2_in_time <- list(
    ## â”€â”€ traffic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  list("traffic",  1:2 , "mean"),
  list("traffic",  3:4 , "mean"),
  list("traffic",  5:6 , "mean"),
  list("traffic",  7:8 , "mean"),
  list("traffic",  9:10, "mean"),
  list("traffic", 11:12, "mean"),
  list("traffic", 13:14, "mean"),
  list("traffic", 15:16, "mean"),
  list("traffic", 17:18, "mean"),
  list("traffic", 19:20, "mean"),
  
  ## â”€â”€ speed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  list("speed",    1:20, "mean"))



sp_all <- list(                              # traffic 11ë¸”ë¡ + speed 1ë¸”ë¡
  list("traffic", 1:4,  "mean"),  list("traffic", 5:8,  "mean"),
  list("traffic", 9:13, "mean"),  list("traffic",14:17, "mean"),
  list("traffic",18:21, "mean"),  list("traffic",22:26, "mean"),
  list("traffic",27:30, "mean"),  list("traffic",31:33, "mean"),
  list("traffic",34:36, "mean"),   list("traffic",37:39, "mean"),  list("traffic",40:42, "mean"),  list("traffic",43:45, "mean"), list("traffic",46:48, "mean"),  list("traffic",49:51, "mean"),
  list("speed", 1:4,  "mean"),  list("speed", 5:8,  "mean"),
  list("speed", 9:13, "mean"),  list("speed",14:17, "mean"),
  list("speed",18:21, "mean"),  list("speed",22:26, "mean"),
  list("speed",27:30, "mean"),  list("speed",31:33, "mean"),
  list("speed",34:36, "mean"),   list("speed",37:39, "mean"),  list("speed",40:42, "mean"),  list("speed",43:45, "mean"), list("speed",46:48, "mean") ,   list("speed",49:51, "mean"))

sp_short <- list(
  list("traffic", 1:8, "mean"),
    list("traffic", 9:17, "mean"),
  list("traffic",18:30, "mean"),
  list("traffic",31:43, "mean"),
  list("traffic",44:48, "mean"),
  list("speed",1:48, "mean"))

sp_4 <- list(
  # â”€â”€ traffic 4ë¸”ë¡ (ë¶„ê¸°ë³„) â”€â”€
  list("traffic",  1:13,  "mean"),
  list("traffic", 14:26,  "mean"),
  list("traffic", 27:39,  "mean"),
  list("traffic", 40:51,  "mean"),

  # â”€â”€ speed 4ë¸”ë¡ (ë¶„ê¸°ë³„) â”€â”€
  list("speed",  1:13,  "mean"),
  list("speed", 14:26,  "mean"),
  list("speed", 27:39,  "mean"),
  list("speed", 40:51,  "mean")
)


sp_idx <- list(
  list("traffic_idx", 1:4, "mean"),
    list("traffic_idx", 5:8, "mean"),
    list("traffic_idx", 9:13, "mean"),
  list("traffic_idx",14:17, "mean"),
  list("traffic_idx",18:21, "mean"),
  list("traffic_idx",22:26, "mean"),
    list("traffic_idx", 27:30,  "mean"),
  list("traffic_idx", 31:35, "mean"),
  list("traffic_idx", 36:39, "mean"),
  list("traffic_idx", 40:43, "mean"),
  list("traffic_idx", 44:49, "mean"),
  list("speed", 1:4, "mean"),
    list("speed", 5:8, "mean"),
      list("speed", 9:13, "mean"),
  list("speed",14:17, "mean"),
  list("speed",18:21, "mean"),
  list("speed",22:26, "mean"),
    list("speed", 27:30,  "mean"),
  list("speed", 31:35, "mean"),
  list("speed", 36:39, "mean"),
  list("speed", 40:43, "mean"),
  list("speed", 44:49, "mean"))


sp_idx_1speed <- list(
  list("traffic_idx", 1:4, "mean"),
    list("traffic_idx", 5:8, "mean"),
    list("traffic_idx", 9:13, "mean"),
  list("traffic_idx",14:17, "mean"),
  list("traffic_idx",18:21, "mean"),
  list("traffic_idx",22:26, "mean"),
    list("traffic_idx", 27:30,  "mean"),
  list("traffic_idx", 31:35, "mean"),
  list("traffic_idx", 36:39, "mean"),
  list("traffic_idx", 40:43, "mean"),
  list("traffic_idx", 44:50, "mean"),
  list("speed", 1:50, "mean"))

sp_idx_4 <- list(
  # â”€â”€ traffic 4ë¸”ë¡ (ë¶„ê¸°ë³„) â”€â”€
  list("traffic_idx",  1:13,  "mean"),
  list("traffic_idx", 14:26,  "mean"),
  list("traffic_idx", 27:39,  "mean"),
  list("traffic_idx", 40:50,  "mean"),

  # â”€â”€ speed 4ë¸”ë¡ (ë¶„ê¸°ë³„) â”€â”€
  list("speed",  1:13,  "mean"),
  list("speed", 14:26,  "mean"),
  list("speed", 27:39,  "mean"),
  list("speed", 40:50,  "mean")
)

#write.csv(lookup_tbl, "/Users/maeg/Downloads/Thesis_Materials/Thesis_spotted/preprocessed/lookup_tbl_0722.csv", row.names = FALSE, fileEncoding = "CP949")
date_tbl <- df_scm %>% select(week, week_index) %>% distinct()
```
```{r}
library(dplyr)
library(tidyr)

## 1ï¸âƒ£ ì¸ì½”ë”©Â·ìë£Œí˜• ì •ë¦¬
df_u <- df_scm %>%
  mutate(
    unit_id    = as.integer(unit_id),
    week_index = as.integer(week_index)
  )

## 2ï¸âƒ£ ì¤‘ë³µ key(unit_id Ã— week_index) ê²€ì‚¬
dup_key <- df_u %>%
  count(unit_id, week_index, name = "n") %>%
  filter(n > 1)                 # n == 1 ì´ ì •ìƒ, >1 ì´ë©´ ì¤‘ë³µ

if (nrow(dup_key) == 0) {
  message("âœ… ì¤‘ë³µ í–‰ ì—†ìŒ (unit Ã— week_index ëŠ” ëª¨ë‘ 1íšŒì”©ë§Œ ì¡´ì¬)")
} else {
  print(dup_key)               # ì–´ë–¤ unitÂ·week ê°€ ëª‡ ë²ˆ ë‚˜ì˜¤ëŠ”ì§€ í™•ì¸
}

## 3ï¸âƒ£ ë¹ ì§„ ì£¼(week) ê²€ì‚¬
full_weeks <- 1:max(df_u$week_index)          # ì›í•˜ëŠ” ì£¼ ë²”ìœ„
missing <- df_u %>%
  complete(unit_id, week_index = full_weeks) %>%   # NA í–‰ë„ ë§Œë“¤ê¸°
  filter(is.na(traffic) & is.na(speed))            # ì‹¤ì œ ë°ì´í„°ê°€ ì—†ëŠ” í–‰

if (nrow(missing) == 0) {
  message("âœ… ëˆ„ë½ ì£¼ ì—†ìŒ (ëª¨ë“  unit ì´ ì§€ì • êµ¬ê°„ì˜ ëª¨ë“  ì£¼ í–‰ì„ ë³´ìœ )")
} else {
  print(missing %>% arrange(unit_id, week_index))
}
```


#plot
```{r}

library(plotly)
ids_to_remove <- c(   setdiff(1:14, 4))

# ë§Œì•½ unit_id ê°€ character ë²¡í„°ë¼ë©´ as.character() í•´ì£¼ê³  ë”°ì˜´í‘œ ì“°ê¸°
# ids_to_remove <- as.character(ids_to_remove)

# 2) í•„í„°ë§
df_scm_plot <- df_scm %>%
  filter( !unit_id %in% ids_to_remove ) %>%
  filter(week_index < 74)


fig_all <- plot_ly(
  data = df_scm_plot,
  x    = ~week,
  y    = ~traffic,
  color= ~unit_name_en,        # ë…¸ì„ ë³„ ìƒ‰ê¹”
  type = 'scatter',
  mode = 'lines',
  hovertemplate = paste(
    "Region: %{customdata[0]}<br>",
    "Road: %{legendgroup}<br>",
    "Week: %{x|%Y-%m-%d}<br>",
    "Traffic: %{y:,} veh"
  ),
  legendgroup = ~routeNM,        # hovertemplateì—ì„œ legendgroup ì„ routeNM ìœ¼ë¡œ ì“¸ ìˆ˜ ìˆê²Œ
  customdata = ~region            # hovertemplateì—ì„œ region ì°ìœ¼ë ¤ë©´ customdata[0]
) %>%
  layout(
  title = list(text = "ì£¼ë³„ ì¶œí‡´ê·¼ ì¤‘ì•™ê°’ êµí†µëŸ‰TRUE"),
    xaxis = list(title = "Week", tickformat = "%Y-%m-%d"),
    yaxis = list(title = "Traffic (vehicles/day)"),
    legend = list(title = list(text = "<b>Route | linkID</b>"),
                        orientation = "h",    # horizontal
      x = 0.5,              # xì¶• ì¤‘ì•™
      xanchor = "center",   # ì¤‘ì•™ ê¸°ì¤€
      y = -0.2,             # plot ì•„ë˜ë¡œ ë‚´ë¦¼
      yanchor = "top"       # y ê¸°ì¤€ì„ ë²”ë¡€ ìœ„ìª½ìœ¼ë¡œ
    ))

fig_all
```


```{r}
# dp_refined ëŠ” dataprep() ê²°ê³¼ ê°ì²´
X0 <- as.matrix(dp_refined$X0)      # ì˜ˆì¸¡ë³€ìˆ˜ ë§¤íŠ¸ë¦­ìŠ¤
anyNA(X0)                           # TRUE ë©´ NA ì¡´ì¬
any(is.nan(X0))                    # TRUE ë©´ NaN ì¡´ì¬
any(is.infinite(X0))               # TRUE ë©´ Inf ì¡´ì¬

zero_var <- apply(X0, 2, function(x) sd(x, na.rm=TRUE)==0)
if (any(zero_var)) {
  X0 <- X0[, !zero_var]
  dp_refined$X0 <- X0
  dp_refined$predictors  <- dp_refined$predictors[!zero_var]
}

```

```{r}
# X0: Inf/NaN ì œê±° í›„, ë¶„ì‚°0Â·ê³ ìƒê´€ ë³€ìˆ˜ë„ ì œê±° ì „ ìƒíƒœ
sv <- svd(X0)$d    # singular values ë²¡í„°
print(sv)

# ìµœì†Œ singular value
min_sv <- min(sv)
cat("ìµœì†Œ singular value =", format(min_sv, digits=3), "\n")
```
```{r}
# dp_refined$Y0plot, dp_refined$Y1plot ì€ matrix í˜•íƒœ
any(!is.finite(dp_refined$Y0plot))   # TRUE ë©´ NA/Inf ì¡´ì¬
any(!is.finite(dp_refined$Y1plot))
```




### 3: rough SCM


```{}
library(dplyr)

library(dplyr)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 1. ì¤‘ë³µ ì œê±° ë° ì§€í‘œ ê³„ì‚° (ê¸°ì¡´ traffic/speed ë®ì–´ì“°ê¸°)
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
df_src <- df_scm %>%
  distinct() %>%                              # ì™„ì „ ì¤‘ë³µ í–‰ ì œê±°
  group_by(unit_id) %>%
  mutate(
    # ì‚¬ì „ê¸°ê°„ í‰ê·  ëŒ€ë¹„ í¸ì°¨ë¥¼ speedì— ë®ì–´ì“°ê¸°
    speed = speed - mean(speed[week_index <= n_pre], na.rm = TRUE),
    # ì‚¬ì „ê¸°ê°„ í‰ê· ì„ 100ìœ¼ë¡œ ë†“ê³  ì§€ìˆ˜í™”í•˜ì—¬ trafficì— ë®ì–´ì“°ê¸°
    traffic = 100 * traffic / mean(traffic[week_index <= n_pre], na.rm = TRUE)
  ) %>%
  ungroup()

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 2. Z-ìŠ¤ì¼€ì¼ë§ (ì—´ ê¸°ì¤€)
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# good_preds_new ì—ëŠ” ìŠ¤ì¼€ì¼ë§í•  ì—´ ì´ë¦„ ë²¡í„°ë¥¼ ì§€ì •í•˜ì„¸ìš”.
# ì˜ˆ: good_preds_new <- c("speed", "traffic", "lanes.min", "lanes.max")
df_src[ , good_preds_o] <- scale(
  df_src[ , good_preds_o],
  center = TRUE,
  scale  = TRUE
)

# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
# 3. ìµœì¢… df_scm ìœ¼ë¡œ ì¬í• ë‹¹
# â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
df_scm_idx <- df_src
```


#=====================
#>= 175,    unit_id <= 295, second_vec = 234~253, last_vec = 254~295

## ì²« SCM : ì—¬ê¸°ì„œëŠ” ê¸°ë³¸ ë°ì´í„°ì˜ ì í•©ë„ë¥¼ ë³¸ë‹¤. 
##. last_vecê³¼ Second_vecëª¨ë‘ ì‹¤ì‹œí•˜ì—¬ ì–¼ë§ˆë‚˜ ë‹¬ë¼ì§€ëŠ”ì§€ í™•ì¸í•œë‹¤.
#=====================




```{r}

####2024-08-26 82
####2024-10-28 91
###!unit_id %in% c(179, 181, 183, 187, 193, 195, 196, 217, 203,199,200)) 
#, !unit_id %in% c(217)
library("beepr")
library(Synth)



options(scipen = 999)

donor_ok_ids <- df_scm %>%
  filter(unit_id >= 15) %>%
  distinct(unit_id) %>%  # ê³ ìœ ê°’ë§Œ
  pull(unit_id)   


n_all <- 70
n_pre <- 50
length(donor_ok_ids)

treat_id <- 4


## 1ï¸âƒ£  ë„ë¡œÂ·ë°©í–¥ ì •ë³´ í•œêº¼ë²ˆì— ê°€ì ¸ì˜¤ê¸° ----------------------
road_info <- lookup_tbl %>% 
  filter(unit_id == treat_id) %>%    # treated ID (41)
  slice(1) %>%                       # í˜¹ì‹œ ëª¨ë¥¼ ì¤‘ë³µ ë°©ì§€
  mutate(
    dir_lbl = ifelse(direction == 1, "NB", "SB")  # ë°©í–¥ ë¼ë²¨ë§
  )

## 2ï¸âƒ£  (ì„ íƒ) ë‘˜ì„ í•œ ë¬¸ìì—´ë¡œ í•©ì¹˜ê¸° ------------------------
road_lbl <- with(road_info, paste0(road_en, " ", dir_lbl))
## ë˜ëŠ” tidyr::unite() ë²„ì „
# road_lbl <- road_info %>% unite(road_lbl, road_en, dir_lbl, sep = " ") %>% pull(road_lbl)

## 3ï¸âƒ£  ë²”ë¡€ ë ˆì´ë¸” ì œì‘ -------------------------------------
legend_lbl <- c(
  paste0("Treated (",   road_lbl, ")"),
  paste0("Synthetic (", road_lbl, ")")
)
legend_lbl2 <- c(
  paste0(road_lbl))


good_preds <- c("lanes.min", "speed.max", "lanes.max", "local_share") #c("lanes.min", "local_length_km", "total_length_km","speed.min", "speed.max" , "lanes.max")


good_preds_o <- c("lanes.min","lanes.max","local_length","total_length","speed.min", "speed.max", "local_share")

good_preds_new <- c("lanes.max", "speed.max", "local_length", "total_length", "local_share")


##########################
dp_params <- list(
  foo                     = as.data.frame(df_scm),
  predictors              = good_preds_new,
  predictors.op           = "mean",
  special.predictors      = sp_32, #, #sp_all_1wk, # sp_2_all, sp_32,
  dependent               = "traffic",
  unit.variable           = "unit_id",
  unit.names.variable     = "unit_name_en",
  time.variable           = "week_index",
  treatment.identifier    = treat_id,          # ì‹¤ì œ ì²˜ë¦¬êµ° ID
  controls.identifier     = donor_ok_ids,    # ì •ì œëœ donor IDs
  time.predictors.prior   = 1:n_pre,
  time.optimize.ssr       = 1:n_pre,
  time.plot               = 1:n_all
)


# 3-1) dataprep with refined donor pool
dp_refined <- do.call(dataprep, dp_params)



# 3-3) ipop ê¸°ë°˜ í•©ì„±ëŒ€ì¡°êµ° ì í•©
so_refined <- synth(data.prep.obj = dp_refined)


############################################################################
## 3. íš¨ê³¼(gap) ê³„ì‚° & ê·¸ë¦¼
############################################################################
gaps_main <- dp_refined$Y1plot - (dp_refined$Y0plot %*% so_refined$solution.w)

# â”€â”€ ê³µí†µ ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
week_all  <- dp_refined$tag$time.plot              # 1,2,3,â€¦ ì „ì²´ ì£¼ì°¨
lab_major <- c(1, seq(5, max(week_all), by = 5)) # 1,5,10,15,â€¦ ì›í•˜ëŠ” ë ˆì´ë¸”



# â”€â”€ 1) ê¶¤ì (Path) í”Œë¡¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

#===gap
# 0. ê²°ê³¼ ê·¸ë¦¼ -------------------------------------------------------------
path.plot(
  synth.res    = so_refined,
  dataprep.res = dp_refined,
  Main            = paste0("SCM Path Plot â€“ ", road_lbl),  # â† title here
  Ylab = "Weekly traffic",
  Xlab = "Week",
  Legend = legend_lbl,
  Legend.position = "bottomright"
)

# 1. íšŒìƒ‰ ê²©ìì„  -----------------------------------------------------------
abline(v = week_all, col = "grey90", lty = "dotted")

# 2. ì´ë²¤íŠ¸ ì •ì˜  â† ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨! --------------------------------------
event_pos <- c(n_pre + 1)        # x ì¢Œí‘œ
event_lty <- c(2)        # ì„  ì¢…ë¥˜
event_lab <- c("CCC launch")

# 3. ì„  + ë ˆì´ë¸” -----------------------------------------------------------
# (A) ìˆ˜ì§ì„ 
mapply(abline, v = event_pos, lty = event_lty)

# (B) ë ˆì´ë¸” â€“ ì„  ë°”ë¡œ ì•„ë˜, ê°€ë¡œ ê¸€ì”¨
y_lab <- par("usr")[3] + diff(par("usr")[3:4]) * 0.05   # yì¶• ìµœì €ê°’ì—ì„œ 5 % ìœ„
text(event_pos, y_lab,
     labels = event_lab,
     cex = 0.75,          # ê¸€ì”¨ í¬ê¸°
     adj = c(0.5, 1),     # ê°€ìš´ë°Â·ì•„ë˜ ì •ë ¬
     xpd = TRUE)

# 4. xì¶• ëˆˆê¸ˆ (êµµì€ ëˆˆê¸ˆë§Œ í‘œì‹œ) ------------------------------------------
axis(1, at = axTicks(1), labels = FALSE)              # ê¸°ë³¸ ëˆˆê¸ˆ ìˆ¨ê¸°ê³ 
axis(1, at = lab_major, labels = lab_major,           # ì£¼ìš” ëˆˆê¸ˆë§Œ ë‹¤ì‹œ
     las = 1, cex.axis = 0.8)



############################################################################
## 3-bis. ì‚¬ì „Â·ì‚¬í›„ RMSPE ë° Ratio ê³„ì‚°  â† â˜… ì¶”ê°€
############################################################################
pre_rmspe  <- sqrt(mean(gaps_main[ 1:n_pre            ]^2))
post_rmspe <- sqrt(mean(gaps_main[ (n_pre+1):n_all    ]^2))
ratio_main <- post_rmspe / pre_rmspe

cat(sprintf(
  "\nâ–¶ Baseline RMSPE  |  Pre = %.3f   Post = %.3f   Ratio = %.3f\n",
  pre_rmspe, post_rmspe, ratio_main
))


vline <- n_pre + 1  
# ê¹¨ë—í•œ ë²„ì „
path.plot(synth.res   = so_refined,
          dataprep.res= dp_refined,
          Main            = paste0("SCM Path Plot â€“ ", road_lbl),  # â† title here
          Ylab = "Weekly traffic", Xlab = "Week",
          Legend = legend_lbl,
          Legend.position = "bottomleft")
abline(v = n_pre + 1, lty = 2)               # ì •ì±…ì„ 
## â”€â”€ ë¼ë²¨ ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
text(
  x     = vline,                   # ë¬¸ì x ìœ„ì¹˜ = ì„  ìœ„ì¹˜
  y     = par("usr")[3] + 0.75*diff(par("usr")[3:4]),  # y = ì•„ë˜ìª½ì—ì„œ 5% ë†’ì´
  labels= "CCC Launch -> ",            # ì›í•˜ëŠ” ë¬¸êµ¬
  adj   = 1,                       # ê¸€ì”¨ ì™¼ìª½ì´ ì„ ê³¼ ë¶™ë„ë¡
  cex   = 0.75,                    # ê¸€ì”¨ í¬ê¸°
  xpd   = TRUE                     # í”Œë¡¯ ì˜ì—­ ë°–ì—ë„ ê·¸ë¦¬ê¸° í—ˆìš©
)

gaps.plot(synth.res   = so_refined,
          dataprep.res= dp_refined,
          Main            = paste0("Gap Plot â€“ ", legend_lbl2),  # â† title here
          Ylab = "Gap", Xlab = "Week")
abline(v = n_pre + 1, lty = 2)

## â”€â”€ ë¼ë²¨ ì¶”ê°€ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
text(
  x     = vline,                   # ë¬¸ì x ìœ„ì¹˜ = ì„  ìœ„ì¹˜
  y     = par("usr")[3] + 0.75*diff(par("usr")[3:4]),  # y = ì•„ë˜ìª½ì—ì„œ 5% ë†’ì´
  labels= "CCC Launch -> ",            # ì›í•˜ëŠ” ë¬¸êµ¬
  adj   = 1,                       # ê¸€ì”¨ ì™¼ìª½ì´ ì„ ê³¼ ë¶™ë„ë¡
  cex   = 0.75,                    # ê¸€ì”¨ í¬ê¸°
  xpd   = TRUE                     # í”Œë¡¯ ì˜ì—­ ë°–ì—ë„ ê·¸ë¦¬ê¸° í—ˆìš©
)

# 4ï¸âƒ£ ê°€ì¤‘ì¹˜Â·ë°¸ëŸ°ìŠ¤ (ì •ë¦¬ ë²„ì „)
syn_fix <- so_refined
syn_fix$solution.v <- as.numeric(syn_fix$solution.v)

stab <- synth.tab(dataprep.res = dp_refined,
                  synth.res   = so_refined,
                  round.digit = 10)

# ë„ë„ˆ ê°€ì¤‘ì¹˜ í…Œì´ë¸” í•œ ë²ˆë§Œ ìƒì„±
weights_tbl <- stab$tab.w %>%
  arrange(desc(w.weights))

print(weights_tbl, row.names = FALSE)



cat(sprintf(
  "\nâ–¶ Baseline RMSPE  |  Pre = %.3f   Post = %.3f   Ratio = %.3f\n",
  pre_rmspe, post_rmspe, ratio_main
))



att_pct <- mean(gaps_main[(n_pre+1):n_all])      # %-point ATT

baseline_pre <- df_scm %>%
  filter(
    unit_id    == treat_id,   # ì²˜ë¦¬ ëŒ€ìƒ ë„ë¡œ ID
    week_index <= n_pre             # ê°œì… ì´ì „ ì£¼(week)ë§Œ
  ) %>%
  summarise(pre_mean = mean(traffic, na.rm = TRUE)) %>%
  pull(pre_mean)

eff_final <- (att_pct/baseline_pre)*100

cat(sprintf(
  "\nâ–¶ Final RMSPE | Pre = %.3f   Post = %.3f   Ratio = %.3f | ATT = %.3f |ATT ratio =%.3f ",
  pre_rmspe, post_rmspe, ratio_main, att_pct, eff_final
))

goal_v <- baseline_pre*0.19775

cat(sprintf(
  "\nâ–¶ Traffic before treat = %.3f   Expected traffic = %.3f  diff = %.3f",
  baseline_pre,  goal_v, abs(goal_v-att_pct)
))




# weights ë²¡í„°(í•©ì´ 1ì¸ numeric)ë¥¼ ê°€ì •
library(tibble)
library(dplyr)

library(dplyr)

dispersion_metrics <- weights_tbl %>% 
  summarise(
    max_w      = max(w.weights),           # ìµœëŒ€ ê°€ì¤‘ì¹˜
    N_eff      = 1 / sum(w.weights^2),     # íš¨ê³¼ì  ë„ë„ˆ ìˆ˜
    HHI        = 10000 * sum(w.weights^2), # Herfindahl Index
    top2_share = sum(sort(w.weights, decreasing = TRUE)[1:2]),
    top3_share = sum(sort(w.weights, decreasing = TRUE)[1:3]),
    top4_share = sum(sort(w.weights, decreasing = TRUE)[1:4])
  )

print(dispersion_metrics)

```

#index cal



```{r}
# 1) Compute the SD of the treated series in the pre-period
sd_pre <- df_scm %>%
  filter(unit_id == treat_id, week_index <= n_pre) %>%
  pull(traffic) %>%
  sd(na.rm = TRUE)

# 2) Back-transform your metrics
pre_rmspe_orig   <- pre_rmspe   * sd_pre
post_rmspe_orig  <- post_rmspe  * sd_pre
att_orig         <- att_pct     * sd_pre      # if att_pct is ATT in same units
eff_orig         <- eff_final   * sd_pre      # if eff_final is ATT ratio in same units

# (Ratio and percentageâ€based metrics stay the same)
ratio_main_orig  <- ratio_main    # unchanged
att_ratio_orig   <- att_pct / pre_rmspe  # if you want the ATT/RMSPE ratio

# 3) Print with your original scale
cat(sprintf(
  "\nâ–¶ Original-scale RMSPE | Pre = %.1f   Post = %.1f   Ratio = %.3f",
  pre_rmspe_orig, post_rmspe_orig, ratio_main_orig
))
cat(sprintf(
  "\nâ–¶ Original-scale ATT  = %.1f   ATT-to-RMSPE ratio = %.3f",
  att_orig, att_orig / pre_rmspe_orig
))
```


#SCM ê²°ê³¼ 
#=========


```{r}
# (a) ordinary predictors
pred_idx   <- dp_refined$tag$predictors
pred_names <- colnames(df_scm)[ pred_idx ]

# (b) special predictors with time labels
sp         <- dp_refined$tag$special.predictors
sp_names   <- vapply(sp, function(x){
  var   <- x[[1]]
  times <- x[[2]]
  stat  <- x[[3]]
  if(length(times)==1){
    paste(var, stat, paste0("w", times), sep="_")
  } else {
    paste(var, stat, paste0("w", min(times), "-w", max(times)), sep="_")
  }
}, character(1))

# (c) í•©ì¹˜ê¸°
all_names <- c(pred_names, sp_names)

# (d) v-weights í…Œì´ë¸” ìƒì„±
imp <- data.frame(
  predictor = all_names,
  weight    = as.numeric(so_refined$solution.v)
)
imp <- imp[order(-imp$weight), ]
print(imp)
```

```{r}
# 1) ì‚¬ì „(outcome) í–‰ë ¬ êº¼ë‚´ê¸°
Y0      <- dp_refined$Y0plot          # í–‰ = ì£¼, ì—´ = ë„ë„ˆ ìœ ë‹›
unit_id <- dp_refined$tag$controls.identifier
colnames(Y0) <- unit_id               # ì—´ ì´ë¦„ ë¶™ì´ê¸°

# 2) ìƒê´€í–‰ë ¬ ê³„ì‚°
corr_mat <- cor(Y0, use = "pairwise.complete.obs")

# 3) 0.95 ì´ìƒ ìƒê´€ì¸ ìŒ ì°¾ê¸°
high_idx <- which(corr_mat > 0.95 & corr_mat < 1, arr.ind = TRUE)

dup_df <- data.frame(
  row_idx  = high_idx[, "row"],
  col_idx  = high_idx[, "col"],
  unit_row = rownames(corr_mat)[high_idx[, "row"]],
  unit_col = colnames(corr_mat)[high_idx[, "col"]]
) 


dup_df <- dup_df %>% 
  filter(unit_row != unit_col) %>%   # ê°™ì€ ID í–‰ ì œê±°
  filter(row_idx < col_idx)          # ëŒ€ì¹­ ì¤‘ë³µ ì œê±°


# (1) corr_mat ì´ë¯¸ ë§Œë“¤ì–´ ë‘” ìƒíƒœì—ì„œ â”€â”€â”€â”€
hi <- which(corr_mat > 0.95 & upper.tri(corr_mat), arr.ind = TRUE)

# (2) ì¸ë±ìŠ¤ë¥¼ IDë¡œ ë³€í™˜
pairs_high <- tibble(
  id_a = rownames(corr_mat)[hi[, "row"]],
  id_b = colnames(corr_mat)[hi[, "col"]],
  rho  = corr_mat[hi]                     # ì‹¤ì œ ìƒê´€ê°’
)

print(pairs_high)
```

```{r}
orig_id <- dp_refined$tag$controls.identifier      # ì˜ˆ: "34_..."
cur_id  <- colnames(dp_refined$Y0plot)             # ì—´ ì´ë¦„ì— ë¶™ì–´ìˆëŠ” ID

# ìˆ«ì ë¶€ë¶„ë§Œ ì¶”ì¶œ
get_num <- function(x) as.integer(sub("^([0-9]+).*", "\\1", x))

delta <- get_num(orig_id) - get_num(cur_id)
table(delta)
```



```{r}
library(ggplot2)
library(dplyr)

dup_df_adj <-dup_df %>% 
  mutate(
    unit_row = str_replace(
      unit_row,               # ë³€í™˜ ëŒ€ìƒ ì—´
      "^([0-9]+)",            # ID ë§¨ ì• ì—°ì† ìˆ«ì ìº¡ì²˜
      ~ as.character(as.integer(.x) - 13)   # 13 ë¹¼ê³  ë¬¸ìë¡œ
    ),
    unit_col = str_replace(
      unit_col,
      "^([0-9]+)",
      ~ as.character(as.integer(.x) - 13)
    )
  )
```



```{r}
u1 <- "59"  # ì˜ˆì‹œ ID
u2 <- "36"                                        # ì‹¤ì œ ID

ts1 <- df_scm %>% filter(unit_id == u1, week_index <= 50) %>% pull(traffic)
ts2 <- df_scm %>% filter(unit_id == u2, week_index <= 50) %>% pull(traffic)

# ê²¹ì¹˜ëŠ” ì£¼ ìˆ˜
sum(!is.na(ts1) & !is.na(ts2))

# ìƒê´€ê°’
cor(ts1, ts2, use = "complete.obs")
```

###placebos

```{r}
# 1ï¸âƒ£ SCtools ë¡œë“œ
library(SCtools)
set.seed(2025)     
# dp_final, so_final ì€ ì•ì„œ ë§Œë“  ìµœì¢… dataprep & synth ê²°ê³¼ì…ë‹ˆë‹¤.

# 2ï¸âƒ£ placebo í•©ì„±ëŒ€ì¡°êµ° ìƒì„±
#    - Sigf.ipop: ipop ìµœì í™” ì •ë°€ë„ (ê¸°ë³¸ 5)
#    - strategy: "sequential" ë˜ëŠ” ë³‘ë ¬ "multiprocess"
placebos_refined_ipop5 <- generate.placebos(
  dataprep.out = dp_refined,
  synth.out    = so_refined,
  Sigf.ipop    = 2,
  strategy     = "sequential"
)  
# â†’ ë°˜í™˜ê°’(placebos)ì€ tdf ê°ì²´ë¡œ, ì›ë³¸ ì²˜ë¦¬êµ°ê³¼ ê° placeboì˜ Y & Y_synth ì‹œê³„ì—´, 
#    ì‚¬ì „ MSPE(mspe.placs) ë“±ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤  

# 3ï¸âƒ£ placebo ë¶„í¬ í”Œë¡¯
#    - plot_placebos(): ëª¨ë“  placebo gap + ì²˜ë¦¬êµ° gapì„ ì¼ê´„ ì‹œê°í™”
plot_placebos(placebos_refined_ipop5)  

# 4ï¸âƒ£ MSPE test (p-value ê³„ì‚°)
test_out_refined <- mspe.test(placebos_refined_ipop5)
cat("â–¶ Final p-value =", round(test_out_refined$p.val, 3), "\n")  

beep(5)

```


```{r}
# â¶ MSPE test: pre-MSPE > 5Ã— ì¸ í”Œë¼ì‹œë³´ ì œì™¸ í›„ p-ê°’ ê³„ì‚°
test_out_refinedx5 <- mspe.test(placebos_refined_ipop5,
                      discard.extreme = TRUE,   # â† í•„í„° ì¼œê¸°
                      mspe.limit      = 5)      # â† 5 ë°° ê¸°ì¤€
cat("â–¶ filtered p-value =", round(test_out_refinedx5$p.val, 6), "\n")

# â· MSPE ratio í”Œë¡¯(ì /íˆìŠ¤í† ê·¸ë¨)ë„ ë™ì¼ ì˜µì…˜
mspe.plot(placebos_refined_ipop5,
          discard.extreme = TRUE,
          mspe.limit      = 5)

# â¸ gap ê¶¤ì  í”Œë¡¯(plot_placebos) ì—­ì‹œ ë™ì¼ ì¸ì ì‚¬ìš© ê°€ëŠ¥
plot_placebos(placebos_refined_ipop5,
              discard.extreme = TRUE,
              mspe.limit      = 5)
```

#covariates table

```{r}
# 1) ì²˜ë¦¬ëœ dataprep ê²°ê³¼ê°€ dp_refined ë¼ëŠ” ê°€ì •í•˜ì—
#    X1: ì‹¤ì œ(ì²˜ë¦¬êµ°) ì˜ˆì¸¡ ë³€ìˆ˜ í‰ê·  (í–‰: ë³€ìˆ˜, ì—´: 1)
#    X0: ëŒ€ì¡°êµ° ì˜ˆì¸¡ ë³€ìˆ˜ í‰ê·   (í–‰: ë³€ìˆ˜, ì—´: ê° donor)

# 2) ì‹¤ì œ í‰ê·  ë²¡í„°
real_means <- as.vector(dp_refined$X1)  # ê¸¸ì´ 34

# 3) í•©ì„±(ê°€ì¤‘ í‰ê· ) ì˜ˆì¸¡ ë³€ìˆ˜ í‰ê· 
w <- so_refined$solution.w              # Donorë³„ í•©ì„± ê°€ì¤‘ì¹˜ (ê¸¸ì´ 47)
synthetic_means <- as.vector(dp_refined$X0 %*% w)  # 34 Ã— 47  %*% 47Ã—1 â†’ 34Ã—1

# 4) ëŒ€ì¡°êµ° ì „ì²´ í‰ê·  (ë‹¨ìˆœ í‰ê· )
control_means <- rowMeans(dp_refined$X0) # ê¸¸ì´ 34

# 5) ë³€ìˆ˜ ì´ë¦„
vars <- rownames(dp_refined$X0)          # "lanes.max", "speed.max", ...

# 6) ìš”ì•½ í…Œì´ë¸” ìƒì„±
summary_table <- data.frame(
  Variable  = vars,
  Real      = round(real_means,      2),
  Synthetic = round(synthetic_means, 2),
  Control   = round(control_means,   2),
  row.names = NULL
)

knitr::kable(
  summary_table,
  caption = paste0(legend_lbl2, ": Predictor Means")
)

```

####ë‹¨ì¸¡ê²€ì •




```{r}
library(dplyr)

## 1ï¸âƒ£ ë©”íƒ€ ì •ë³´
meta_df <- placebos_refined_ipop5$names.and.numbers        # unit.numbers, unit.names

## 2ï¸âƒ£ pre-MSPE ë²¡í„° ë§Œë“¤ê¸°  (ì´ë¦„ = unit.numbers, ê°’ = pre-MSPE)
mspe_vec <- setNames(
  placebos_refined_ipop5$mspe.placs[[1]],                  # data-frame â†’ ë²¡í„°
  meta_df$unit.numbers                       # ë™ì¼í•œ í–‰ìˆœì„œ í™œìš©
)

## 3ï¸âƒ£ ì²˜ë¦¬ ë„ë¡œ pre-MSPE
mspe_treat <- as.numeric(placebos_refined_ipop5$loss.v)     # scalar

## 4ï¸âƒ£ 5 ë°° ì»·ì˜¤í”„ ì´ˆê³¼ í”Œë¼ì‹œë³´ ID
bad_ids <- names(mspe_vec)[ mspe_vec > 5 * mspe_treat ] |>
           as.numeric()                      # ìˆ«ìí˜•ìœ¼ë¡œ

## 5ï¸âƒ£ ì œì™¸ëœ ìœ ë‹›(ë„ë¡œ) ëª©ë¡
excluded_units <- meta_df %>%
  filter(unit.numbers %in% bad_ids) %>% print() %>% pull(unit.numbers)

print(excluded_units)
```


```{r}
library(stringr)
# 3) ID ë²¡í„° ë½‘ê¸° ------------------------------
treated_id  <- placebos_refined_ipop5$tr                    # ì‹¤ì œ treated ë²ˆí˜¸
control_ids <- c(placebos_refined_ipop5[["names.and.numbers"]][["unit.numbers"]])

## 0) convenience variables ---------------------------------
treated_id  <- placebos_refined_ipop5$tr
t1_row      <- placebos_refined_ipop5$t1          # first post-period row index

## 1) reshape ------------------------------------------------

# (2) wide â†’ long ë³€í™˜ -------------------------------------------
placebos_refined_ipop5_long <- placebos_refined_ipop5$df 

plb_long<- placebos_refined_ipop5_long %>%                 # 91 Ã— 95 (ì˜ˆì‹œ)
  rename(week_index = "year") %>%
  mutate(week_index = as.integer(week_index)) %>% 
  pivot_longer(                             # unitë³„ë¡œ ì„¸ë¡œë¡œ ë…¹ì´ê¸°
    -week_index,
    names_to  = "unit_id",
    values_to = "value"
  ) %>% 
  mutate(
    unit_id = as.character(unit_id),          # ë¬¸ì â†’ ì •ìˆ˜
    post    = week_index >= t1_row          # ì‚¬í›„ êµ¬ê°„ í”Œë˜ê·¸
  )

gap_long <- plb_long %>% 
  mutate(
    type    = if_else(str_starts(unit_id, "synthetic\\."), "synthetic", "obs"),
    unit_id = str_remove(unit_id, "^synthetic\\.")   # ìˆ«ìë§Œ ë‚¨ê¹€
  ) %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  mutate(
    gap = obs - synthetic      # (ìŒìˆ˜ â†’ êµí†µëŸ‰ ê°ì†Œ)
  ) %>%
  filter(!unit_id %in% excluded_units)

treated_id <- "Y1"                 # ë˜ëŠ” 41 ë“±
control_ids <- gap_long %>% 
  filter(!str_detect(unit_id, "[^0-9]")) %>%   # ìˆ«ìë§Œ
  distinct(unit_id) %>% 
  pull(unit_id) %>% 
  setdiff(treated_id)

# â‘  treated ë‹¨ì¸¡ í†µê³„ëŸ‰ (ê°ì†Œë©´ ìŒìˆ˜)
stat_treat <- gap_long %>% 
  filter(unit_id == treated_id, post) %>% 
  summarise(stat = sum(gap, na.rm = TRUE)) %>% 
  pull(stat)

# â‘¡ ì»¨íŠ¸ë¡¤(placebo) í†µê³„ëŸ‰
placebo_stats <- gap_long %>% 
  filter(unit_id %in% control_ids, post) %>% 
  group_by(unit_id) %>% 
  summarise(stat = sum(gap, na.rm = TRUE)) %>% 
  pull(stat)

# â‘¢ â€˜ê°ì†Œâ€™ ë°©í–¥ ë‹¨ì¸¡ p-value
p_one <- (1 + sum(placebo_stats <= stat_treat)) /
         (1 + length(placebo_stats))


p_one
```
#===
#ë‹¨ì¸¡ê²€ì • íˆìŠ¤í† ê·¸ë¨

```{r}
# 1) í•„ìš”í•œ íŒ¨í‚¤ì§€ ë¡œë“œ
library(ggplot2)

# 2) ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜
df_plot_placebos_refined_ipop5 <- data.frame(
  stat = placebo_stats
)

# 3) íˆìŠ¤í† ê·¸ë¨ + ì²˜ë¦¬êµ¬ê°„ í†µê³„ëŸ‰ í‘œì‹œ
p_placebos_refined_ipop5 <- ggplot(df_plot_placebos_refined_ipop5, aes(x = stat)) +
  geom_histogram(binwidth = diff(range(df_plot_placebos_refined_ipop5$stat)) / 30,
                 fill = "grey80", color = "white") +
  geom_vline(xintercept = stat_treat,
             color = "red", size = 1) +
  labs(
    title = "Placebo P-value Histogram (One tale? negative)",
    subtitle = paste0("One tale p-value = ",
                      round(p_one, 5)),
    x = "Post Gap Sum(statistic)",
    y = "Placebos"
  ) +
  theme_minimal()

# 4) ì¶œë ¥
print(p_placebos_refined_ipop5)

```
```{r}
library(dplyr)

# 1) post-treatment êµ¬ê°„ì˜ gap í•©ê³„ ê³„ì‚°
post_sum <- gap_long %>%
  filter(post == TRUE) %>%                     # post==TRUE ì¸ í–‰ë§Œ
  group_by(unit_id) %>%                       
  summarise(stat = sum(gap, na.rm = TRUE))    # gap í•©ê³„

# 2) ìµœì†Œ stat ì— í•´ë‹¹í•˜ëŠ” unit_id ì¶”ì¶œ
min_unit <- post_sum %>%
  slice_min(stat, n = 1) %>%  # stat ê¸°ì¤€ ìµœì†Œ 1ê°œ
  pull(unit_id)

# 3) lookup_tbl ì—ì„œ í•´ë‹¹ unit_id ë¡œ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
result <- lookup_tbl %>%
  filter(unit_id == min_unit)

print(result)
```




```{r}
# 1) names(placebo_stats) ì— ë„ë¡œ ì´ë¦„ ë¶™ì´ê¸°
#    test_out_refined$test ì˜ ì²« ë²ˆì§¸ í–‰ì´ ì²˜ë¦¬êµ°ì´ë¯€ë¡œ, ê·¸ ì´í›„ê°€ í”Œë¼ì‹œë³´ # 1) í•„ìš”í•œ íŒ¨í‚¤ì§€ ë¡œë“œ
library(dplyr)

# 2) ì‚¬í›„ êµ¬ê°„ ì •ì˜
#    dp_refined$dataprep.out$treatment_time ì— treatment ì£¼ê¸°ê°€ ì €ì¥ë˜ì–´ ìˆì„ ê±°ì˜ˆìš”.
t0 <- dp_refined$dataprep.out$treatment_time

# 3) unit_idë³„ë¡œ post-treatment gap í•©ê³„(stat) ê³„ì‚°
post_sums <- gap_long %>%
  filter(week_index > t0) %>%            # ì‚¬í›„ ì£¼ì°¨ë§Œ
  group_by(unit_id) %>%
  summarize(stat = sum(gap, na.rm = TRUE))

# 4) ê°€ì¥ ì‘ì€ statë¥¼ ê°–ëŠ” ìœ ë‹› ì°¾ê¸°
min_post <- post_sums %>% slice_min(stat, n = 1)

# 5) unit_id â†’ ë„ë¡œëª…(routeNM) ë§¤í•‘
#    ì›ë³¸ ë°ì´í„°í”„ë ˆì„(df_scm)ì— unit_idë³„ routeNMì´ ë“¤ì–´ìˆë‹¤ê³  ê°€ì •
unit_route <- df_scm %>% 
  select(unit_id, routeNM) %>% 
  distinct()

min_post %>%
  left_join(unit_route, by = "unit_id") -> result

# 6) ê²°ê³¼ ì¶œë ¥
print(result)
```


# â”€â”€â”€ Leave-One-Out Sensitivity â”€â”€â”€

```{r}

n_pre <- 50     # length of pre-treatment period (weeks)
threshold <- 150   # Î”ATT magnitude for labelling
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€


## Baseline ATT and pre-RMSPE
att_baseline    <- mean(gaps_main[(n_pre+1):length(gaps_main)])
pre_rmspe_full  <- sqrt(mean(gaps_main[1:n_pre]^2))

cat("Baseline ATT       =", round(att_baseline, 1), "veh/day\n")
cat("Baseline pre-RMSPE =", round(pre_rmspe_full, 2), "\n\n")


# â”€â”€ 2.  Leave-one-out loop  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loo_att <- numeric(length(donor_ok_ids))
loo_pre <- numeric(length(donor_ok_ids))
names(loo_att) <- names(loo_pre) <- donor_ok_ids   # keep IDs as names

for (excluded in donor_ok_ids) {

  donors_loo <- setdiff(donor_ok_ids, excluded)

  res <- tryCatch({
    dp_loo <- do.call(dataprep,
                      modifyList(dp_params,
                                 list(controls.identifier = donors_loo)))
    so_loo <- synth(dp_loo)

    gaps <- dp_loo$Y1plot - drop(dp_loo$Y0plot %*% so_loo$solution.w)

    c(pre = sqrt(mean(gaps[1:n_pre]^2)),
      att = mean(gaps[(n_pre+1):length(gaps)]))

  }, error = function(e) c(pre = NA, att = NA))  # graceful fail

  loo_pre[as.character(excluded)] <- res["pre"]
  loo_att[as.character(excluded)] <- res["att"]
}

# â”€â”€ 3.  Tidy results tibble  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
loo_df <- tibble(
  donor_id   = names(loo_att),
  att        = loo_att,
  pre_rmspe  = loo_pre
) %>%
  mutate(
    label       = ifelse(abs(att - att_baseline) > threshold, donor_id, ""),
    big_pre_err = pre_rmspe > 5 * pre_rmspe_full
  )

print(loo_df, n = Inf)   # full table at a glance


# â”€â”€ 4.  Bar plot with highlights  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ggplot(loo_df,
       aes(x = reorder(donor_id, att), y = att, fill = big_pre_err)) +
  geom_col(show.legend = FALSE) +
  scale_fill_manual(values = c(`TRUE` = "tomato", `FALSE` = "grey70")) +
  geom_hline(yintercept = att_baseline, colour = "red", linetype = 2) +
  geom_text(aes(label = label),
            vjust = ifelse(att < 0, 1.2, -0.2),
            size  = 3, fontface = "bold") +
  coord_flip() +
  labs(x = NULL,
       y = "ATT (post-treatment average gap, veh/day)",
       title = "Leave-One-Out Sensitivity â€“ ATT by Donor") +
  theme_minimal(base_size = 12)

#  Optionally use ggrepel to avoid overlaps:
#  + ggrepel::geom_text_repel(aes(label = label), size = 3, direction = "y")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#  End of script
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

```{r}
ggplot(loo_df,
       aes(x = att, y = reorder(donor_id, att), fill = big_pre_err)) +
  geom_col(width = 0.9, colour = "grey25", linewidth = 0.3, show.legend = FALSE) +
  geom_vline(xintercept = att_baseline, colour = "red", linetype = 2, linewidth = 0.7) +
  geom_text(aes(label = label),
            hjust = -0.05, vjust = 0.5,
            size = 3, fontface = "bold") +
  scale_x_continuous(expand = expansion(mult = c(0.05, 0.05))) +
  scale_fill_manual(values = c(`TRUE` = "tomato", `FALSE` = "grey70")) +
  labs(title = "Leave-One-Out Sensitivity â€“ ATT by Donor",
       x = "ATT (post-treatment avg gap, veh/day)",
       y = NULL) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.y = element_text(size = 7)   # â† ì™¼ìª½ ê¸€ì”¨(ë„ë„ˆ ID)ë§Œ ì‘ê²Œ
  )
```


```{r}
# loo_df: donor_id, att, pre_rmspe, weight ê°€ ìˆëŠ” ë°ì´í„°í”„ë ˆì„

baseline <- mean(gaps_main[(n_pre+1):length(gaps_main)])

loo_df1 <- loo_df %>%            # ì´ë¯¸ ê°–ê³  ìˆëŠ” í…Œì´ë¸”
  mutate(
    delta   = att - baseline,   # ë¹ ì¡Œì„ ë•Œ ë³€í™”ëŸ‰
    signflip= sign(att) != sign(baseline)
  )

loo_df1       <- loo_df1       %>% mutate(donor_id  = as.integer(donor_id))
weights_tbl2  <- weights_tbl  %>% mutate(unit.numbers = as.integer(unit.numbers))


loo_df2 <- loo_df1 %>% 
  left_join(weights_tbl2 , by = c("donor_id"="unit.numbers"))


thr <- 3 * mad(loo_df2$delta, constant = 1)  


bad <- loo_df2 %>% 
  filter(abs(delta) > thr | signflip) %>%        # 1ì°¨ í•„í„°
  arrange(desc(abs(delta))) %>%                  # ì˜í–¥ë ¥ í° ìˆœ
  filter(w.weights > 0.05 | pre_rmspe > median(pre_rmspe))  # ì¶”ê°€ ê¸°ì¤€

bad
bad %>% pull(donor_id) %>% toString()
```


#------------------------
#in_time_placebo
#------------------------



```{r}
library(beepr)
library(Synth)

options(scipen = 999)

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## 1. ë„ë„ˆ í’€ í™•ì • (treat_id ì œì™¸)
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
donor_ids_final <- df_scm %>% 
  filter(unit_id >= 15, !unit_id %in% c(15, 31)) %>% 
  distinct(unit_id) %>% 
  pull(unit_id)

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## 2. dataprep
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
dp_in_time <- do.call(
  dataprep,
  list(
    foo                   = as.data.frame(df_scm),
    predictors            = good_preds_o,
    predictors.op         = "mean",
    special.predictors    = sp_2_in_time,   # ë°˜ë“œì‹œ 1~20ì£¼ë§Œ í¬í•¨
    dependent             = "traffic",
    unit.variable         = "unit_id",
    unit.names.variable   = "unit_name_en",
    time.variable         = "week_index",
    treatment.identifier  = treat_id,
    controls.identifier   = donor_ids_final,
    time.predictors.prior = 1:20,           # â† n_pre = 20
    time.optimize.ssr     = 1:20,
    time.plot             = 1:70            # â† n_all = 70
  )
)

so_in_time <- synth(dp_in_time)

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## 3. GAP ê³„ì‚°
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
gaps_in_time <- dp_in_time$Y1plot -
                drop(dp_in_time$Y0plot %*% so_in_time$solution.w)

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## 4. ê·¸ë˜í”„
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
path.plot(
  synth.res    = so_in_time,
  dataprep.res = dp_in_time,
  Main         = paste0("In-Time Placebos â€“ ", road_lbl),
  Ylab         = "Weekly traffic",
  Xlab         = "Week",
  Legend       = legend_lbl,
  Legend.position = "bottomright"
)
abline(v = 21, lty = 2)  # 20ì£¼ ì´í›„(ì •ì±…ì„ )

text(
  x     = 21,
  y     = par("usr")[3] + 0.75 * diff(par("usr")[3:4]),
  labels= "CCC launch  \n(counterfactual) \n2023-06-19 â†’ 

",
  adj   = 1, cex = 0.75, xpd = TRUE
)

gaps.plot(
  synth.res    = so_in_time,
  dataprep.res = dp_in_time,
  Ylab         = "Gap",
  Xlab         = "Week"
)
abline(v = 21, lty = 2)

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## 5. RMSPE Â· ATT
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
pre_rmspe_in_time  <- sqrt(mean(gaps_in_time[1:20]^2))
post_rmspe_in_time <- sqrt(mean(gaps_in_time[21:70]^2))
ratio_in_time      <- post_rmspe_in_time / pre_rmspe_in_time

att_pct1in_time <- mean(gaps_in_time[21:70])

baseline_prein_time <- df_scm %>% 
  filter(unit_id == treat_id, week_index <= 20) %>% 
  summarise(pre_mean = mean(traffic, na.rm = TRUE)) %>% 
  pull(pre_mean)

eff_final1in_time <- (att_pct1in_time / baseline_prein_time) * 100

cat(sprintf(
  "\nâ–¶ Final RMSPE | Pre = %.3f   Post = %.3f   Ratio = %.3f | ATT = %.3f | ATT/Pre = %.3f%%",
  pre_rmspe_in_time, post_rmspe_in_time, ratio_in_time,
  att_pct1in_time,    eff_final1in_time
))

goal_v1in_time <- baseline_prein_time * 0.19775

cat(sprintf(
  "\nâ–¶ Traffic before treat = %.3f   Expected traffic = %.3f   diff = %.3f",
  baseline_prein_time, goal_v1in_time, abs(goal_v1in_time - att_pct1in_time)
))

## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
## 6. ê°€ì¤‘ì¹˜ í…Œì´ë¸”
## â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
stab_in_time <- synth.tab(
  dataprep.res = dp_in_time,
  synth.res    = so_in_time,
  round.digit  = 10
)
weights_final_tbl_in_time <- stab_in_time$tab.w %>% 
  arrange(desc(w.weights))
print(weights_final_tbl_in_time, row.names = FALSE)

beep(5)            # ì™„ë£Œ ì•Œë¦¼
```




##restricting the donor pool to units with similar values in the predictors
#========================================

```{r}
library(dplyr)
library(tibble)
library(Synth)

# â€” (A) ì •ì±… ì´í›„ë§Œ ì“´ predictor í…Œì´ë¸” â€”
pred_tbl_post <- df_scm %>%
  filter(unit_id %in% c(donor_ok_ids, treat_id),
         week_index > n_pre) %>%
  group_by(unit_id) %>%
  summarise(
    across(c(all_of(good_preds_o), traffic, speed),
           ~ median(.x, na.rm = TRUE))
  ) %>%
  ungroup()

# â€” (B) ê±°ë¦¬ ê³„ì‚°ìš© í–‰ë ¬ & ë²¡í„° â€”
unit_ids <- pred_tbl_post$unit_id
X_mat    <- pred_tbl_post %>% select(-unit_id) %>% as.matrix()
treat_vec<- pred_tbl_post %>%
              filter(unit_id == treat_id) %>%
              select(-unit_id) %>%
              as.numeric()

dists <- apply(X_mat, 1, function(x) sqrt(sum((x - treat_vec)^2)))

dist_df <- tibble(unit_id = unit_ids, dist = dists) %>%
  arrange(dist) %>%
  filter(unit_id != treat_id)

# â€” (C) Decile ë¶„ìœ„ìˆ˜ì— ë”°ë¥¸ K_list (10%,20%,â€¦100%) â€”
qs     <- quantile(dist_df$dist, probs = seq(0.1, 1, by = 0.1), na.rm = TRUE)
K_list <- sapply(qs, function(q) max(which(dist_df$dist <= q)))

# ê²°ê³¼ í™•ì¸
print(K_list)

# â€” (D) 10% ë‹¨ìœ„(decile) ê·¸ë£¹ ì»¬ëŸ¼ (í•„ìš” ì‹œ) â€”
dist_df_q <- dist_df %>%
  mutate(
    decile = ntile(dist, 10),
    decile = factor(decile, levels = 1:10,
                    labels = paste0(seq(0, 90, 10), "-", seq(10, 100, 10), "%"))
  )

# â€” (E) safe_synth ë˜í¼ (ì‹¤íŒ¨ ì‹œ NULL ë¦¬í„´) â€”
safe_synth <- function(dp_obj) {
  tryCatch(synth(dp_obj),
           error = function(e) {
             warning("âš  synth() failed: ", e$message)
             NULL
           })
}

# â€” (F) K_list ìˆœíšŒí•˜ë©´ì„œ SCM ì‹¤í–‰ & ê²°ê³¼ ìˆ˜ì§‘ â€”
results <- tibble(K = integer(), pre_RMSPE = double(), post_RMSPE = double(), ratio = double())

orig_preds <- dp_params$predictors    # ì›ë˜ ì“°ì‹œë˜ predictors ë¦¬ìŠ¤íŠ¸

for (K in K_list) {
  controls_k <- head(dist_df$unit_id, K)
  
  # 1) ë¶„ì‚°ì´ 0ì¸ predictor ìë™ ì œê±°
  vars <- sapply(orig_preds, function(p) {
    vals <- pred_tbl_post %>% filter(unit_id %in% controls_k) %>% pull(!!sym(p))
    var(vals, na.rm = TRUE)
  })
  preds_ok <- orig_preds[vars > 0]
  if (length(preds_ok) == 0) {
    warning("ëª¨ë“  predictorê°€ ìƒìˆ˜ì…ë‹ˆë‹¤. K=", K, " ê±´ë„ˆëœë‹ˆë‹¤.")
    next
  }
  
  # 2) dataprep ì¸ì ë®ì–´ì“°ê¸°
  dp_args <- modifyList(dp_params, list(
    controls.identifier = controls_k,
    predictors           = preds_ok
  ))
  dp_k <- do.call(dataprep, dp_args)
  
  # 3) synth í˜¸ì¶œ (ì‹¤íŒ¨í•´ë„ ë£¨í”„ ê³„ì†)
  so_k <- safe_synth(dp_k)
  if (is.null(so_k)) next
  
  # 4) gap ê³„ì‚° ë° RMSPE
  gaps_k  <- dp_k$Y1plot - dp_k$Y0plot %*% so_k$solution.w
  pre_k   <- sqrt(mean(gaps_k[1:n_pre       ]^2, na.rm = TRUE))
  post_k  <- sqrt(mean(gaps_k[(n_pre+1):n_all]^2, na.rm = TRUE))
  
  # 5) ê²°ê³¼ ìˆ˜ì§‘
  results <- results %>%
    add_row(K = K, pre_RMSPE = pre_k, post_RMSPE = post_k, ratio = post_k / pre_k)
}

print(results)
```

```{r}
filtered_one <- dist_df_q[1:47,] %>% pull(unit_id)
```



#ê²°ê³¼ ê°’ìœ¼ë¡œ SCM ë‹¤ì‹œ ëŒë¦¬ê¸°.
#=====================

#SCM ë£¨í”„, ê¸°ì—¬ë„ê°€ ë‚®ì€ ê²ƒì„ í•˜ë‚˜ì”© ë¹¼ë©´ì„œ, rmspeê°€ ë‚®ì€ì±„ë¡œ ë„ë„ˆí’€ì„ ìµœëŒ€í•œ ì¤„ì—¬ë³¸ë‹¤.
#=====================

```{r}
library(Synth)
library(dplyr)

# â€” 0. íŒŒë¼ë¯¸í„° ì„¤ì • â€”
treat_id   <- 42
max_rmspe  <- 535
available_ids <- filtered_one   # ì´ˆê¸° ë„ë„ˆ í’€

# â€” 1. ê³µí†µ dataprep íŒŒë¼ë¯¸í„° â€”
common_dp_params <- list(
  foo                   = as.data.frame(df_scm),
  predictors            = good_preds_new,
  predictors.op         = "mean",
  special.predictors    = sp_2_all,  #sp_all_1wk,
  dependent             = "traffic",
  unit.variable         = "unit_id",
  unit.names.variable   = "unit_name",
  time.variable         = "week_index",
  treatment.identifier  = treat_id,
  time.predictors.prior = 1:n_pre,
  time.optimize.ssr     = 1:n_pre,
  time.plot             = 1:n_all
)

# â€” 2. ê²°ê³¼ ì €ì¥ìš© tibble ì´ˆê¸°í™” â€”
results_tbl <- tibble(
  iter        = integer(),
  n_donors    = integer(),
  pre_rmspe   = double(),
  post_rmspe  = double(),
  removed_id  = integer(),
  rate        = double()       # â† ì—¬ê¸°
)


# â€” 3. ë°˜ë³µ ì‹¤í–‰ â€”
iteration <- 0
repeat {
  iteration <- iteration + 1

  # 3-1) dataprep with current donor pool
  params_current <- modifyList(common_dp_params,
                                list(controls.identifier = available_ids))
  dp_current <- do.call(dataprep, params_current)

  # 3-2) í•©ì„±ëŒ€ì¡°êµ° ì í•©
  synth_current <- synth(data.prep.obj = dp_current)

  # 3-3) ê°„ê·¹ ê³„ì‚°
  gaps_current <- dp_current$Y1plot - (dp_current$Y0plot %*% synth_current$solution.w)

  # 3-4) pre/post RMSPE ê³„ì‚°
  pre_rmspe_val  <- sqrt(mean(gaps_current[1:n_pre]^2, na.rm = TRUE))
  post_rmspe_val <- sqrt(mean(gaps_current[(n_pre+1):n_all]^2, na.rm = TRUE))


  # 3-5) ê°€ì¥ ì‘ì€ ê°€ì¤‘ì¹˜ ë„ë„ˆ í•œ ëª… ì„ íƒ
  stab_current   <- synth.tab(dataprep.res = dp_current, synth.res = synth_current)
  remove_id      <- stab_current$tab.w %>%
                      arrange(w.weights) %>%
                      slice(1) %>%
                      pull(unit.numbers)

  # 3-6) ê²°ê³¼ ê¸°ë¡
results_tbl <- results_tbl %>%
  add_row(
    iter       = iteration,
    n_donors   = length(available_ids),
    pre_rmspe  = pre_rmspe_val,
    post_rmspe = post_rmspe_val,
    removed_id = remove_id,
    rate       = post_rmspe / pre_rmspe     # â† ê³„ì‚°ëœ rate
  )

  message(
    "Iter ", iteration,
    " | pre-RMSPE=", round(pre_rmspe_val,2),
    " post-RMSPE=", round(post_rmspe_val,2),
    " | removed: ", remove_id
  )

  # â€” 3-7) ì¤‘ë‹¨ ì¡°ê±´ â€”
  if (pre_rmspe_val > max_rmspe) {
    message("Stopping: pre-RMSPE > ", max_rmspe)
    break
  }
  if (length(remove_id) == 0) {
    message("Stopping: no more donors to remove")
    break
  }

  # 3-8) ë„ë„ˆ í’€ì—ì„œ ì œê±°
  available_ids <- setdiff(available_ids, remove_id)
}

# â€” 4. ìµœì¢… ê²°ê³¼ â€”
print(results_tbl)

```


# ë„ë„ˆë¥¼ ë• ì„ ë•Œ ê°€ì¥ ratioê°€ ë†’ì€ ë•Œê°€ ì–¸ì  ì§€ í™•ì¸í•œë‹¤. 
#=====================
```{r}
library(dplyr)

# 1) rate ì»¬ëŸ¼ ì¶”ê°€
results_with_rate <- results_tbl %>%
  mutate(rate = post_rmspe / pre_rmspe)

# 2) rate ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬í•´ì„œ í™•ì¸
results_with_rate %>%
  arrange(desc(rate)) %>%
  print(n = Inf)

# 3) ê°€ì¥ rateê°€ ë†’ì€ â€œí•œ ì¤„â€ë§Œ ë³´ê³  ì‹¶ë‹¤ë©´
top_rate_row <- results_with_rate %>%
  slice_max(rate, n = 1)

top_rate_number <- results_with_rate %>%
  slice_max(rate, n = 1) %>% pull(iter)

print(top_rate_row)

removable_ids <- results_tbl %>% filter(iter >= 1 & iter<= top_rate_number) %>% pull(removed_id)

```


#second scmì„ ì§„í–‰í•œë‹¤. ìœ„ì—ì„œ ë‚˜ì˜¨ ê°’ì„ ë¹¼ê³  ì§„í–‰í•œë‹¤.
#=====================
```{r}
library("beepr")
library(Synth)

options(scipen = 999)

donor_ok_ids


length(donor_ok_ids)

treat_id <- 41


good_preds <- c("lanes.min", "speed.max", "local_share", "local_length_km") #c("lanes.min", "local_length_km", "total_length_km","speed.min", "speed.max" , "lanes.max")

#

good_preds_o <- c("lanes.min","local_length_km","total_length_km", "speed.max", "lanes.max", "speed.min", "local_share")

good_preds_new <- c("lanes.max", "speed.max","local_share", "total_length_km")

# (4) ì•„ì£¼ ì‘ì€ ì¡ìŒ ì¶”ê°€ (jitter) â€” scale ëŒ€ë¹„ ë§¤ìš° ì‘ì€ sd
set.seed(42)
df_scm_jittered <- df_scm %>%
  mutate(across(all_of(good_preds_new),
                ~ .x + rnorm(n(), mean = 0, sd = 1e-7)))

##########################
dp_params <- list(
  foo                     = as.data.frame(df_scm),
  predictors              = good_preds_new,
  predictors.op           = "mean",
  special.predictors      = sp_2_all, #, #sp_all_1wk, # sp_2_all,
  dependent               = "traffic",
  unit.variable           = "unit_id",
  unit.names.variable     = "unit_name",
  time.variable           = "week_index",
  treatment.identifier    = treat_id,          # ì‹¤ì œ ì²˜ë¦¬êµ° ID
  controls.identifier     = donor_ok_ids,    # ì •ì œëœ donor IDs
  time.predictors.prior   = 1:n_pre,
  time.optimize.ssr       = 1:n_pre,
  time.plot               = 1:n_all
)


# 3-1) dataprep with refined donor pool
dp_refined <- do.call(dataprep, dp_params)



# 3-3) ipop ê¸°ë°˜ í•©ì„±ëŒ€ì¡°êµ° ì í•©
so_refined <- synth(data.prep.obj = dp_refined)


############################################################################
## 3. íš¨ê³¼(gap) ê³„ì‚° & ê·¸ë¦¼
############################################################################
gaps_main <- dp_refined$Y1plot - (dp_refined$Y0plot %*% so_refined$solution.w)

# â”€â”€ ê³µí†µ ë³€ìˆ˜ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
week_all  <- dp_refined$tag$time.plot              # 1,2,3,â€¦ ì „ì²´ ì£¼ì°¨
lab_major <- c(1, seq(5, max(week_all), by = 5)) # 1,5,10,15,â€¦ ì›í•˜ëŠ” ë ˆì´ë¸”



# â”€â”€ 1) ê¶¤ì (Path) í”Œë¡¯ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

#===gap
# 0. ê²°ê³¼ ê·¸ë¦¼ -------------------------------------------------------------
path.plot(
  synth.res    = so_refined,
  dataprep.res = dp_refined,
  Ylab = "Weekly traffic",
  Xlab = "Week",
  Legend = c("Treated","Synthetic"),
  Legend.position = "bottomright"
)

# 1. íšŒìƒ‰ ê²©ìì„  -----------------------------------------------------------
abline(v = week_all, col = "grey90", lty = "dotted")

# 2. ì´ë²¤íŠ¸ ì •ì˜  â† ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨! --------------------------------------
event_pos <- c(n_pre + 1)        # x ì¢Œí‘œ
event_lty <- c(2)        # ì„  ì¢…ë¥˜
event_lab <- c("CCC launch")

# 3. ì„  + ë ˆì´ë¸” -----------------------------------------------------------
# (A) ìˆ˜ì§ì„ 
mapply(abline, v = event_pos, lty = event_lty)

# (B) ë ˆì´ë¸” â€“ ì„  ë°”ë¡œ ì•„ë˜, ê°€ë¡œ ê¸€ì”¨
y_lab <- par("usr")[3] + diff(par("usr")[3:4]) * 0.05   # yì¶• ìµœì €ê°’ì—ì„œ 5 % ìœ„
text(event_pos, y_lab,
     labels = event_lab,
     cex = 0.75,          # ê¸€ì”¨ í¬ê¸°
     adj = c(0.5, 1),     # ê°€ìš´ë°Â·ì•„ë˜ ì •ë ¬
     xpd = TRUE)

# 4. xì¶• ëˆˆê¸ˆ (êµµì€ ëˆˆê¸ˆë§Œ í‘œì‹œ) ------------------------------------------
axis(1, at = axTicks(1), labels = FALSE)              # ê¸°ë³¸ ëˆˆê¸ˆ ìˆ¨ê¸°ê³ 
axis(1, at = lab_major, labels = lab_major,           # ì£¼ìš” ëˆˆê¸ˆë§Œ ë‹¤ì‹œ
     las = 1, cex.axis = 0.8)



#===gap
############################################################################
# 0. ê²°ê³¼ ê·¸ë¦¼ -------------------------------------------------------------
gaps.plot(
  synth.res    = so_refined,
  dataprep.res = dp_refined,
  Ylab = "Gap",
  Xlab = "Week"
)

# 1. íšŒìƒ‰ ê²©ìì„  -----------------------------------------------------------
abline(v = week_all, col = "grey90", lty = "dotted")

# 2. ì´ë²¤íŠ¸ ì •ì˜  â† ì—¬ê¸°ë§Œ ë°”ê¾¸ë©´ ë¨! --------------------------------------
event_pos <- c(n_pre + 1)        # x ì¢Œí‘œ
event_lty <- c(2)        # ì„  ì¢…ë¥˜
event_lab <- c("CCC launch")

# 3. ì„  + ë ˆì´ë¸” -----------------------------------------------------------
# (A) ìˆ˜ì§ì„ 
mapply(abline, v = event_pos, lty = event_lty)

# (B) ë ˆì´ë¸” â€“ ì„  ë°”ë¡œ ì•„ë˜, ê°€ë¡œ ê¸€ì”¨
y_lab <- par("usr")[3] + diff(par("usr")[3:4]) * 0.05   # yì¶• ìµœì €ê°’ì—ì„œ 5 % ìœ„
text(event_pos, y_lab,
     labels = event_lab,
     cex = 0.75,          # ê¸€ì”¨ í¬ê¸°
     adj = c(0.5, 1),     # ê°€ìš´ë°Â·ì•„ë˜ ì •ë ¬
     xpd = TRUE)

# 4. xì¶• ëˆˆê¸ˆ (êµµì€ ëˆˆê¸ˆë§Œ í‘œì‹œ) ------------------------------------------
axis(1, at = axTicks(1), labels = FALSE)              # ê¸°ë³¸ ëˆˆê¸ˆ ìˆ¨ê¸°ê³ 
axis(1, at = lab_major, labels = lab_major,           # ì£¼ìš” ëˆˆê¸ˆë§Œ ë‹¤ì‹œ
     las = 1, cex.axis = 0.8)

############################################################################
## 3-bis. ì‚¬ì „Â·ì‚¬í›„ RMSPE ë° Ratio ê³„ì‚°  â† â˜… ì¶”ê°€
############################################################################
pre_rmspe  <- sqrt(mean(gaps_main[ 1:n_pre            ]^2))
post_rmspe <- sqrt(mean(gaps_main[ (n_pre+1):n_all    ]^2))
ratio_main <- post_rmspe / pre_rmspe

att_pct <- mean(gaps_main[(n_pre+1):n_all])      # %-point ATT

baseline_pre <- df_scm %>%
  filter(
    unit_id    == treat_id,   # ì²˜ë¦¬ ëŒ€ìƒ ë„ë¡œ ID
    week_index <= n_pre             # ê°œì… ì´ì „ ì£¼(week)ë§Œ
  ) %>%
  summarise(pre_mean = mean(traffic, na.rm = TRUE)) %>%
  pull(pre_mean)

eff_final <- (att_pct/baseline_pre)*100

cat(sprintf(
  "\nâ–¶ Final RMSPE | Pre = %.3f   Post = %.3f   Ratio = %.3f | ATT = %.3f |ATT ratio =%.3f ",
  pre_rmspe, post_rmspe, ratio_main, att_pct, eff_final
))

goal_v <- baseline_pre*0.19775

cat(sprintf(
  "\nâ–¶ Traffic before treat = %.3f   Expected traffic = %.3f  diff = %.3f",
  baseline_pre, goal_v , abs(goal_v-att_pct)
))

# 4) ì ˆëŒ€ ë‹¨ìœ„ ê¶¤ì 

############################################################################
# 0. ê¸°ë³¸ ê·¸ë˜í”„ ----------------------------------------------------------
plot(Y1_abs, type = "l", lwd = 2,
     xlab = "Week", ylab = "Traffic (vehicles / day)",
     ylim = range(c(Y1_abs, Y0_abs), na.rm = TRUE))
lines(Y0_abs, lwd = 2, lty = 2)

# 1. íšŒìƒ‰ 1ì£¼ ê²©ì --------------------------------------------------------
abline(v = week_all, col = "grey90", lty = "dotted")

# 2. â€˜ì •ì±…Â·ì´ë²¤íŠ¸â€™ ì •ì˜ ---------------------------------------------------
event_pos <- c(n_pre + 1,  61, 74, 80, 96)        # x ì¢Œí‘œ
event_lty <- c(2,         3,  5,  6,  5)        # ì„  ì¢…ë¥˜
event_lab <- c("CCC\nlaunch",          # 2ì¤„!
               "Include\nGimpo",
               "Youth\ndiscount",
               "Include\nNamyang",
               "Include\nGwacheon")

# 3. ìˆ˜ì§ì„  + ë ˆì´ë¸” ------------------------------------------------------
# (A) ìˆ˜ì§ì„ 
invisible( mapply(abline, v = event_pos, lty = event_lty) )

# (B) ë ˆì´ë¸” : ì„  ë°”ë¡œ ì•„ë˜ 5 % ì§€ì , ê°€ë¡œ
y_lab <- par("usr")[3] + diff(par("usr")[3:4]) * 0.05
text(event_pos, y_lab,
     labels = event_lab,
     cex = 0.75,          # ê¸€ì”¨ í¬ê¸°
     adj = c(0.5, 1),     # ê°€ìš´ë°Â·ì•„ë˜ ì •ë ¬
     xpd = TRUE)

# 4. ë²”ë¡€ ---------------------------------------------------------------
legend("topright", legend = c("Treated", "Synthetic"),
       lwd = 2, lty = c(1, 2), bty = "n")




# ê¹¨ë—í•œ ë²„ì „
path.plot(synth.res   = so_refined,
          dataprep.res= dp_refined,
          Ylab = "Weekly traffic", Xlab = "Week",
          Legend = c("Treated","Synthetic"),
          Legend.position = "bottomright")
abline(v = n_pre + 1, lty = 2)               # ì •ì±…ì„ 

gaps.plot(synth.res   = so_refined,
          dataprep.res= dp_refined,
          Ylab = "Gap", Xlab = "Week")
abline(v = n_pre + 1, lty = 2)



# 4ï¸âƒ£ ê°€ì¤‘ì¹˜Â·ë°¸ëŸ°ìŠ¤ (ì •ë¦¬ ë²„ì „)
syn_fix <- so_refined
syn_fix$solution.v <- as.numeric(syn_fix$solution.v)

stab <- synth.tab(dataprep.res = dp_refined,
                  synth.res   = so_refined,
                  round.digit = 10)

# ë„ë„ˆ ê°€ì¤‘ì¹˜ í…Œì´ë¸” í•œ ë²ˆë§Œ ìƒì„±
weights_tbl_t <- stab$tab.w %>%
  arrange(desc(w.weights))

print(weights_tbl_t, row.names = FALSE)



cat(sprintf(
  "\nâ–¶ Baseline RMSPE  |  Pre = %.3f   Post = %.3f   Ratio = %.3f\n",
  pre_rmspe, post_rmspe, ratio_main
))



```


#ê°­ ê·¸ë˜í”„ ëˆˆìœ¼ë¡œ í™•ì¸í•œë‹¤ 

#=====================

```{r}
library(plotly)

# 1) gaps ê³„ì‚°
gaps  <- as.numeric(dp_refined$Y1plot - (dp_refined$Y0plot %*% so_refined$solution.w))

# 2) xì¶•ìœ¼ë¡œ ì“¸ ì£¼(week) ë²¡í„°
#    ë§Œì•½ ë‚ ì§œ/ì—°ì†ì¸ë±ìŠ¤ê°€ ì—†ë‹¤ë©´ 1:length(gaps) ë¡œ ëŒ€ì²´í•´ë„ ë©ë‹ˆë‹¤.
weeks <- dp_refined$tag$time.plot  

# 3) Plotlyë¡œ ì„  ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
fig <- plot_ly(
  x    = ~weeks,
  y    = ~gaps,
  type = "scatter",
  mode = "lines",
  name = "Gap"
) %>%
  # 4) ì²˜ë¦¬ì‹œì (vertical line) ì¶”ê°€
  add_segments(
    x     = ~weeks[n_pre + 1],
    xend  = ~weeks[n_pre + 1],
    y     = min(gaps, na.rm=TRUE),
    yend  = max(gaps, na.rm=TRUE),
    line  = list(dash = "dash", color = "black"),
    showlegend = FALSE
  ) %>%
  # 5) ë ˆì´ì•„ì›ƒ ì„¤ì •
  layout(
    xaxis = list(title = "Week"),
    yaxis = list(title = "Gap"),
    legend = list(orientation = "h", x = 0.1, y = 1.1)
  )

# 6) ì¶œë ¥
fig
```

#pre-period êµí†µëŸ‰ê³¼ ë„ë„ˆ ê°¯ìˆ˜ í™•ì¸í•œë‹¤
#=====================
```{r}
baseline_pre <- df_scm %>%
  filter(
    unit_id    == treat_id,   # ì²˜ë¦¬ ëŒ€ìƒ ë„ë¡œ ID
    week_index <= n_pre             # ê°œì… ì´ì „ ì£¼(week)ë§Œ
  ) %>%
  summarise(pre_mean = mean(traffic, na.rm = TRUE)) %>%
  pull(pre_mean) %>% print()


length(donor_ok_ids)
 #792.460
```

#í”Œë¼ì‹œë³´

#=====================


```{r}
# 1ï¸âƒ£ SCtools ë¡œë“œ
library(SCtools)
# dp_final, so_final ì€ ì•ì„œ ë§Œë“  ìµœì¢… dataprep & synth ê²°ê³¼ì…ë‹ˆë‹¤.

# 2ï¸âƒ£ placebo í•©ì„±ëŒ€ì¡°êµ° ìƒì„±
#    - Sigf.ipop: ipop ìµœì í™” ì •ë°€ë„ (ê¸°ë³¸ 5)
#    - strategy: "sequential" ë˜ëŠ” ë³‘ë ¬ "multiprocess"
placebos <- generate.placebos(
  dataprep.out = dp_refined,
  synth.out    = so_refined,
  Sigf.ipop    = 1,
  strategy     = "sequential"
)  
# â†’ ë°˜í™˜ê°’(placebos)ì€ tdf ê°ì²´ë¡œ, ì›ë³¸ ì²˜ë¦¬êµ°ê³¼ ê° placeboì˜ Y & Y_synth ì‹œê³„ì—´, 
#    ì‚¬ì „ MSPE(mspe.placs) ë“±ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤  

# 3ï¸âƒ£ placebo ë¶„í¬ í”Œë¡¯
#    - plot_placebos(): ëª¨ë“  placebo gap + ì²˜ë¦¬êµ° gapì„ ì¼ê´„ ì‹œê°í™”
plot_placebos(placebos)  

# 4ï¸âƒ£ MSPE test (p-value ê³„ì‚°)
test_out <- mspe.test(placebos)
cat("â–¶ Final p-value =", round(test_out$p.val, 3), "\n")  

beep(5)

```

```{r}
# 3ï¸âƒ£ placebo ê°­ í”Œë¡¯ (gap over time)
plot_placebos(
  placebos,
  discard.extreme = TRUE,   # ì»· ì ìš©
  mspe.limit      = 5       # treated MSPE Ã— 5
)

# 4ï¸âƒ£ p-value ê³„ì‚° (MSPE test)
test_out <- mspe.test(
  placebos,
  discard.extreme = TRUE,
  mspe.limit      = 5
)
cat("â–¶ Final p-value =", round(test_out$p.val, 3), "\n")

# 5ï¸âƒ£ MSPE ratio íˆìŠ¤í† ê·¸ë¨
mspe.plot(
  placebos,
  discard.extreme = TRUE,
  mspe.limit      = 5,
  plot.hist       = TRUE    # í•„ìš” ì‹œ FALSE: dotplot
  
)


# 5ï¸âƒ£ MSPE ratio ë¶„í¬ í”Œë¡¯
#    - mspe.plot(): post/pre-period MSPE ratio ë¥¼ íˆìŠ¤í† ê·¸ë¨ìœ¼ë¡œ
mspe.plot(placebos, discard.extreme = TRUE, mspe.limit = 5)
```

##handmade placebo

```{r}

library(beepr)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# define â€œsafeâ€ wrappers around dataprep() and synth()
# so that any failure just returns NULL instead of stopping
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
safe_dp <- function(arg) {
  tryCatch(
    do.call(dataprep, arg),
    error = function(e) {
      warning("âš  dataprep() failed for treatment ", arg$treatment.identifier, ": ", e$message)
      NULL
    }
  )
}
safe_synth <- function(dp) {
  tryCatch(
    synth(dp),
    error = function(e) {
      warning("âš  synth() failed: ", e$message)
      NULL
    }
  )
}

# now your placebo loop can find safe_dp() / safe_synth()
############################################################################
## 0. ë„ë„ˆ ë²¡í„° & placebo_ids í™•ì •
############################################################################
donor_ok_ids <- donor_ok_ids        # ë˜ëŠ” donor_ok_ids_filtered
placebo_ids  <- setdiff(donor_ok_ids, treat_id)

############################################################################
## 1. placebo ë£¨í”„
############################################################################
store <- matrix(NA_real_, nrow = n_all, ncol = length(placebo_ids))
colnames(store) <- df_scm$unit_name[match(placebo_ids, df_scm$unit_id)]
bad_ids <- integer()

for (i in seq_along(placebo_ids)) {
  id  <- placebo_ids[i]
  arg <- modifyList(dp_params, list(
           treatment.identifier = id,
           controls.identifier  = setdiff(placebo_ids, id)
         ))
    dp_p  <- safe_dp(arg);   if (is.null(dp_p)) next
    so_p  <- safe_synth(dp_p); if (is.null(so_p)) next

   store[, i] <- dp_p$Y1plot - dp_p$Y0plot %*% so_p$solution.w
}

## (optional) drop any that failed completely
if (length(bad_ids <- setdiff(placebo_ids, colnames(store)))) {
  message("âš  synth() ì‹¤íŒ¨: ", paste(bad_ids, collapse = ", "))
  keep        <- colnames(store)
  placebo_ids <- placebo_ids[placebo_ids %in% keep]
  store       <- store[, keep, drop = FALSE]
}

stopifnot(ncol(store) > 0)


beep(5)
```

# í”Œë¼ì‹œë³´ í”Œë¡¯ ê·¸ë¦°ë‹¤.
#=====================
```{r}
exclude_ids <- c()
cut.off <-
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# 1) ì²˜ë¦¬êµ° gap (ê¸°ì¡´)
gap_treated <- as.numeric(dp_refined$Y1plot - (dp_refined$Y0plot %*% so_refined$solution.w))

# 1ï¸âƒ£ pre-period MSPE ê³„ì‚° & 5ë°° ì»·
## 1) pre-MSPE ì»·
mspe_placebo <- colMeans(store[1:n_pre, , drop=FALSE]^2, na.rm=TRUE)
ref_mspe     <- mean(gap_treated[1:n_pre]^2)
keep_units   <- names(mspe_placebo)[ mspe_placebo <= ref_mspe * cut.off ]

## 2) ì»·ì˜¤í”„ ë®ì–´ì“°ê¸° ê¸ˆì§€!

## 3) store5 ìƒì„± (ì—´ ì´ë¦„ ê·¸ëŒ€ë¡œ ìœ ì§€)
store5 <- store[, keep_units, drop = FALSE]
stopifnot(ncol(store5) > 0)  # ìµœì†Œ í•œ ê°œ ì´ìƒì˜ í”Œë¼ì‹œë³´ê°€ ë‚¨ì•„ì•¼ í•¨

## 4) plotlyìš© ë°ì´í„° ë³€í™˜
all_gaps <- cbind(Treated = gap_treated, store5)
df_plot  <- as_tibble(all_gaps) %>%
  mutate(Time = row_number()) %>%
  pivot_longer(-Time, names_to = "Unit", values_to = "Gap")



# ìƒ‰ìƒ íŒ”ë ˆíŠ¸
library(RColorBrewer)
placebo_units <- setdiff(unique(df_plot$Unit), "Treated")
base_pal  <- brewer.pal(min(8, length(placebo_units)), "Set2")
pal_extra <- colorRampPalette(base_pal)(length(placebo_units))
pal       <- c("Treated" = "black", setNames(pal_extra, placebo_units))

# plotly
library(plotly)
fig <- plot_ly(
  df_plot,
  x      = ~Time,
  y      = ~Gap,
  color  = ~Unit,
  colors = pal,
  hoverinfo = "text",
  text   = ~sprintf("%s<br>Week %d<br>Gap %.1f", Unit, Time, Gap)
) %>%
  add_lines() %>%
  layout(
    title = "Treated vs Placebo Gaps\n(MSPE â‰¤ 5Ã— & exclude_ids ì œì™¸)",
    shapes = list(list(
      type = "line",
      x0   = n_pre + 1, x1 = n_pre + 1,
      y0   = min(df_plot$Gap, na.rm = TRUE),
      y1   = max(df_plot$Gap, na.rm = TRUE),
      line = list(dash = "dash", color = "black")
    )),
    xaxis = list(title = "Week"),
    yaxis = list(title = "Gap")
  ) %>%
  config(displaylogo = FALSE)

fig
```


```{r}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Final SCM: p-value ê³„ì‚° ë° íˆìŠ¤í† ê·¸ë¨
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Final SCM: p-value ê³„ì‚°, íˆìŠ¤í† ê·¸ë¨ ë° ì„¸ë¡œ Dot Chart
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

library(dplyr)
library(ggplot2)

# â€” 0) ì‚¬ì „(pre)Â·ì‚¬í›„(post) ê¸°ê°„ ê¸¸ì´ â€”
# n_pre: ì´ë¯¸ ì •ì˜ëœ ê°œì… ì „ ê¸°ê°„ ê¸¸ì´
# n_all: ì „ì²´ ê¸°ê°„ ê¸¸ì´
# (n_all â† length(gaps_main) ë˜ëŠ” nrow(store))

# â€” 1) Treated Unitì˜ Pre/Post RMSPE ë¹„ìœ¨ ê³„ì‚° â€”
pre_rmspe_treated  <- sqrt(mean(gaps_main[   1:n_pre       ]^2, na.rm = TRUE))
post_rmspe_treated <- sqrt(mean(gaps_main[(n_pre+1):n_all ]^2, na.rm = TRUE))
ratio_treated      <- post_rmspe_treated / pre_rmspe_treated

# â€” 2) Placebo Unitsì˜ Pre/Post RMSPE ë¹„ìœ¨ ê³„ì‚° â€”
pre_rmspe_placebo  <- apply(store[   1:n_pre       , , drop = FALSE], 2,
                             function(x) sqrt(mean(x^2, na.rm = TRUE)))
post_rmspe_placebo <- apply(store[(n_pre+1):n_all , , drop = FALSE], 2,
                             function(x) sqrt(mean(x^2, na.rm = TRUE)))
ratio_placebo      <- post_rmspe_placebo / pre_rmspe_placebo

# â€” 3) â€œpre-MSPE â‰¤ 5Ã—treated pre-MSPEâ€ í•„í„°ë§ â€”
threshold        <- cut.off * pre_rmspe_treated
keep_idx         <- which(pre_rmspe_placebo <= threshold & !is.na(ratio_placebo))
ratio_placebo_f  <- ratio_placebo[keep_idx]

# â€” 4) Final p-value (one-sided) ê³„ì‚° â€”
p_value <- mean(ratio_placebo_f >= ratio_treated, na.rm = TRUE)
cat(sprintf("â–¶ Final p-value = %.3f\n", p_value))

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# A) Ratio íˆìŠ¤í† ê·¸ë¨
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ggplot(data.frame(Ratio = ratio_placebo_f), aes(x = Ratio)) +
  geom_histogram(bins = 30, fill = "steelblue", color = "white", alpha = 0.8) +
  geom_vline(xintercept = ratio_treated, color = "red", linetype = "dashed", size = 1) +
  annotate("text",
           x = ratio_treated, y = Inf,
           label = paste0("Treated\nRatio=", round(ratio_treated, 2)),
           vjust = -0.5, hjust = 1.1, color = "red", size = 3) +
  labs(
    title    = "Placebo Post/Pre RMSPE Ratio Distribution",
    subtitle = paste("Final p-value =", round(p_value, 3)),
    x        = "Post/Pre RMSPE Ratio",
    y        = "Count"
  ) +
  theme_minimal()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# B) ì„¸ë¡œ Dot Chart
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# (1) ë°ì´í„°í”„ë ˆì„ ìƒì„±
df_units <- bind_rows(
  tibble(
    unit = names(ratio_placebo_f),
    ratio = as.numeric(ratio_placebo_f),
    type  = "Placebo"
  ),
  tibble(
    unit  = "Treated Unit",
    ratio = ratio_treated,
    type  = "Treated"
  )
) %>%
  arrange(ratio) %>%
  mutate(unit = factor(unit, levels = unit))

# (2) ê·¸ë¦¬ê¸°
ggplot(df_units, aes(x = ratio, y = unit, shape = type, color = type)) +
  geom_point(size = 3) +
  geom_vline(xintercept = 1, linetype = "dashed", color = "grey") +
  scale_shape_manual(values = c(Placebo = 17, Treated = 15)) +
  scale_color_manual(values = c(Placebo = "black", Treated = "red")) +
  labs(
    title = paste0("Post/Pre RMSPE Ratio (Final SCM) â€” p=", round(p_value, 3)),
    x     = "Post/Pre RMSPE Ratio",
    y     = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text.y        = element_text(size = 6),
    panel.grid.major.y = element_blank(),
    plot.title         = element_text(face = "bold", hjust = 0.5)
  )
```

#gap check

```{r}

library(dplyr)
library(purrr)
library(tibble)

# 1ï¸âƒ£ ëª¨ë“  ì‹œê³„ì—´ì„ ë¦¬ìŠ¤íŠ¸ë¡œ ì¤€ë¹„
#    TreatedëŠ” gap_treated, í”Œë¼ì‹œë³´ëŠ” store5 í–‰ë ¬
gap_list <- c(
  list(Treated = gap_treated),
  as.list(as.data.frame(store5))
)

# 2ï¸âƒ£ ë‹¨ìœ„ë³„ RMSPE ê³„ì‚° í•¨ìˆ˜
compute_rmspe <- function(gap_vec) {
  pre  <- sqrt(mean(gap_vec[1:n_pre]^2,       na.rm = TRUE))
  post <- sqrt(mean(gap_vec[(n_pre+1):n_all]^2, na.rm = TRUE))
  tibble(
    Pre_RMSPE  = pre,
    Post_RMSPE = post,
    Ratio      = post / pre
  )
}

# 3ï¸âƒ£ ëª¨ë“  ìœ ë‹›ì— ì ìš©í•˜ì—¬ ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ê²°í•©
rmspe_tbl <- imap_dfr(
  gap_list,
  ~ compute_rmspe(.x) %>% mutate(Unit = .y),
  .id = NULL
) %>%
  select(Unit, Pre_RMSPE, Post_RMSPE, Ratio) %>%
  arrange(Ratio)

# 4ï¸âƒ£ ê²°ê³¼ ì¶œë ¥
print(rmspe_tbl)

```










```{r}
library(dplyr)
library(stringr)

# 1) Ratio > 2ì¸ Unit ë²¡í„°
units <- rmspe_tbl %>% 
  filter(Ratio >3 ) %>% filter(!Unit %in% "Treated") %>%
  pull(Unit)
# [1] "281_í•œë°­ëŒ€ë¡œ í•˜í–‰_í•œë°­ëŒ€ë¡œ"

# 2) ì• ìˆ«ìë§Œ ì¶”ì¶œ
ids_chr <- str_extract(units, "^[0-9]+")
# ë˜ëŠ” ë² ì´ìŠ¤ R:
# ids_chr <- sub("^(\\d+).*", "\\1", units)

# 3) ì •ìˆ˜ë¡œ ë³€í™˜
ids_int <- toString(ids_chr)

ids_int

```

#======================

#check the deletable pools

```{r}
library(dplyr)

# ì´ ê¸°ì¤€ìœ¼ë¡œ í•„í„°ë§í•œ unit_id


units_high_rate <- as.vector(ids_int)

units_gap_top10 <- weights_tbl_t %>%
  filter(w.weights >= 0.01) %>%
  pull(unit.numbers)

units_overlap <- intersect(units_high_rate, units_gap_top10)


# 'ë†’ì€ ë„ë¡œ'ì—ì„œ 'ëº„ìˆ˜ ì—†ëŠ” ë„ë¡œ'ë¥¼ ì œì™¸í•œ ë²¡í„° ê³„ì‚°
units_can_be_deleted <- (setdiff(units_high_rate, units_overlap))

#deledted_clean <- sub("^ID_", "", units_can_be_deleted)

# units_can_be_deleted ê°€ ì´ë¯¸ ê³„ì‚°ë˜ì–´ ìˆë‹¤ê³  ê°€ì •

# 4) ê²°ê³¼ë¥¼ "ID" ê¼´ë¡œ ë”°ì˜´í‘œ+ì‰¼í‘œ í˜•íƒœë¡œ í•œ ë²ˆì— ì¶œë ¥
cat("rateë†’ì€ ë„ë¡œ: ", paste((units_high_rate), collapse = ", "), "\n")
cat("ê¸°ì—¬ë„ ë†’ì€ ë„ë¡œ: ", paste((units_gap_top10), collapse = ", "), "\n")
cat("ëº„ ìˆ˜ ì—†ëŠ” ë„ë¡œ: ", paste((units_overlap), collapse = ", "), "\n")
cat("ëº„ ìˆ˜ ìˆëŠ” ë„ë¡œ: ", paste((units_can_be_deleted), collapse = ", "), "\n")

# 5) ê°œìˆ˜ í™•ì¸
cat("ì „ì²´ í›„ë³´ ë„ë¡œ ìˆ˜: ", length(donor_ok_ids), "\n")
cat("ì‚­ì œ ê°€ëŠ¥í•œ ë„ë¡œ ìˆ˜: ",length(strsplit(units_can_be_deleted, ",\\s*")[[1]]), "\n")
```

#==================
#### how_diff?

```{r}
library(dplyr)
library(purrr)
library(tibble)
library(Synth)

# 1) high-rate ë„ë¡œ ID (ì •ìˆ˜ ë²¡í„° í˜•íƒœ)
high_rate_ids <- as.integer(strsplit(units_high_rate, ",\\s*")[[1]])

# 2) leave-one-out ì‹¤í—˜ í•¨ìˆ˜ (ì—ëŸ¬ ì‹œ NULL ë°˜í™˜)
compute_pre_rmspe_leave_one <- function(remove_id) {
  tryCatch({
    # (ê°€) controls.identifier ì—ì„œ í•˜ë‚˜ ë¹¼ê¸°
    new_controls <- setdiff(donor_ok_ids, remove_id)
    
    # (ë‚˜) dataprep
    dp_i <- do.call(dataprep,
                    modifyList(dp_params, list(controls.identifier = new_controls)))
    
    # (ë‹¤) synth
    so_i <- synth(dp_i)
    
    # (ë¼) gap ê³„ì‚°
    gap_i <- dp_i$Y1plot - dp_i$Y0plot %*% so_i$solution.w
    
    # (ë§ˆ) pre-period RMSPE ê³„ì‚°
    pre_i <- sqrt(mean(gap_i[1:n_pre]^2, na.rm = TRUE))
    
    # ì„±ê³µ ì‹œ tibble ë°˜í™˜
    tibble(
      removed_id = remove_id,
      pre_RMSPE  = pre_i
    )
  }, error = function(e) {
    warning("âš  Failed for remove_id=", remove_id, ": ", e$message)
    NULL
  })
}

# 3) ëª¨ë“  IDì— ì ìš©
results_tbl_compare <- map_dfr(high_rate_ids, compute_pre_rmspe_leave_one)

# 4) baseline ê³¼ ë¹„êµ
baseline_pre <- sqrt(mean(gaps_main[1:n_pre]^2, na.rm = TRUE))
results_tbl_compare <- results_tbl_compare %>%
  mutate(
    baseline_pre = baseline_pre,
    diff         = pre_RMSPE - baseline_pre
  ) %>%
  arrange((diff))

# 5) ê²°ê³¼ í™•ì¸
print(results_tbl_compare)

removable_ids <- results_tbl_compare %>%
  filter(diff < 10) %>%
  arrange(removed_id) %>%    # removed_id ê¸°ì¤€ ì˜¤ë¦„ì°¨ìˆœ
  pull(removed_id) 
```
#========================
#final scm

```{r}
library(beepr)
library(Synth)

options(scipen = 999)

donor_ok_ids <- df_scm %>%
  filter(unit_id >= 15)%>%
  distinct(unit_id) %>%  # ê³ ìœ ê°’ë§Œ
  pull(unit_id)   


n_all <- 70
n_pre <- 50

donor_ids_final <- donor_ok_ids 

treat_id    <- 4
predictors_final  <- c("lanes.min","local_length_km",
                       "speed.max")

good_preds_o <- c("lanes.min","local_length_km","total_length_km", "speed.max", "lanes.max", "speed.min", "local_share")

good_preds_new <- c("lanes.max", "speed.max","local_share", "total_length_km")


# 2ï¸âƒ£ jitter ì¶”ê°€ (optional)


# 3ï¸âƒ£ final dataprep íŒŒë¼ë¯¸í„°
dp_params_final <- list(
  foo               = as.data.frame(df_scm),
  predictors              = good_preds_new, 
  predictors.op           = "mean",
  special.predictors      = sp_2_all, #, #sp_all_1wk, # sp_2_all,
  dependent               = "traffic",
  unit.variable           = "unit_id",
  unit.names.variable     = "unit_name",
  time.variable           = "week_index",
  treatment.identifier    = treat_id,
  controls.identifier     = donor_ids_final,
  time.predictors.prior   = 1:n_pre,
  time.optimize.ssr       = 1:n_pre,
  time.plot               = 1:n_all
)

# 4ï¸âƒ£ final dataprep & synth
dp_final <- do.call(dataprep, dp_params_final)
so_final <- synth(dp_final)


# 5ï¸âƒ£ gap ê³„ì‚°
gaps_final <- dp_final$Y1plot - (dp_final$Y0plot %*% so_final$solution.w)

# 6ï¸âƒ£ ì‹œê°„ ë³€ìˆ˜
week_final      <- dp_final$tag$time.plot
lab_major_final <- c(1, seq(5, max(week_final), by = 5))

# 7ï¸âƒ£ ê¶¤ì (Path) í”Œë¡¯
path.plot(
  synth.res    = so_final,
  dataprep.res = dp_final,
  Ylab = "Weekly traffic",
  Xlab = "Week",
  Legend = c("Treated","Synthetic"),
  Legend.position = "bottomright"
)
abline(v = week_final, col = "grey90", lty = "dotted")
abline(v = n_pre + 1, lty = 2)
text(n_pre + 1, par("usr")[3] + diff(par("usr")[3:4])*0.05,
     labels = "Final CCC launch", cex=0.75, adj=c(0.5,1), xpd=TRUE)
axis(1, at = lab_major_final, labels = lab_major_final, las=1, cex.axis=0.8)

# 8ï¸âƒ£ gap í”Œë¡¯
gaps.plot(
  synth.res    = so_final,
  dataprep.res = dp_final,
  Ylab = "Gap",
  Xlab = "Week"
)
abline(v = week_final, col = "grey90", lty = "dotted")
abline(v = n_pre + 1, lty = 2)

# 9ï¸âƒ£ ì‚¬ì „Â·ì‚¬í›„ RMSPE & Ratio
pre_rmspe_final  <- sqrt(mean(gaps_final[1:n_pre]^2))
post_rmspe_final <- sqrt(mean(gaps_final[(n_pre+1):n_all]^2))
ratio_final      <- post_rmspe_final / pre_rmspe_final

att_pct1 <- mean(gaps_final[(n_pre+1):n_all])      # %-point ATT

baseline_pre <- df_scm %>%
  filter(
    unit_id    == treat_id,   # ì²˜ë¦¬ ëŒ€ìƒ ë„ë¡œ ID
    week_index <= n_pre             # ê°œì… ì´ì „ ì£¼(week)ë§Œ
  ) %>%
  summarise(pre_mean = mean(traffic, na.rm = TRUE)) %>%
  pull(pre_mean)

eff_final1 <- (att_pct1/baseline_pre)*100

cat(sprintf(
  "\nâ–¶ Final RMSPE | Pre = %.3f   Post = %.3f   Ratio = %.3f | ATT = %.3f |ATT ratio =%.3f ",
  pre_rmspe_final, post_rmspe_final, ratio_final, att_pct1, eff_final1
))

goal_v1 <- baseline_pre*0.19775

cat(sprintf(
  "\nâ–¶ Traffic before treat = %.3f   Expected traffic = %.3f  diff = %.3f",
  baseline_pre,  goal_v1, abs(goal_v1-att_pct1)
))


# 11ï¸âƒ£ final ê°€ì¤‘ì¹˜ í…Œì´ë¸”
stab_final <- synth.tab(dataprep.res = dp_final,
                        synth.res   = so_final,
                        round.digit = 10)
weights_final_tbl <- stab_final$tab.w %>%
  arrange(desc(w.weights))
print(weights_final_tbl, row.names = FALSE)




beep(5)  # ì™„ë£Œ ì•Œë¦¼
```


# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# final placebo ì‹¤í–‰
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

```{r}


# 1ï¸âƒ£ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ
library(beepr)
library(Synth)

# 2ï¸âƒ£ ì•ˆì „í•œ dataprep()/synth() ë˜í¼
safe_dp_pb <- function(arg) {
  tryCatch(do.call(dataprep, arg),
           error = function(e) {
             warning("âš  dataprep failed for placebo ", arg$treatment.identifier, ": ", e$message)
             NULL
           })
}
safe_synth_pb <- function(dp) {
  tryCatch(synth(dp),
           error = function(e) {
             warning("âš  synth failed for placebo: ", e$message)
             NULL
           })
}

# 3ï¸âƒ£ placebo ëŒ€ìƒ ID ì •ì˜
placebo_ids_final <- setdiff(donor_ids_final, treat_id)

# 4ï¸âƒ£ ê²°ê³¼ ì €ì¥ í–‰ë ¬ ì´ˆê¸°í™” (unit_id ë¬¸ìì—´ì„ ì—´ ì´ë¦„ìœ¼ë¡œ)
store_final_pb <- matrix(
  NA_real_,
  nrow = n_all,
  ncol = length(placebo_ids_final),
  dimnames = list(NULL, as.character(placebo_ids_final))
)

# 5ï¸âƒ£ ë£¨í”„ ëŒë©° gap ê³„ì‚°
for (id_pb in placebo_ids_final) {
  args_pb <- modifyList(dp_params_final, list(
    treatment.identifier = id_pb,
    controls.identifier  = setdiff(placebo_ids_final, id_pb)
  ))
  dp_pb <- safe_dp_pb(args_pb)
  if (is.null(dp_pb)) next
  
  so_pb <- safe_synth_pb(dp_pb)
  if (is.null(so_pb)) next
  
  store_final_pb[, as.character(id_pb)] <-
    dp_pb$Y1plot - dp_pb$Y0plot %*% so_pb$solution.w
}

# 6ï¸âƒ£ ì™„ì „íˆ ì‹¤íŒ¨(ì „ë¶€ NA)í•œ ì—´ ì œê±°
store_final_pb <- store_final_pb[, colSums(!is.na(store_final_pb)) > 0, drop = FALSE]
if (ncol(store_final_pb) == 0) {
  stop("âš  ëª¨ë“  í”Œë¼ì‹œë³´ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. dp_params_finalì„ ì¬ì ê²€í•˜ì„¸ìš”.")
}

beep(5)  # ì™„ë£Œ ì•Œë¦¼
```


```{r}
library(dplyr)
library(tidyr)
library(plotly)
library(RColorBrewer)

# 1) ì²˜ë¦¬êµ° gap (ìµœì¢…)
gap_treated_final <- as.numeric(gaps_final)

# 2) pre-period MSPE ê³„ì‚° & 5Ã— ì»·
mspe_placebo_final <- colMeans(store_final_pb[1:n_pre, , drop = FALSE]^2, na.rm = TRUE)
ref_mse_final      <- mean((gap_treated_final[1:n_pre])^2)
keep_units_final  <- names(mspe_placebo_final)[mspe_placebo_final <= ref_mse_final * 5]

# 3) ì‹¤ì œ ì¡´ì¬í•˜ëŠ” ì»¬ëŸ¼ë§Œ
keep_units_final <- intersect(keep_units_final, colnames(store_final_pb))

# 4) (ì˜µì…˜) exclude_ids ì œê±°í•˜ë ¤ë©´
#exclude_names <- df_scm %>% 
#  filter(unit_id %in% exclude_ids) %>% 
#  pull(unit_name)

#keep_units_final <- setdiff(keep_units_final, exclude_names)

# 5) ìµœì¢… í”Œë¼ì‹œë³´ í–‰ë ¬
store5_final <- store_final_pb[, keep_units_final, drop = FALSE]

# 6) Treated + Placebo ê²°í•©
all_gaps_final <- cbind(
  Treated    = gap_treated_final,
  store5_final
)
n_time <- nrow(all_gaps_final)

# 7) long í¬ë§· ë³€í™˜
df_plot_final <- as_tibble(all_gaps_final) %>%
  mutate(Week = 1:n_time) %>%
  pivot_longer(
    cols      = -Week,
    names_to  = "unit_id",
    values_to = "Gap"
  ) %>%
  left_join(
    df_scm %>%
      mutate(
        unit_id  = as.character(unit_id),
        treat_id = as.character(treat_id)
      ) %>%
      select(unit_id, unit_name, treat_id) %>%
      distinct(),
    by = "unit_id"
  ) %>%
  # NAì¸ unit_nameì„ "treatment"ë¡œ ëŒ€ì²´
  mutate(
    unit_name = if_else(is.na(unit_name), "treatment", unit_name)
  )

# 8) ìƒ‰ìƒ íŒ”ë ˆíŠ¸ ì¤€ë¹„
placebo_units_final <- setdiff(unique(df_plot_final$unit_name), "treatment")
base_pal_final      <- brewer.pal(min(8, length(placebo_units_final)), "Set2")
pal_extra_final     <- colorRampPalette(base_pal_final)(length(placebo_units_final))
pal_final           <- c("treatment" = "black",
                         setNames(pal_extra_final, placebo_units_final))

# 9) Plotly ê·¸ë¦¬ê¸°
fig_final <- plot_ly(
  df_plot_final,
  x      = ~Week,
  y      = ~Gap,
  color  = ~unit_name,
  colors = pal_final,
  hoverinfo = "text",
  text   = ~sprintf("%s<br>Week %d<br>Gap %.1f", unit_name, Week, Gap)
) %>%
  add_lines() %>%
  layout(
    title = "Treated vs Final Placebo Gaps\n(MSPE â‰¤ 5Ã— & exclude_ids ì œì™¸)",
    shapes = list(list(
      type = "line",
      x0   = n_pre + 1, x1 = n_pre + 1,
      y0   = min(df_plot_final$Gap, na.rm = TRUE),
      y1   = max(df_plot_final$Gap, na.rm = TRUE),
      line = list(dash = "dash", color = "black")
    )),
    xaxis = list(title = "Week"),
    yaxis = list(title = "Gap")
  ) %>%
  config(displaylogo = FALSE)

fig_final
```


#SCtools placebo

```{r}
# 1ï¸âƒ£ SCtools ë¡œë“œ
library(SCtools)
# dp_final, so_final ì€ ì•ì„œ ë§Œë“  ìµœì¢… dataprep & synth ê²°ê³¼ì…ë‹ˆë‹¤.

# 2ï¸âƒ£ placebo í•©ì„±ëŒ€ì¡°êµ° ìƒì„±
#    - Sigf.ipop: ipop ìµœì í™” ì •ë°€ë„ (ê¸°ë³¸ 5)
#    - strategy: "sequential" ë˜ëŠ” ë³‘ë ¬ "multiprocess"
placebos <- generate.placebos(
  dataprep.out = dp_final,
  synth.out    = so_final,
  Sigf.ipop    = 5,
  strategy     = "sequential"
)  
# â†’ ë°˜í™˜ê°’(placebos)ì€ tdf ê°ì²´ë¡œ, ì›ë³¸ ì²˜ë¦¬êµ°ê³¼ ê° placeboì˜ Y & Y_synth ì‹œê³„ì—´, 
#    ì‚¬ì „ MSPE(mspe.placs) ë“±ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤  

# 3ï¸âƒ£ placebo ë¶„í¬ í”Œë¡¯
#    - plot_placebos(): ëª¨ë“  placebo gap + ì²˜ë¦¬êµ° gapì„ ì¼ê´„ ì‹œê°í™”
plot_placebos(placebos)  

# 4ï¸âƒ£ MSPE test (p-value ê³„ì‚°)
test_out <- mspe.test(placebos)
cat("â–¶ Final p-value =", round(test_out$p.val, 3), "\n")  

beep(5)

```


```{r}
# â¶ MSPE test: pre-MSPE > 5Ã— ì¸ í”Œë¼ì‹œë³´ ì œì™¸ í›„ p-ê°’ ê³„ì‚°
test_out <- mspe.test(placebos,
                      discard.extreme = TRUE,   # â† í•„í„° ì¼œê¸°
                      mspe.limit      = 5)      # â† 5 ë°° ê¸°ì¤€
cat("â–¶ filtered p-value =", round(test_out$p.val, 3), "\n")

# â· MSPE ratio í”Œë¡¯(ì /íˆìŠ¤í† ê·¸ë¨)ë„ ë™ì¼ ì˜µì…˜
mspe.plot(placebos,
          discard.extreme = TRUE,
          mspe.limit      = 5)

# â¸ gap ê¶¤ì  í”Œë¡¯(plot_placebos) ì—­ì‹œ ë™ì¼ ì¸ì ì‚¬ìš© ê°€ëŠ¥
plot_placebos(placebos,
              discard.extreme = TRUE,
              mspe.limit      = 5)
```

####ë‹¨ì¸¡ê²€ì •




```{r}
library(dplyr)

## 1ï¸âƒ£ ë©”íƒ€ ì •ë³´
meta_df <- placebos$names.and.numbers        # unit.numbers, unit.names

## 2ï¸âƒ£ pre-MSPE ë²¡í„° ë§Œë“¤ê¸°  (ì´ë¦„ = unit.numbers, ê°’ = pre-MSPE)
mspe_vec <- setNames(
  placebos$mspe.placs[[1]],                  # data-frame â†’ ë²¡í„°
  meta_df$unit.numbers                       # ë™ì¼í•œ í–‰ìˆœì„œ í™œìš©
)

## 3ï¸âƒ£ ì²˜ë¦¬ ë„ë¡œ pre-MSPE
mspe_treat <- as.numeric(placebos$loss.v)     # scalar

## 4ï¸âƒ£ 5 ë°° ì»·ì˜¤í”„ ì´ˆê³¼ í”Œë¼ì‹œë³´ ID
bad_ids <- names(mspe_vec)[ mspe_vec > 5 * mspe_treat ] |>
           as.numeric()                      # ìˆ«ìí˜•ìœ¼ë¡œ

## 5ï¸âƒ£ ì œì™¸ëœ ìœ ë‹›(ë„ë¡œ) ëª©ë¡
excluded_units <- meta_df %>%
  filter(unit.numbers %in% bad_ids) %>% print() %>% pull(unit.numbers)

print(excluded_units)
```


```{r}
# 3) ID ë²¡í„° ë½‘ê¸° ------------------------------
treated_id  <- placebos$tr                    # ì‹¤ì œ treated ë²ˆí˜¸
control_ids <- c(placebos[["names.and.numbers"]][["unit.numbers"]])

## 0) convenience variables ---------------------------------
treated_id  <- placebos$tr
t1_row      <- placebos$t1          # first post-period row index

## 1) reshape ------------------------------------------------

# (2) wide â†’ long ë³€í™˜ -------------------------------------------
placebos_long <- placebos$df 

plb_long<- placebos_long %>%                 # 91 Ã— 95 (ì˜ˆì‹œ)
  rename(week_index = "year") %>%
  mutate(week_index = as.integer(week_index)) %>% 
  pivot_longer(                             # unitë³„ë¡œ ì„¸ë¡œë¡œ ë…¹ì´ê¸°
    -week_index,
    names_to  = "unit_id",
    values_to = "value"
  ) %>% 
  mutate(
    unit_id = as.character(unit_id),          # ë¬¸ì â†’ ì •ìˆ˜
    post    = week_index >= t1_row          # ì‚¬í›„ êµ¬ê°„ í”Œë˜ê·¸
  )

```


```{r}
library(stringr)

gap_long <- plb_long %>% 
  mutate(
    type    = if_else(str_starts(unit_id, "synthetic\\."), "synthetic", "obs"),
    unit_id = str_remove(unit_id, "^synthetic\\.")   # ìˆ«ìë§Œ ë‚¨ê¹€
  ) %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  mutate(
    gap = obs - synthetic      # (ìŒìˆ˜ â†’ êµí†µëŸ‰ ê°ì†Œ)
  ) %>%
  filter(!unit_id %in% excluded_units)
```


```{r}
treated_id <- "Y1"                 # ë˜ëŠ” 41 ë“±
control_ids <- gap_long %>% 
  filter(!str_detect(unit_id, "[^0-9]")) %>%   # ìˆ«ìë§Œ
  distinct(unit_id) %>% 
  pull(unit_id) %>% 
  setdiff(treated_id)

# â‘  treated ë‹¨ì¸¡ í†µê³„ëŸ‰ (ê°ì†Œë©´ ìŒìˆ˜)
stat_treat <- gap_long %>% 
  filter(unit_id == treated_id, post) %>% 
  summarise(stat = sum(gap, na.rm = TRUE)) %>% 
  pull(stat)

# â‘¡ ì»¨íŠ¸ë¡¤(placebo) í†µê³„ëŸ‰
placebo_stats <- gap_long %>% 
  filter(unit_id %in% control_ids, post) %>% 
  group_by(unit_id) %>% 
  summarise(stat = sum(gap, na.rm = TRUE)) %>% 
  pull(stat)

# â‘¢ â€˜ê°ì†Œâ€™ ë°©í–¥ ë‹¨ì¸¡ p-value
p_one <- (1 + sum(placebo_stats <= stat_treat)) /
         (1 + length(placebo_stats))


p_one
```
#===
#ë‹¨ì¸¡ê²€ì • íˆìŠ¤í† ê·¸ë¨

```{r}
# 1) í•„ìš”í•œ íŒ¨í‚¤ì§€ ë¡œë“œ
library(ggplot2)

# 2) ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜
df_plot_placebos <- data.frame(
  stat = placebo_stats
)

# 3) íˆìŠ¤í† ê·¸ë¨ + ì²˜ë¦¬êµ¬ê°„ í†µê³„ëŸ‰ í‘œì‹œ
p_placebos <- ggplot(df_plot_placebos, aes(x = stat)) +
  geom_histogram(binwidth = diff(range(df_plot_placebos$stat)) / 30,
                 fill = "grey80", color = "white") +
  geom_vline(xintercept = stat_treat,
             color = "red", size = 1) +
  labs(
    title = "Placebo P-value Histogram (One tale? negative)",
    subtitle = paste0("One tale p-value = ",
                      round(p_one, 3)),
    x = "Post Gap Sum(statistic)",
    y = "Placebos"
  ) +
  theme_minimal()

# 4) ì¶œë ¥
print(p_placebos)

```

```{r}
pl_treat_id <- c("Y1", "synthetic.Y1")

# (1) ë¶€í˜¸ ìœ ì§€ í†µê³„ëŸ‰ = Î£ gap  (ê°ì†Œë©´ ìŒìˆ˜)
t_y1 <- plb_long %>%
  filter(unit_id == c("Y1"), post) %>%
  group_by(unit_id) %>%
  summarise(stat = sum(value, na.rm = TRUE)) %>%
  pull(stat)

t_s <- plb_long %>%
  filter(unit_id == c("synthetic.Y1"), post) %>%
  group_by(unit_id) %>%
  summarise(stat = sum(value, na.rm = TRUE)) %>%
  pull(stat)

t_y1 - t_s

```
```{r}
# â‘  treated ë‹¨ì¸¡ í†µê³„ëŸ‰ (ê°ì†Œë©´ ìŒìˆ˜)
stat_treat <- plb_long %>% 
  filter(unit_id == pl_treat_id, post) %>% 
  summarise(stat = sum(value, na.rm = TRUE)) %>% 
  pull(stat)

stat_treat
```


```{r}
# 3ï¸âƒ£ placebo ê°­ í”Œë¡¯ (gap over time)
plot_placebos(
  placebos,
  discard.extreme = TRUE,   # ì»· ì ìš©
  mspe.limit      = 5       # treated MSPE Ã— 5
)

# 4ï¸âƒ£ p-value ê³„ì‚° (MSPE test)
test_out <- mspe.test(
  placebos,
  discard.extreme = TRUE,
  mspe.limit      = 5
)
cat("â–¶ Final p-value =", round(test_out$p.val, 3), "\n")

# 5ï¸âƒ£ MSPE ratio íˆìŠ¤í† ê·¸ë¨
mspe.plot(
  placebos,
  discard.extreme = TRUE,
  mspe.limit      = 5,
  plot.hist       = TRUE    # í•„ìš” ì‹œ FALSE: dotplot
  
)


# 5ï¸âƒ£ MSPE ratio ë¶„í¬ í”Œë¡¯
#    - mspe.plot(): post/pre-period MSPE ratio ë¥¼ íˆìŠ¤í† ê·¸ë¨ìœ¼ë¡œ
mspe.plot(placebos, discard.extreme = TRUE, mspe.limit = 5)
```

#------------------------
#in_time_placebo
#------------------------



```{r}
library(beepr)
library(Synth)

options(scipen = 999)

donor_ok_ids <- df_scm %>%
  filter(unit_id >= 174) %>%
  distinct(unit_id) %>%  # ê³ ìœ ê°’ë§Œ
  pull(unit_id)   


n_all <- 90
n_pre <- 20

donor_ids_final <- donor_ok_ids 

treat_id    <- 41


# 3ï¸âƒ£ final dataprep íŒŒë¼ë¯¸í„°
dp_in_time <- list(
  foo               = as.data.frame(df_scm),
  predictors              = good_preds_new, 
  predictors.op           = "mean",
  special.predictors      = sp_2_in_time, #, #sp_all_1wk, # sp_2_all, sp_all_in_time
  dependent               = "traffic",
  unit.variable           = "unit_id",
  unit.names.variable     = "unit_name",
  time.variable           = "week_index",
  treatment.identifier    = treat_id,
  controls.identifier     = donor_ids_final,
  time.predictors.prior   = 1:20,
  time.optimize.ssr       = 1:20,
  time.plot               = 1:90
)

# 4ï¸âƒ£ final dataprep & synth
dp_in_time <- do.call(dataprep, dp_in_time)
so_in_time <- synth(dp_in_time)


# 5ï¸âƒ£ gap ê³„ì‚°
gaps_in_time <- dp_in_time$Y1plot - (dp_in_time$Y0plot %*% so_in_time$solution.w)

# 6ï¸âƒ£ ì‹œê°„ ë³€ìˆ˜
week_finalin_time      <- dp_in_time$tag$time.plot
lab_major_finalin_time <- c(1, seq(5, max(week_finalin_time), by = 5))

# 7ï¸âƒ£ ê¶¤ì (Path) í”Œë¡¯
path.plot(
  synth.res    = so_in_time,
  dataprep.res = dp_in_time,
  Ylab = "Weekly traffic",
  Xlab = "Week",
  Legend = c("Treated","Synthetic"),
  Legend.position = "bottomright"
)
abline(v = week_finalin_time, col = "grey90", lty = "dotted")
abline(v = n_pre + 1, lty = 2)
text(n_pre + 1, par("usr")[3] + diff(par("usr")[3:4])*0.05,
     labels = "Final CCC launch", cex=0.75, adj=c(0.5,1), xpd=TRUE)
axis(1, at = lab_major_finalin_time, labels = lab_major_finalin_time, las=1, cex.axis=0.8)

# 8ï¸âƒ£ gap í”Œë¡¯
gaps.plot(
  synth.res    = so_in_time,
  dataprep.res = dp_in_time,
  Ylab = "Gap",
  Xlab = "Week"
)
abline(v = week_finalin_time, col = "grey90", lty = "dotted")
abline(v = n_pre + 1, lty = 2)


# ê¹¨ë—í•œ ë²„ì „
path.plot(synth.res   = so_in_time,
          dataprep.res= dp_in_time,
          Ylab = "Weekly traffic", Xlab = "Week",
          Legend = c("Treated","Synthetic"),
          Legend.position = "bottomright")
abline(v = n_pre + 1, lty = 2)               # ì •ì±…ì„ 

gaps.plot(synth.res   = so_refined,
          dataprep.res= dp_refined,
          Ylab = "Gap", Xlab = "Week")
abline(v = n_pre + 1, lty = 2)


# 9ï¸âƒ£ ì‚¬ì „Â·ì‚¬í›„ RMSPE & Ratio
pre_rmspe_in_time  <- sqrt(mean(gaps_in_time[1:n_pre]^2))
post_rmspe_in_time <- sqrt(mean(gaps_in_time[(n_pre+1):n_all]^2))
ratio_in_time     <- post_rmspe_in_time / pre_rmspe_in_time

att_pct1in_time <- mean(gaps_in_time[(n_pre+1):n_all])      # %-point ATT

baseline_prein_time <- df_scm %>%
  filter(
    unit_id    == treat_id,   # ì²˜ë¦¬ ëŒ€ìƒ ë„ë¡œ ID
    week_index <= n_pre             # ê°œì… ì´ì „ ì£¼(week)ë§Œ
  ) %>%
  summarise(pre_mean = mean(traffic, na.rm = TRUE)) %>%
  pull(pre_mean)

eff_final1in_time <- (att_pct1in_time/baseline_prein_time)*100

cat(sprintf(
  "\nâ–¶ Final RMSPE | Pre = %.3f   Post = %.3f   Ratio = %.3f | ATT = %.3f |ATT ratio =%.3f ",
  pre_rmspe_in_time, post_rmspe_in_time, ratio_in_time, att_pct1in_time, eff_final1in_time
))

goal_v1in_time <- baseline_prein_time*0.19775

cat(sprintf(
  "\nâ–¶ Traffic before treat = %.3f   Expected traffic = %.3f  diff = %.3f",
  baseline_prein_time,  goal_v1in_time, abs(goal_v1in_time-att_pct1in_time)
))


# 11ï¸âƒ£ final ê°€ì¤‘ì¹˜ í…Œì´ë¸”
stab_in_time <- synth.tab(dataprep.res = dp_in_time,
                        synth.res   = so_in_time,
                        round.digit = 10)
weights_final_tbl_in_time <- stab_in_time$tab.w %>%
  arrange(desc(w.weights))
print(weights_final_tbl_in_time, row.names = FALSE)




beep(5)  # ì™„ë£Œ ì•Œë¦¼
```

# â”€â”€â”€ Leave-One-Out Sensitivity â”€â”€â”€

```{r}


# â”€â”€â”€ Leave-One-Out with Error ë¬´ì‹œ â”€â”€â”€

# ê²°ê³¼ë¥¼ ì €ì¥í•  ë²¡í„° ì´ˆê¸°í™”
loo_att <- numeric(length(donor_ids_final))
names(loo_att) <- donor_ids_final

# ì˜ˆ: ì‚¬ì „ ê¸°ê°„ ê¸¸ì´

n_pre <- 51

for (i in seq_along(donor_ids_final)) {
  excluded <- donor_ids_final[i]
  donors_loo <- setdiff(donor_ids_final, excluded)
  
  # dataprep & synth ì‹¤í–‰ ì‹œ ì˜¤ë¥˜ ë¬´ì‹œ
  res <- tryCatch({
    # dataprep íŒŒë¼ë¯¸í„°ì—ì„œ controlsë§Œ êµì²´
    dp_loo <- do.call(dataprep, modifyList(
      dp_params_final,
      list(controls.identifier = donors_loo)
    ))
    so_loo <- synth(dp_loo)
    
    # gap ê³„ì‚° ë° ATT ì‚°ì¶œ
    gaps_loo <- dp_loo$Y1plot - (dp_loo$Y0plot %*% so_loo$solution.w)
    mean(gaps_loo[(n_pre+1):length(gaps_loo)], na.rm = TRUE)
    
  }, error = function(e) {
    # ì˜¤ë¥˜ ë°œìƒ ì‹œ NA ë°˜í™˜
    message(sprintf("Skipped donor %s due to error: %s", excluded, e$message))
    NA
  })
  
  loo_att[i] <- res
}

# ê²°ê³¼ í™•ì¸
print(round(loo_att, 3))

# ì‹œê°í™” (barplot ì˜ˆì‹œ)
barplot(loo_att,
        las = 2,
        main = "Leave-One-Out ATT (with error skip)",
        ylab = "ATT (Post-treatment avg gap)",
        cex.names = 0.8)
abline(h = loo_att[as.character(treat_id)], col = "red", lty = 2)
```




```{r}
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# final p-value ê³„ì‚° ë° ë¶„í¬ í”Œë¡¯
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
library(dplyr)
library(tibble)
library(ggplot2)

# 1ï¸âƒ£ Treatedì˜ Post/Pre RMSPE ë¹„ìœ¨
pre_treated_final  <- sqrt(mean(gaps_final[1:n_pre]^2, na.rm = TRUE))
post_treated_final <- sqrt(mean(gaps_final[(n_pre+1):n_all]^2, na.rm = TRUE))
ratio_treated_final <- post_treated_final / pre_treated_final

# 2ï¸âƒ£ Placeboë“¤ì˜ Post/Pre RMSPE ë¹„ìœ¨
pre_placebo_final  <- sqrt(colMeans(store_final_pb[1:n_pre, , drop=FALSE]^2, na.rm = TRUE))
post_placebo_final <- sqrt(colMeans(store_final_pb[(n_pre+1):n_all, , drop=FALSE]^2, na.rm = TRUE))
ratio_placebo_final <- post_placebo_final / pre_placebo_final

# 3ï¸âƒ£ p-value ê³„ì‚° (placebo ì¤‘ ì²˜ë¦¬êµ° ì´ìƒ ë¹„ìœ¨)
p_value_final <- mean(ratio_placebo_final >= ratio_treated_final, na.rm = TRUE)
cat(sprintf("â–¶ Final p-value = %.3f\n", p_value_final))

# 4ï¸âƒ£ ë¶„í¬ íˆìŠ¤í† ê·¸ë¨ + ì²˜ë¦¬êµ° ë¹„ìœ¨ í‘œì‹œ
df_ratio_final <- tibble(Ratio = ratio_placebo_final)

ggplot(df_ratio_final, aes(x = Ratio)) +
  geom_histogram(binwidth = 0.2, fill = "steelblue", color = "white", alpha = 0.8) +
  geom_vline(xintercept = ratio_treated_final,
             color = "red", linetype = "dashed", size = 1) +
  annotate("text",
           x = ratio_treated_final,
           y = Inf,
           label = paste0("Treated\nRatio=", round(ratio_treated_final, 2)),
           vjust = -0.5, hjust = 1.1,
           color = "red", size = 3) +
  labs(
    title    = "Placebo Post/Pre RMSPE Ratio Distribution",
    subtitle = paste("Final p-value =", round(p_value_final, 3)),
    x        = "Post/Pre RMSPE Ratio",
    y        = "Count"
  ) +
  theme_minimal()
```


```{r}
library(dplyr)
library(ggplot2)

# 1) í”Œë¼ì‹œë³´ ë¹„ìœ¨ ë°ì´í„°í”„ë ˆì„ ìƒì„±
# ratio_placebo_final: named numeric ë²¡í„° (names = unit_id)
df_placebo <- tibble(
  unit_id = as.integer(names(ratio_placebo_final)),
  Ratio   = as.numeric(ratio_placebo_final)
) %>%
  left_join(
    df_scm %>% distinct(unit_id, unit_name),
    by = "unit_id"
  ) %>%
  mutate(
    Label = paste0(unit_name, "-", unit_id),
    Type  = "Placebo"
  )

# 2) ì²˜ë¦¬êµ° ë¹„ìœ¨ í–‰ ì¶”ê°€
df_treated <- tibble(
  unit_id = treat_id_final,
  Ratio   = ratio_treated_final,
  unit_name = df_scm %>% filter(unit_id == treat_id_final) %>% pull(unit_name),
  Label   = paste0(unit_name, "-", unit_id),
  Type    = "Treated"
)

df_dot <- bind_rows(df_placebo, df_treated) %>%
  arrange(Ratio) %>%
  mutate(
    Label = paste0(unit_name, "-", unit_id),
    Type  = if_else(Type == "Treated", "Treated", "Placebo"),
    Label = factor(Label, levels = unique(Label)),   # ì¤‘ë³µ ë ˆë²¨ ì œê±°
    Shape = if_else(Type == "Treated", 15, 17)
  )

ggplot(df_dot, aes(x = Ratio, y = Label)) +
  geom_point(aes(shape = Type), size = 3) +
  scale_shape_manual(values = c(Placebo = 17, Treated = 15), guide = FALSE) +
  labs(
    title    = paste0("Post/Pre RMSPE Ratio (Final SCM) â€” p=", round(p_value_final,3)),
    x        = "Post/Pre RMSPE Ratio",
    y        = NULL
  ) +
  theme_minimal() +
  theme(
    axis.text.y = element_text(size = 6),
    plot.title  = element_text(size = 12, face = "bold", hjust = 0.5)
  )
```

#### ì–‘ì¸¡ê²€ì •
##mscmt?

```{r}
library(MSCMT)
library(dplyr)

# 1. weekë¥¼ Dateë¡œ
df_mscmt <- df_scm %>% mutate(week = as.Date(week))

# 2. listFromLong â€” trafficë§Œ ë‚¨ê¸°ê¸°
msc_list <- listFromLong(
  foo             = as.data.frame(df_mscmt),
  unit.variable   = "unit_id",
  time.variable   = "week",
  exclude.columns = c(
    "routeNM", "linkID", "road",
    "unit_name", "region", "week_index",
    "speed"           # speed ì œê±°
  )
)

# 3. treated / control
treated_unit <- "41"                       # â† í•œ ê°œë§Œ
exclude_ids  <- as.character(1:174)
all_units    <- colnames(msc_list[[1]])
control_ids  <- setdiff(all_units, c(treated_unit, exclude_ids))

# 4. Pre-treatment (2Ã—1)
times.dep <- matrix(
  c("2023-02-06", "2024-01-22"),
  nrow     = 2,
  dimnames = list(c("start","end"), "traffic")
)

# 5. Post-treatment (2Ã—1)
times.pred <- matrix(
  c("2024-01-29", "2024-10-28"),
  nrow     = 2,
  dimnames = list(c("start","end"), "traffic")
)

# 6. í•©ì„±í†µì œëª¨í˜• ì‹¤í–‰
msc <- mscmt(
  data                 = msc_list,
  treatment.identifier = treated_unit,
  controls.identifier  = control_ids,
  times.dep            = times.dep,
  times.pred           = times.pred,
  placebo              = TRUE
)

# 7. trafficì— ëŒ€í•œ ë‹¨ì¸¡(ê°ì†Œ) p-value
p_traffic <- pvalue(
  msc,
  what        = "traffic",
  alternative = "less"
)

print(p_traffic)

```



```{r}

# 3) í•©ì„±í†µì œëª¨í˜• ì‹¤í–‰ (trafficë§Œ)
msc <- mscmt(
  data                 = msc_list,
  treatment.identifier = 41,
  controls.identifier  = control_ids,
  times.dep            = times.dep,
  times.pred           = times.pred,
  placebo              = TRUE
)

# 4) trafficì— ëŒ€í•œ ë‹¨ì¸¡(ê°ì†Œ) p-value ê³„ì‚°
p_traffic <- pvalue(
  msc,
  what        = "traffic",
  alternative = "less"
)

print(p_traffic)
```


```{r}
# 1) ìˆ«ìí˜• ë³´ì¦ + ë‚ ì§œ/ë¬¸ì ì—´ ì œê±°
df_mscmt <- df_scm %>%    # ìœ„ mutate ì½”ë“œ
msc_list <- listFromLong(
  foo             = df_mscmt,
  unit.variable   = "unit_id",
  time.variable   = "week_index",
  exclude.columns = c("routeNM","linkID","road","unit_name","region","week")
)

# 2) treated / control
treated_ids <- as.character(c(41, 42))
exclude_ids <- as.character(1:174)
all_units   <- colnames(msc_list[[1]])
control_ids <- setdiff(all_units, c(treated_ids, exclude_ids))

# 3) times.dep  (start/end ì£¼ ë²ˆí˜¸ëŠ” **ìˆ«ì**)
times.dep <- matrix(c(1, 91), nrow = 2,
                    dimnames = list(c("start","end"), "traffic"))

# 4) times.pred  (ì£¼ 1~51 traffic + speed ë‘ êµ¬ê°„)
traffic_mat <- matrix(rep(1:51, each = 2), nrow = 2)
colnames(traffic_mat) <- rep("traffic", 51)

speed_mat   <- matrix(c(1,25, 26,51), nrow = 2)
colnames(speed_mat)   <- rep("speed", 2)

times.pred  <- cbind(traffic_mat, speed_mat)
rownames(times.pred) <- c("start","end")

# 5) mscmt
msc <- mscmt(
  data                 = msc_list,
  treatment.identifier = treated_ids,
  controls.identifier  = control_ids,
  times.dep            = times.dep,
  times.pred           = times.pred,
  placebo              = TRUE
)

# 6) ë‹¨ì¸¡(ê°ì†Œ) p-ê°’
p_one   <- pvalue(msc, type = "one.sided", alternative = "lower")
p_joint <- pvalue(msc, type = "joint",    alternative = "lower")

p_one
p_joint
```







#========================
#Time Extention

```{r}
library(beepr)
library(Synth)

options(scipen = 999)

donor_ok_ids <- df_scm %>%
  filter(unit_id >= 174) %>%
  distinct(unit_id) %>%  # ê³ ìœ ê°’ë§Œ
  pull(unit_id)   


n_all <- 112
n_pre <- 52

donor_ids_final <- donor_ok_ids 

treat_id    <- 41
predictors_final  <- c("lanes.min","local_length_km","total_length_km",
                       "speed.max","lanes.max","speed.min","local_share")

good_preds_o <- c("lanes.min","local_length_km","total_length_km", "speed.max", "lanes.max", "speed.min", "local_share")

good_preds_new <- c("lanes.max", "speed.max","local_share", "total_length_km")


# 2ï¸âƒ£ jitter ì¶”ê°€ (optional)


# 3ï¸âƒ£ final dataprep íŒŒë¼ë¯¸í„°
dp_extention <- list(
  foo               = as.data.frame(df_scm),
  predictors              = good_preds_new, 
  predictors.op           = "mean",
  special.predictors      = sp_2_all, #, #sp_all_1wk, # sp_2_all,
  dependent               = "traffic",
  unit.variable           = "unit_id",
  unit.names.variable     = "unit_name",
  time.variable           = "week_index",
  treatment.identifier    = treat_id,
  controls.identifier     = donor_ids_final,
  time.predictors.prior   = 1:n_pre,
  time.optimize.ssr       = 1:n_pre,
  time.plot               = 1:112
)

# 4ï¸âƒ£ final dataprep & synth
dp_extention<- do.call(dataprep, dp_extention)
so_extention  <- synth(dp_extention)


# 5ï¸âƒ£ gap ê³„ì‚°
gaps_extention  <- dp_extention $Y1plot - (dp_extention $Y0plot %*% so_extention $solution.w)

# 6ï¸âƒ£ ì‹œê°„ ë³€ìˆ˜
week_extention       <- dp_extention $tag$time.plot
lab_major_extention  <- c(1, seq(5, max(week_extention ), by = 5))

# 7ï¸âƒ£ ê¶¤ì (Path) í”Œë¡¯
path.plot(
  synth.res    = so_extention ,
  dataprep.res = dp_extention ,
  Ylab = "Weekly traffic",
  Xlab = "Week",
  Legend = c("Treated","Synthetic"),
  Legend.position = "bottomright"
)
abline(v = week_extention , col = "grey90", lty = "dotted")
abline(v = n_pre + 1, lty = 2)
text(n_pre + 1, par("usr")[3] + diff(par("usr")[3:4])*0.05,
     labels = "extention  CCC launch", cex=0.75, adj=c(0.5,1), xpd=TRUE)
axis(1, at = lab_major_extention , labels = lab_major_extention , las=1, cex.axis=0.8)

# 8ï¸âƒ£ gap í”Œë¡¯
gaps.plot(
  synth.res    = so_extention ,
  dataprep.res = dp_extention ,
  Ylab = "Gap",
  Xlab = "Week"
)
abline(v = week_extention , col = "grey90", lty = "dotted")
abline(v = n_pre + 1, lty = 2)

# 9ï¸âƒ£ ì‚¬ì „Â·ì‚¬í›„ RMSPE & Ratio
pre_rmspe_extention   <- sqrt(mean(gaps_extention [1:n_pre]^2))
post_rmspe_extention  <- sqrt(mean(gaps_extention [(n_pre+1):n_all]^2))
ratio_extention       <- post_rmspe_extention  / pre_rmspe_extention 

att_pct1_extention <- mean(gaps_extention [(n_pre+1):n_all])      # %-point ATT

baseline_extention <- df_scm %>%
  filter(
    unit_id    == treat_id,   # ì²˜ë¦¬ ëŒ€ìƒ ë„ë¡œ ID
    week_index <= n_pre             # ê°œì… ì´ì „ ì£¼(week)ë§Œ
  ) %>%
  summarise(pre_extention = mean(traffic, na.rm = TRUE)) %>%
  pull(pre_extention)

eff_extention1 <- (att_pct1_extention / baseline_extention) * 100

# ì¶œë ¥í•  ë•Œë„ ê°™ì€ ì´ë¦„ ì‚¬ìš©
cat(sprintf(
  "\nâ–¶ extention  RMSPE | Pre = %.3f   Post = %.3f   Ratio = %.3f | ATT = %.3f | ATT ratio = %.3f ",
  pre_rmspe_extention,
  post_rmspe_extention,
  ratio_extention,
  att_pct1_extention,
  eff_extention1    # â† ì—¬ê¸°
))

goal_v1_extention <- baseline_extention*0.19775

cat(sprintf(
  "\nâ–¶ Traffic before treat = %.3f   Expected traffic = %.3f  diff = %.3f",
  baseline_extention,  goal_v1_extention, abs(goal_v1_extention-att_pct1_extention)
))


# 11ï¸âƒ£  ê°€ì¤‘ì¹˜ í…Œì´ë¸”
stab_extention <- synth.tab(
  dataprep.res = dp_extention,
  synth.res    = so_extention,    # â† ì—¬ê¸°
  round.digit  = 10
)
weights_extention_tbl <- stab_extention$tab.w %>%
  arrange(desc(w.weights))
print(weights_extention_tbl, row.names = FALSE)




beep(5)  # ì™„ë£Œ ì•Œë¦¼
```



```{r}
# 1ï¸âƒ£ SCtools ë¡œë“œ
library(SCtools)
# dp_final, so_final ì€ ì•ì„œ ë§Œë“  ìµœì¢… dataprep & synth ê²°ê³¼ì…ë‹ˆë‹¤.

# 2ï¸âƒ£ placebo í•©ì„±ëŒ€ì¡°êµ° ìƒì„±
#    - Sigf.ipop: ipop ìµœì í™” ì •ë°€ë„ (ê¸°ë³¸ 5)
#    - strategy: "sequential" ë˜ëŠ” ë³‘ë ¬ "multiprocess"
placebos_extention <- generate.placebos(
  dataprep.out = dp_extention,
  synth.out    = so_extention,
  Sigf.ipop    = 5,
  strategy     = "sequential"
)  
# â†’ ë°˜í™˜ê°’(placebos)ì€ tdf ê°ì²´ë¡œ, ì›ë³¸ ì²˜ë¦¬êµ°ê³¼ ê° placeboì˜ Y & Y_synth ì‹œê³„ì—´, 
#    ì‚¬ì „ MSPE(mspe.placs) ë“±ì„ ë‹´ê³  ìˆìŠµë‹ˆë‹¤  

# 3ï¸âƒ£ placebo ë¶„í¬ í”Œë¡¯
#    - plot_placebos(): ëª¨ë“  placebo gap + ì²˜ë¦¬êµ° gapì„ ì¼ê´„ ì‹œê°í™”
plot_placebos(placebos_extention)  

# 4ï¸âƒ£ MSPE test (p-value ê³„ì‚°)
test_out <- mspe.test(placebos_extention)
cat("â–¶ Final p-value =", round(test_out$p.val, 3), "\n")  

beep(5)

```


```{r}
# â¶ MSPE test: pre-MSPE > 5Ã— ì¸ í”Œë¼ì‹œë³´ ì œì™¸ í›„ p-ê°’ ê³„ì‚°
test_out_extention <- mspe.test(placebos_extention,
                      discard.extreme = TRUE,   # â† í•„í„° ì¼œê¸°
                      mspe.limit      = 5)      # â† 5 ë°° ê¸°ì¤€
cat("â–¶ filtered p-value =", round(test_out_extention$p.val, 3), "\n")

# â· MSPE ratio í”Œë¡¯(ì /íˆìŠ¤í† ê·¸ë¨)ë„ ë™ì¼ ì˜µì…˜
mspe.plot(placebos_extention,
          discard.extreme = TRUE,
          mspe.limit      = 5)

# â¸ gap ê¶¤ì  í”Œë¡¯(plot_placebos) ì—­ì‹œ ë™ì¼ ì¸ì ì‚¬ìš© ê°€ëŠ¥
plot_placebos(placebos_extention,
              discard.extreme = TRUE,
              mspe.limit      = 5)
```

####extention ë‹¨ì¸¡ê²€ì •




```{r}
library(dplyr)

## 1ï¸âƒ£ ë©”íƒ€ ì •ë³´
meta_df_extention <- placebos_extention$names.and.numbers        # unit.numbers, unit.names

## 2ï¸âƒ£ pre-MSPE ë²¡í„° ë§Œë“¤ê¸°  (ì´ë¦„ = unit.numbers, ê°’ = pre-MSPE)
mspe_vec_extention <- setNames(
  placebos_extention$mspe.placs[[1]],                  # data-frame â†’ ë²¡í„°
  meta_df_extention$unit.numbers                       # ë™ì¼í•œ í–‰ìˆœì„œ í™œìš©
)

## 3ï¸âƒ£ ì²˜ë¦¬ ë„ë¡œ pre-MSPE
mspe_treat_extention <- as.numeric(placebos_extention$loss.v)     # scalar

## 4ï¸âƒ£ 5 ë°° ì»·ì˜¤í”„ ì´ˆê³¼ í”Œë¼ì‹œë³´ ID
bad_ids_extention <- names(mspe_vec_extention)[ mspe_vec_extention > 5 * mspe_treat_extention ] |>
           as.numeric()                      # ìˆ«ìí˜•ìœ¼ë¡œ

## 5ï¸âƒ£ ì œì™¸ëœ ìœ ë‹›(ë„ë¡œ) ëª©ë¡
excluded_units_extention <- meta_df_extention %>%
  filter(unit.numbers %in% bad_ids_extention) %>% print() %>% pull(unit.numbers)

print(excluded_units_extention)
```


```{r}
# 3) ID ë²¡í„° ë½‘ê¸° ------------------------------
treated_id_extention  <- placebos_extention$tr                    # ì‹¤ì œ treated ë²ˆí˜¸
control_ids_extention <- c(placebos_extention[["names.and.numbers"]][["unit.numbers"]])

## 0) convenience variables ---------------------------------
treated_id_extention  <- placebos_extention$tr
t1_row_extention      <- placebos_extention$t1          # first post-period row index

## 1) reshape ------------------------------------------------

# (2) wide â†’ long ë³€í™˜ -------------------------------------------
placebos_long_extention <- placebos_extention$df 

plb_long_extention<- placebos_long_extention %>%                 # 91 Ã— 95 (ì˜ˆì‹œ)
  rename(week_index = "year") %>%
  mutate(week_index = as.integer(week_index)) %>% 
  pivot_longer(                             # unitë³„ë¡œ ì„¸ë¡œë¡œ ë…¹ì´ê¸°
    -week_index,
    names_to  = "unit_id",
    values_to = "value"
  ) %>% 
  mutate(
    unit_id = as.character(unit_id),          # ë¬¸ì â†’ ì •ìˆ˜
    post    = week_index >= t1_row          # ì‚¬í›„ êµ¬ê°„ í”Œë˜ê·¸
  )

```
```{r}
gap_long_extention <- plb_long_extention %>% 
  mutate(
    type    = if_else(str_starts(unit_id, "synthetic\\."), "synthetic", "obs"),
    unit_id = str_remove(unit_id, "^synthetic\\.")   # ìˆ«ìë§Œ ë‚¨ê¹€
  ) %>% 
  pivot_wider(names_from = type, values_from = value) %>% 
  mutate(
    gap = obs - synthetic      # (ìŒìˆ˜ â†’ êµí†µëŸ‰ ê°ì†Œ)
  ) %>%
  filter(!unit_id %in% excluded_units)
```


```{r}
treated_id <- "Y1"                 # ë˜ëŠ” 41 ë“±
control_ids_extention <- gap_long_extention %>% 
  filter(!str_detect(unit_id, "[^0-9]")) %>%   # ìˆ«ìë§Œ
  distinct(unit_id) %>% 
  pull(unit_id) %>% 
  setdiff(treated_id)

# â‘  treated ë‹¨ì¸¡ í†µê³„ëŸ‰ (ê°ì†Œë©´ ìŒìˆ˜)
stat_treat_extention <- gap_long_extention %>% 
  filter(unit_id == treated_id, post) %>% 
  summarise(stat = sum(gap, na.rm = TRUE)) %>% 
  pull(stat)

# â‘¡ ì»¨íŠ¸ë¡¤(placebo) í†µê³„ëŸ‰
placebo_stats_extention <- gap_long_extention %>% 
  filter(unit_id %in% control_ids, post) %>% 
  group_by(unit_id) %>% 
  summarise(stat = sum(gap, na.rm = TRUE)) %>% 
  pull(stat)

# â‘¢ â€˜ê°ì†Œâ€™ ë°©í–¥ ë‹¨ì¸¡ p-value
p_one_extention <- (1 + sum(placebo_stats_extention <= stat_treat_extention)) /
         (1 + length(placebo_stats_extention))


p_one_extention
```



```{r}
# 1) í•„ìš”í•œ íŒ¨í‚¤ì§€ ë¡œë“œ
library(ggplot2)

# 2) ë°ì´í„°í”„ë ˆì„ìœ¼ë¡œ ë³€í™˜
df_plot <- data.frame(
  stat = placebo_stats_extention
)

# 3) íˆìŠ¤í† ê·¸ë¨ + ì²˜ë¦¬êµ¬ê°„ í†µê³„ëŸ‰ í‘œì‹œ
p <- ggplot(df_plot, aes(x = stat)) +
  geom_histogram(binwidth = diff(range(df_plot$stat)) / 30,
                 fill = "grey80", color = "white") +
  geom_vline(xintercept = stat_treat_extention,
             color = "red", size = 1) +
  labs(
    title = "Placebo í†µê³„ëŸ‰ ë¶„í¬ (ë‹¨ì¸¡ ê²€ì • â€“ ê°ì†Œ ë°©í–¥)",
    subtitle = paste0("ë‹¨ì¸¡ p-value = ",
                      round(p_one_extention, 3)),
    x = "ì‚¬í›„ gap í•©ê³„(statistic)",
    y = "í”Œë¼ì‹œë³´ ê°œìˆ˜"
  ) +
  theme_minimal()

# 4) ì¶œë ¥
print(p)
```



#=======================

```{r}
pl_treat_id <- c("Y1", "synthetic.Y1")

# (1) ë¶€í˜¸ ìœ ì§€ í†µê³„ëŸ‰ = Î£ gap  (ê°ì†Œë©´ ìŒìˆ˜)
t_y1 <- plb_long %>%
  filter(unit_id == c("Y1"), post) %>%
  group_by(unit_id) %>%
  summarise(stat = sum(value, na.rm = TRUE)) %>%
  pull(stat)

t_s <- plb_long %>%
  filter(unit_id == c("synthetic.Y1"), post) %>%
  group_by(unit_id) %>%
  summarise(stat = sum(value, na.rm = TRUE)) %>%
  pull(stat)

t_y1 - t_s

```
```{r}
# â‘  treated ë‹¨ì¸¡ í†µê³„ëŸ‰ (ê°ì†Œë©´ ìŒìˆ˜)
stat_treat <- plb_long %>% 
  filter(unit_id == pl_treat_id, post) %>% 
  summarise(stat = sum(value, na.rm = TRUE)) %>% 
  pull(stat)

stat_treat
```


```{r}
# 3ï¸âƒ£ placebo ê°­ í”Œë¡¯ (gap over time)
plot_placebos(
  placebos,
  discard.extreme = TRUE,   # ì»· ì ìš©
  mspe.limit      = 5       # treated MSPE Ã— 5
)

# 4ï¸âƒ£ p-value ê³„ì‚° (MSPE test)
test_out <- mspe.test(
  placebos,
  discard.extreme = TRUE,
  mspe.limit      = 5
)
cat("â–¶ Final p-value =", round(test_out$p.val, 3), "\n")

# 5ï¸âƒ£ MSPE ratio íˆìŠ¤í† ê·¸ë¨
mspe.plot(
  placebos,
  discard.extreme = TRUE,
  mspe.limit      = 5,
  plot.hist       = TRUE    # í•„ìš” ì‹œ FALSE: dotplot
  
)


# 5ï¸âƒ£ MSPE ratio ë¶„í¬ í”Œë¡¯
#    - mspe.plot(): post/pre-period MSPE ratio ë¥¼ íˆìŠ¤í† ê·¸ë¨ìœ¼ë¡œ
mspe.plot(placebos, discard.extreme = TRUE, mspe.limit = 5)
```
